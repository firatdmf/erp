# Generated by custom migration
import django.contrib.postgres.fields
from django.db import migrations, models


def convert_to_arrays(apps, schema_editor):
    """Convert existing email and phone strings to single-item arrays"""
    Contact = apps.get_model('crm', 'Contact')
    db_alias = schema_editor.connection.alias
    
    for contact in Contact.objects.using(db_alias).all():
        # Convert email string to array
        if contact.email:
            contact.email_temp = [contact.email]
        else:
            contact.email_temp = []
        
        # Convert phone string to array
        if contact.phone:
            contact.phone_temp = [contact.phone]
        else:
            contact.phone_temp = []
        
        contact.save()


def reverse_to_strings(apps, schema_editor):
    """Reverse: Convert arrays back to strings (take first item)"""
    Contact = apps.get_model('crm', 'Contact')
    db_alias = schema_editor.connection.alias
    
    for contact in Contact.objects.using(db_alias).all():
        # Convert email array to string
        if contact.email_temp:
            contact.email = contact.email_temp[0]
        else:
            contact.email = ''
        
        # Convert phone array to string
        if contact.phone_temp:
            contact.phone = contact.phone_temp[0]
        else:
            contact.phone = ''
        
        contact.save()


class Migration(migrations.Migration):

    dependencies = [
        ('crm', '0016_convert_email_phone_to_arrays'),
    ]

    operations = [
        # Step 1: Add temporary array fields
        migrations.AddField(
            model_name='contact',
            name='email_temp',
            field=django.contrib.postgres.fields.ArrayField(
                base_field=models.EmailField(max_length=254),
                blank=True,
                default=list,
                size=None,
                verbose_name='Email addresses'
            ),
        ),
        migrations.AddField(
            model_name='contact',
            name='phone_temp',
            field=django.contrib.postgres.fields.ArrayField(
                base_field=models.CharField(max_length=20),
                blank=True,
                default=list,
                size=None,
                verbose_name='Phone numbers'
            ),
        ),
        
        # Step 2: Migrate data from old fields to temp fields
        migrations.RunPython(convert_to_arrays, reverse_to_strings),
        
        # Step 3: Remove old fields
        migrations.RemoveField(
            model_name='contact',
            name='email',
        ),
        migrations.RemoveField(
            model_name='contact',
            name='phone',
        ),
        
        # Step 4: Rename temp fields to original names
        migrations.RenameField(
            model_name='contact',
            old_name='email_temp',
            new_name='email',
        ),
        migrations.RenameField(
            model_name='contact',
            old_name='phone_temp',
            new_name='phone',
        ),
    ]
