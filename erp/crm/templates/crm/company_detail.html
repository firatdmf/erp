{% extends 'base.html' %}
{% block content %}
  {% load todo_filters %}
  {% load crm_tags %}
  {% load static %}

  {% comment %}Below is to use unique css for each file as in this case here{% endcomment %}
  {% block css %}
    <link rel="stylesheet" href="{% static 'crm/css/company_detail.css' %}" />
  {% endblock %}
  {% block js %}
    <script src="{% static 'crm/js/detailPages.js' %}" defer></script>
  {% endblock %}
<div class="company-detail-container">
  <!-- Header Section -->
  <div class="detail-header">
    <div class="detail-header-left">
      <a href="{% url 'crm:company_list' %}" class="back-link">
        <i class="fa fa-arrow-left"></i> Back to Companies
      </a>
      <div class="company-title-section">
        <div class="company-icon">
          <i class="fa fa-building"></i>
        </div>
        <div>
          <h1 class="company-title">{{ company.name|capfirst }}</h1>
          {% if company.group %}
            <span class="company-group-badge">{{ company.group.name }}</span>
          {% endif %}
          <span class="status-badge status-{{ company.status }}">{{ company.get_status_display }}</span>
        </div>
      </div>
    </div>
    <div class="detail-header-right">
      <a href="{% url 'crm:update_company' company.id %}?next_url={{ request.path|urlencode }}" class="btn-action btn-action-secondary">
        <i class="fa fa-edit"></i> Edit
      </a>
      <form action="{% url 'crm:delete_company' company.id %}" method="post" style="display: inline; margin: 0; vertical-align: top;" onsubmit="return confirm('Are you sure you want to delete this company?');">
        {% csrf_token %}
        <button type="submit" class="btn-action btn-action-danger" style="display: inline-flex;">
          <i class="fa fa-trash"></i> Delete
        </button>
      </form>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="detail-grid">
    <!-- Company Information Card -->
    <div class="detail-card">
      <div class="card-header">
        <h2><i class="fa fa-info-circle"></i> Company Information</h2>
      </div>
      <div class="info-grid">
        {% if company.email %}
          <div class="info-item">
            <span class="info-label">Email{{ company.email|length|pluralize:"s" }}</span>
            <span class="info-value">
              {% for email in company.email %}
                <a href="mailto:{{ email }}" style="display: block; margin-bottom: 4px;">{{ email }}</a>
              {% endfor %}
            </span>
          </div>
        {% endif %}
        {% if company.phone %}
          <div class="info-item">
            <span class="info-label">Phone{{ company.phone|length|pluralize:"s" }}</span>
            <span class="info-value">
              {% for phone in company.phone %}
                <span style="display: block; margin-bottom: 4px;">{{ phone }}</span>
              {% endfor %}
            </span>
          </div>
        {% endif %}
        {% if company.website %}
          <div class="info-item">
            <span class="info-label">Website</span>
            <span class="info-value"><a href="{{ company.website }}" target="_blank">{{ company.website }}</a></span>
          </div>
        {% endif %}
        {% if company.address %}
          <div class="info-item">
            <span class="info-label">Address</span>
            <span class="info-value">{{ company.address }}</span>
          </div>
        {% endif %}
        {% if company.country %}
          <div class="info-item">
            <span class="info-label">Country</span>
            <span class="info-value">{{ company.country }}</span>
          </div>
        {% endif %}
        {% if company.backgroundInfo %}
          <div class="info-item info-full-width">
            <span class="info-label">Background</span>
            <span class="info-value">{{ company.backgroundInfo }}</span>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Email Campaign Card (Only for Prospects) -->
    {% if company.status == 'prospect' %}
    <div class="detail-card" id="email-campaign-card">
      <div class="card-header">
        <h2><i class="fa fa-envelope"></i> Email Follow-up Campaign</h2>
      </div>
      {% if has_campaign %}
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">
              <input type="checkbox" 
                     id="email-campaign-toggle" 
                     {% if email_campaign.status == 'active' %}checked{% endif %}
                     hx-post="{% url 'crm:toggle_email_campaign' company.pk %}"
                     hx-vals='{% if email_campaign.status == "active" %}{"enable": "false"}{% else %}{"enable": "true"}{% endif %}'
                     hx-target="#email-campaign-card"
                     hx-swap="innerHTML"
                     style="margin-right: 8px; cursor: pointer;">
              Enable Follow-up Emails
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">Campaign Status</span>
            <span class="info-value">
              {% if email_campaign.status == 'active' %}
                <span style="color: #10b981; font-weight: 600;">✓ Active</span>
              {% elif email_campaign.status == 'paused' %}
                <span style="color: #f59e0b; font-weight: 600;">⏸ Paused</span>
              {% elif email_campaign.status == 'completed' %}
                <span style="color: #6b7280; font-weight: 600;">✓ Completed</span>
              {% else %}
                <span style="color: #ef4444; font-weight: 600;">⊘ Stopped</span>
              {% endif %}
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">Emails Progress</span>
            <span class="info-value" style="font-weight: 600; font-size: 1.1em;">
              {{ email_campaign.emails_sent }} / 6 emails sent
            </span>
          </div>
          {% if email_campaign.next_email_scheduled_at and email_campaign.status == 'active' and email_campaign.emails_sent < 6 %}
          <div class="info-item">
            <span class="info-label">Next Email</span>
            <span class="info-value">
              Email #{{ email_campaign.emails_sent|add:1 }} - {{ email_campaign.next_email_scheduled_at|date:"M d, Y H:i" }}
            </span>
          </div>
          {% endif %}
          <div class="info-item">
            <span class="info-label">Campaign Started</span>
            <span class="info-value">{{ email_campaign.created_at|date:"M d, Y H:i" }}</span>
          </div>
        </div>
      {% else %}
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">
              <input type="checkbox" 
                     id="email-campaign-toggle" 
                     hx-post="{% url 'crm:toggle_email_campaign' company.pk %}"
                     hx-vals='{"enable": "true"}'
                     hx-target="#email-campaign-card"
                     hx-swap="innerHTML"
                     style="margin-right: 8px; cursor: pointer;">
              Enable Follow-up Emails
            </span>
          </div>
        </div>
        <p class="empty-state" style="margin: 16px 0 0 0;">
          <i class="fa fa-info-circle"></i> Check the box above to start automated email follow-ups for this prospect.
        </p>
      {% endif %}
    </div>
    {% endif %}

    <!-- Contacts Card -->
    <div class="detail-card" id="contactsCard">
      <div class="card-header">
        <h2><i class="fa fa-users"></i> Contacts</h2>
      </div>
      <div id="contactsList">
        {% if contacts %}
          <div class="contacts-list">
            {% for contact in contacts %}
              <div class="contact-item" id="contact-item-{{ contact.id }}">
                <div class="contact-info">
                  <i class="fa fa-user contact-icon"></i>
                  <div>
                    <a href="{% url 'crm:contact_detail' contact.id %}" class="contact-name">{{ contact.name }}</a>
                    {% if contact.job_title %}<span class="contact-job">{{ contact.job_title }}</span>{% endif %}
                  </div>
                </div>
                <button type="button" class="btn-icon-minimal" title="Remove contact" onclick="confirmRemoveContact({{ contact.id }}, '{{ contact.name|escapejs }}')">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="empty-state">No contacts found for this company.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Attach an Item Section -->
  <div class="detail-card attach-card">
    <div class="card-header">
      <h2><i class="fa fa-paperclip"></i> Attach an item</h2>
    </div>
    <div class="attach-options">
      <button type="button" class="attach-option-btn" onclick="toggleAttachSection('note')">
        <i class="fa fa-file-text"></i>
        <span>Note</span>
      </button>
      <button type="button" class="attach-option-btn" onclick="toggleAttachSection('task')">
        <i class="fa fa-check-circle"></i>
        <span>Task</span>
      </button>
      <button type="button" class="attach-option-btn" onclick="toggleAttachSection('contact')">
        <i class="fa fa-user"></i>
        <span>Contact</span>
      </button>
    </div>
    
    <!-- Note Attach Section -->
    <div id="attachNoteSection" class="attach-form-section" style="display: none;">
      <div class="attach-form-header">
        <span><i class="fa fa-file-text"></i> Add a note</span>
        <button type="button" class="btn-text" onclick="toggleAttachSection('note')">
          Cancel
        </button>
      </div>
      <form hx-post="{% url 'crm:company_detail' company.id %}?action=add_note" 
            hx-swap="none"
            class="attach-form"
            hx-on::after-request="if(event.detail.successful) { this.reset(); toggleAttachSection('note'); htmx.ajax('GET', '/crm/company/{{ company.id }}/notes_partial/', {target: '#notesSection', swap: 'outerHTML'}); }">
        {% csrf_token %}
        {{ note_form.as_p }}
        <div class="form-actions">
          <button type="submit" class="btn-action btn-action-primary">Add Note</button>
        </div>
      </form>
    </div>
    
    <!-- Task Attach Section -->
    <div id="attachTaskSection" class="attach-form-section" style="display: none;">
      <div class="attach-form-header">
        <span><i class="fa fa-check-circle"></i> Add a task</span>
        <button type="button" class="btn-text" onclick="toggleAttachSection('task')">
          Cancel
        </button>
      </div>
      <form hx-post="{% url 'crm:company_detail' company.id %}?action=add_task" 
            hx-target=".tasks-list"
            hx-swap="innerHTML"
            class="attach-form"
            hx-on::after-request="if(event.detail.successful) { this.reset(); toggleAttachSection('task'); }">
        {% csrf_token %}
        {{ task_form.as_p }}
        <div class="form-actions">
          <button type="submit" class="btn-action btn-action-primary">Add Task</button>
        </div>
      </form>
    </div>
    
    <!-- Contact Attach Section -->
    <div id="attachContactSection" class="attach-form-section" style="display: none;">
      <div class="attach-form-header">
        <span><i class="fa fa-user"></i> Link existing contact</span>
        <button type="button" class="btn-text" onclick="toggleAttachSection('contact')">
          Cancel
        </button>
      </div>
      <div class="attach-form">
        <input type="text" 
               id="contactSearchInput"
               hx-get="{% url 'crm:search_contacts_only' %}" 
               hx-target="#contactSearchResults" 
               hx-trigger="keyup changed delay:500ms" 
               name="search_term" 
               placeholder="Search and add existing contact..." 
               class="form-input" 
               autocomplete="off" />
        <div id="contactSearchResults" class="searchResults" style="max-height: 300px; overflow-y: auto; margin-top: 10px;"></div>
      </div>
    </div>
  </div>
  
  <!-- Tasks List -->
  <div class="detail-card">
    <div class="card-header">
      <h2><i class="fa fa-check-circle"></i> Tasks</h2>
    </div>
    <div id="tasksList" class="tasks-list">
      {% for task in tasks|dictsortreversed:'due_date' %}
        {% if not task.completed %}
          <div class="task-item" id="task-{{ task.id }}">
            <div class="task-content" id="task-content-{{ task.id }}">
              <h3 class="task-name">{{ task.name }}</h3>
              {% if task.description %}
                <p class="task-description">{{ task.description }}</p>
              {% endif %}
              <div class="task-meta">
                <span class="task-due">Due: {{ task.due_date|date:"M d, Y" }}</span>
                {% if task.due_date|days_since %}
                  <span class="task-overdue">{{ task.due_date|days_since }}</span>
                {% endif %}
                {% if task.member %}
                  <span class="task-member"><i class="fa fa-user"></i> {{ task.member }}</span>
                {% endif %}
              </div>
            </div>
            <div class="task-actions">
              <button type="button" class="btn-icon-minimal" title="Complete" onclick="confirmDelete('complete_task', {{ task.id }})">
                <i class="fa fa-check"></i>
              </button>
              <button type="button" class="btn-icon-minimal" title="Edit" onclick="editTask({{ task.id }}, '{{ task.name|escapejs }}', '{{ task.description|escapejs }}', '{{ task.due_date|date:"Y-m-d" }}')">
                <i class="fa fa-edit"></i>
              </button>
              <button type="button" class="btn-icon-minimal" title="Delete" onclick="confirmDelete('delete_task', {{ task.id }})">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>
        {% endif %}
      {% empty %}
        <p class="empty-state">No tasks available.</p>
      {% endfor %}
    </div>
  </div>
  <!-- Notes History -->
  <div id="notesSection">
    {% history_component company=company contact=None note_form=note_form csrf_token=csrf_token current_url=request.path %}
  </div>
  
  <script>
    function toggleAttachSection(type) {
      const sections = {
        'note': 'attachNoteSection',
        'task': 'attachTaskSection',
        'contact': 'attachContactSection'
      };
      
      const sectionId = sections[type];
      const section = document.getElementById(sectionId);
      
      // Hide all sections first
      Object.values(sections).forEach(id => {
        const el = document.getElementById(id);
        if (el && el !== section) {
          el.style.display = 'none';
        }
      });
      
      // Toggle current section
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    // Handle contact search result clicks
    document.addEventListener('click', function(e) {
      if (e.target.closest('.contact-result-item')) {
        const item = e.target.closest('.contact-result-item');
        const contactId = item.dataset.contactId;
        const companyId = '{{ company.id }}';
        
        // Add contact to company via HTMX
        fetch(`/crm/add_contact_to_company/${companyId}/${contactId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.text())
        .then(html => {
          // Update contacts list
          document.getElementById('contactsList').innerHTML = html;
          // Clear search
          document.getElementById('contactSearchInput').value = '';
          document.getElementById('contactSearchResults').innerHTML = '';
          // Close attach section
          toggleAttachSection('contact');
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to add contact');
        });
      }
    });

    // Store original HTML for cancel
    const taskOriginalHTML = {};
    const noteOriginalHTML = {};
    
    // Confirm remove contact from company
    function confirmRemoveContact(contactId, contactName) {
      const companyId = '{{ company.id }}';
      const csrf = '{{ csrf_token }}';
      
      // Create overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10000;animation:fadeIn 0.15s;';
      
      const dialog = document.createElement('div');
      dialog.style.cssText = 'background:#fff;border-radius:12px;max-width:420px;width:90%;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:slideIn 0.2s;';
      dialog.innerHTML = `
        <div style="display:flex;gap:12px;align-items:start;margin-bottom:16px;">
          <div style="width:40px;height:40px;border-radius:50%;background:#fee2e2;display:flex;align-items:center;justify-content:center;color:#dc2626;flex-shrink:0;">
            <i class="fa fa-user-times"></i>
          </div>
          <div>
            <div style="font-weight:700;font-size:16px;color:#111827;margin-bottom:4px;">Remove Contact?</div>
            <div style="font-size:14px;color:#6b7280;">Remove <strong>${contactName}</strong> from this company?</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button id="cancelBtn" style="padding:10px 20px;border-radius:8px;background:#f3f4f6;color:#374151;border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.15s;">
            Cancel
          </button>
          <button id="confirmBtn" style="padding:10px 20px;border-radius:8px;background:#ef4444;color:#fff;border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.15s;">
            Remove
          </button>
        </div>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      // Add hover effects
      const cancelBtn = dialog.querySelector('#cancelBtn');
      const confirmBtn = dialog.querySelector('#confirmBtn');
      
      cancelBtn.onmouseover = () => cancelBtn.style.background = '#e5e7eb';
      cancelBtn.onmouseout = () => cancelBtn.style.background = '#f3f4f6';
      confirmBtn.onmouseover = () => confirmBtn.style.opacity = '0.9';
      confirmBtn.onmouseout = () => confirmBtn.style.opacity = '1';
      
      // Cancel action
      cancelBtn.onclick = () => overlay.remove();
      
      // Confirm action
      confirmBtn.onclick = () => {
        fetch(`/crm/delete_company_from_contact/${contactId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrf,
            'X-Requested-With': 'XMLHttpRequest'
          }
        }).then(() => {
          overlay.remove();
          // Remove contact item with animation
          const contactEl = document.getElementById(`contact-item-${contactId}`);
          if (contactEl) {
            contactEl.style.transition = 'all 0.3s ease';
            contactEl.style.opacity = '0';
            contactEl.style.transform = 'translateX(-20px)';
            setTimeout(() => {
              contactEl.remove();
              // Check if no contacts left
              const contactsList = document.querySelector('#contactsList .contacts-list');
              if (contactsList && contactsList.children.length === 0) {
                document.getElementById('contactsList').innerHTML = '<p class="empty-state">No contacts found for this company.</p>';
              }
            }, 300);
          }
        }).catch(() => {
          overlay.remove();
          alert('Failed to remove contact');
        });
      };
    }
    
    // Inline task editing
    function editTask(taskId, name, description, dueDate) {
      const contentDiv = document.getElementById(`task-content-${taskId}`);
      const csrf = '{{ csrf_token }}';
      
      // Store original HTML
      taskOriginalHTML[taskId] = contentDiv.innerHTML;
      
      contentDiv.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:0.75rem;">
          <div>
            <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:0.25rem;">Task Name</label>
            <input type="text" id="edit-task-name-${taskId}" value="${name}" style="width:100%;padding:0.5rem;border:2px solid #3b82f6;border-radius:6px;font-size:0.875rem;font-weight:600;" />
          </div>
          <div>
            <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:0.25rem;">Description (optional)</label>
            <textarea id="edit-task-desc-${taskId}" style="width:100%;min-height:60px;padding:0.5rem;border:1px solid #cbd5e1;border-radius:6px;font-size:0.8125rem;resize:vertical;">${description || ''}</textarea>
          </div>
          <div>
            <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:0.25rem;">Due Date</label>
            <input type="date" id="edit-task-date-${taskId}" value="${dueDate}" style="padding:0.5rem;border:1px solid #cbd5e1;border-radius:6px;font-size:0.875rem;" />
          </div>
          <div style="display:flex;gap:0.5rem;">
            <button type="button" onclick="saveTask(${taskId})" style="padding:0.5rem 1rem;background:#22c55e;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.8rem;">
              <i class="fa fa-check"></i> Save
            </button>
            <button type="button" onclick="cancelTaskEdit(${taskId})" style="padding:0.5rem 1rem;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.8rem;">
              <i class="fa fa-times"></i> Cancel
            </button>
          </div>
        </div>
      `;
      
      document.getElementById(`edit-task-name-${taskId}`).focus();
    }
    
    function cancelTaskEdit(taskId) {
      if (taskOriginalHTML[taskId]) {
        document.getElementById(`task-content-${taskId}`).innerHTML = taskOriginalHTML[taskId];
        delete taskOriginalHTML[taskId];
      }
    }
    
    function saveTask(taskId) {
      const csrf = '{{ csrf_token }}';
      const name = document.getElementById(`edit-task-name-${taskId}`).value;
      const description = document.getElementById(`edit-task-desc-${taskId}`).value;
      const dueDate = document.getElementById(`edit-task-date-${taskId}`).value;
      
      if (!name.trim()) {
        alert('Task name cannot be empty');
        return;
      }
      
      if (!dueDate) {
        alert('Due date is required');
        return;
      }
      
      fetch(`/todo/tasks/${taskId}/update_ajax/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrf,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `name=${encodeURIComponent(name)}&description=${encodeURIComponent(description)}&due_date=${dueDate}`
      }).then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update the task content
          document.getElementById(`task-content-${taskId}`).innerHTML = `
            <h3 class="task-name">${data.name}</h3>
            ${data.description ? `<p class="task-description">${data.description}</p>` : ''}
            <div class="task-meta">
              <span class="task-due">Due: ${data.due_date_display}</span>
              ${data.overdue_badge || ''}
            </div>
          `;
        } else {
          alert('Failed to save task: ' + (data.error || 'Unknown error'));
        }
      }).catch(err => {
        alert('Failed to save task');
        console.error(err);
      });
    }

    // Inline note editing
    function editNote(noteId, currentContent) {
      const contentDiv = document.getElementById(`note-content-${noteId}`);
      const companyId = '{{ company.id }}';
      const csrf = '{{ csrf_token }}';
      
      // Store original HTML
      noteOriginalHTML[noteId] = contentDiv.innerHTML;
      
      contentDiv.innerHTML = `
        <div class="note-meta">
          <span class="note-date" style="color:#64748b;font-size:0.75rem;font-weight:500;margin-bottom:0.5rem;display:block;">Editing...</span>
        </div>
        <textarea id="edit-textarea-${noteId}" style="width:100%;min-height:80px;padding:0.5rem;border:2px solid #3b82f6;border-radius:6px;font-size:0.875rem;font-family:inherit;resize:vertical;">${currentContent}</textarea>
        <div style="display:flex;gap:0.5rem;margin-top:0.5rem;">
          <button type="button" onclick="saveNote(${noteId})" style="padding:0.5rem 1rem;background:#22c55e;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.8rem;">
            <i class="fa fa-check"></i> Save
          </button>
          <button type="button" onclick="cancelEdit(${noteId})" style="padding:0.5rem 1rem;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.8rem;">
            <i class="fa fa-times"></i> Cancel
          </button>
        </div>
      `;
      
      // Focus textarea
      document.getElementById(`edit-textarea-${noteId}`).focus();
    }
    
    function cancelEdit(noteId) {
      if (noteOriginalHTML[noteId]) {
        document.getElementById(`note-content-${noteId}`).innerHTML = noteOriginalHTML[noteId];
        delete noteOriginalHTML[noteId];
      }
    }
    
    function saveNote(noteId) {
      const companyId = '{{ company.id }}';
      const csrf = '{{ csrf_token }}';
      const newContent = document.getElementById(`edit-textarea-${noteId}`).value;
      
      if (!newContent.trim()) {
        alert('Note content cannot be empty');
        return;
      }
      
      // Save via fetch
      fetch(`/crm/notes/${noteId}/update_ajax/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrf,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `content=${encodeURIComponent(newContent)}`
      }).then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update the content
          document.getElementById(`note-content-${noteId}`).innerHTML = `
            <div class="note-meta">
              <span class="note-date" style="color:#64748b;font-size:0.75rem;font-weight:500;margin-bottom:0.5rem;display:block;">${data.date}</span>
            </div>
            <p class="note-text" style="margin:0;font-size:0.875rem;color:#1e293b;line-height:1.5;word-break:break-word;">${data.content}</p>
          `;
        } else {
          alert('Failed to save note');
        }
      });
    }

    // Custom confirm dialog for delete/complete actions
    function confirmDelete(action, id) {
      const companyId = '{{ company.id }}';
      const csrf = '{{ csrf_token }}';
      
      // Determine action text and icon
      let actionText = 'Delete';
      let questionText = 'Are you sure?';
      let iconClass = 'fa-trash';
      let iconBg = '#fee2e2';
      let iconColor = '#dc2626';
      let buttonBg = '#ef4444';
      
      if (action === 'complete_task') {
        actionText = 'Complete';
        questionText = 'Mark as complete?';
        iconClass = 'fa-check';
        iconBg = '#dcfce7';
        iconColor = '#16a34a';
        buttonBg = '#22c55e';
      }
      
      // Create overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10000;animation:fadeIn 0.15s;';
      
      const dialog = document.createElement('div');
      dialog.style.cssText = 'background:#fff;border-radius:12px;max-width:420px;width:90%;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:slideIn 0.2s;';
      dialog.innerHTML = `
        <div style="display:flex;gap:12px;align-items:start;margin-bottom:16px;">
          <div style="width:40px;height:40px;border-radius:50%;background:${iconBg};display:flex;align-items:center;justify-content:center;color:${iconColor};flex-shrink:0;">
            <i class="fa ${iconClass}"></i>
          </div>
          <div>
            <div style="font-weight:700;font-size:16px;color:#111827;margin-bottom:4px;">${questionText}</div>
            <div style="font-size:14px;color:#6b7280;">This action cannot be undone.</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button id="cancelBtn" style="padding:10px 20px;border-radius:8px;background:#f3f4f6;color:#374151;border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.15s;">
            Cancel
          </button>
          <button id="confirmBtn" style="padding:10px 20px;border-radius:8px;background:${buttonBg};color:#fff;border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.15s;">
            ${actionText}
          </button>
        </div>
      `;
      
      // Add CSS animations
      if (!document.getElementById('modal-animations')) {
        const style = document.createElement('style');
        style.id = 'modal-animations';
        style.textContent = `
          @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
          @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        `;
        document.head.appendChild(style);
      }
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      // Add hover effects
      const cancelBtn = dialog.querySelector('#cancelBtn');
      const confirmBtn = dialog.querySelector('#confirmBtn');
      
      cancelBtn.onmouseover = () => cancelBtn.style.background = '#e5e7eb';
      cancelBtn.onmouseout = () => cancelBtn.style.background = '#f3f4f6';
      confirmBtn.onmouseover = () => confirmBtn.style.opacity = '0.9';
      confirmBtn.onmouseout = () => confirmBtn.style.opacity = '1';
      
      // Cancel action
      cancelBtn.onclick = () => overlay.remove();
      
      // Confirm action
      confirmBtn.onclick = () => {
        let url = '';
        let body = '';
        
        if (action === 'delete_note') {
          url = `/crm/notes/${id}/delete_note/`;
          body = `note_id=${id}`;
        } else if (action === 'delete_task') {
          url = `/todo/tasks/${id}/delete_task`;
          body = `company_id=${companyId}`;
        } else if (action === 'complete_task') {
          url = `/todo/tasks/${id}/complete_task`;
          body = `task_id=${id}`;
        }
        
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrf,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body
        }).then(response => {
          if (action === 'complete_task') {
            return response.json();
          }
          return { success: true };
        }).then(data => {
          overlay.remove();
          // Handle different actions
          if (action === 'delete_note') {
            // Remove note item from DOM with smooth animation
            const noteEl = document.getElementById(`note-${id}`);
            if (noteEl) {
              noteEl.style.transition = 'all 0.3s ease';
              noteEl.style.opacity = '0';
              noteEl.style.transform = 'translateX(-20px)';
              setTimeout(() => noteEl.remove(), 300);
            }
          } else if (action === 'delete_task') {
            // Remove task item from DOM with smooth animation
            const taskEl = document.getElementById(`task-${id}`);
            if (taskEl) {
              taskEl.style.transition = 'all 0.3s ease';
              taskEl.style.opacity = '0';
              taskEl.style.transform = 'translateX(-20px)';
              setTimeout(() => {
                taskEl.remove();
                // Check if no tasks left, show empty state
                const tasksList = document.getElementById('tasksList');
                if (tasksList && tasksList.children.length === 0) {
                  tasksList.innerHTML = '<p class="empty-state">No tasks available.</p>';
                }
              }, 300);
            }
          } else if (action === 'complete_task' && data.success) {
            // Remove task from task list
            const taskEl = document.getElementById(`task-${id}`);
            if (taskEl) {
              taskEl.style.transition = 'all 0.3s ease';
              taskEl.style.opacity = '0';
              taskEl.style.transform = 'translateX(-20px)';
              setTimeout(() => {
                taskEl.remove();
                // Check if no tasks left, show empty state
                const tasksList = document.getElementById('tasksList');
                if (tasksList && tasksList.children.length === 0) {
                  tasksList.innerHTML = '<p class="empty-state">No tasks available.</p>';
                }
              }, 300);
            }
            
            // Add completed task to history (at the top of notes list)
            const notesList = document.querySelector('.notes-list');
            if (notesList && data.task) {
              const completedTaskHTML = `
                <div class="note-item completed-task-item" style="opacity:0;transform:translateY(-10px);transition:all 0.3s ease;">
                  <div class="note-content">
                    <div class="note-meta">
                      <span class="note-date">${data.task.completed_at}</span>
                      <span class="note-badge"><i class="fa fa-check-circle"></i> Completed</span>
                    </div>
                    <p class="note-text"><strong>${data.task.name}</strong></p>
                    ${data.task.description ? `<p class="note-description">${data.task.description}</p>` : ''}
                  </div>
                </div>
              `;
              
              // Insert at the top (first child)
              notesList.insertAdjacentHTML('afterbegin', completedTaskHTML);
              
              // Trigger animation
              setTimeout(() => {
                const newItem = notesList.firstElementChild;
                if (newItem) {
                  newItem.style.opacity = '1';
                  newItem.style.transform = 'translateY(0)';
                }
              }, 10);
            }
          }
        }).catch(() => overlay.remove());
      };
    }
  </script>
</div>
{% endblock %}
