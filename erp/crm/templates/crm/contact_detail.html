{% extends 'base.html' %}
{% block content %}
  {% load todo_filters %}
  {% load todo_tags %}
  {% load crm_tags %}
  {% load static %}
  
  {% comment %}Below is to use unique css for each file{% endcomment %}
  {% block css %}
    <link rel="stylesheet" href="{% static 'crm/css/company_detail.css' %}" />
  {% endblock %}
  {% block js %}
    <script src="{% static 'crm/js/detailPages.js' %}" defer></script>
  {% endblock %}
<div class="company-detail-container">
  <!-- Header Section -->
  <div class="detail-header">
    <div class="detail-header-left">
      <a href="{% url 'crm:contact_list' %}" class="back-link">
        <i class="fa fa-arrow-left"></i> Back to Contacts
      </a>
      <div class="company-title-section">
        <div class="company-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          <i class="fa fa-user"></i>
        </div>
        <div>
          <h1 class="company-title">{{ contact.name|capfirst }}</h1>
          {% if contact.job_title %}
            <span class="company-group-badge" style="background: #10b98120; color: #059669; border-color: #10b981;">{{ contact.job_title }}</span>
          {% endif %}
          {% if contact.company %}
            <span class="company-group-badge">
              <i class="fa fa-building"></i> {{ contact.company.name }}
            </span>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="detail-header-right">
      <a href="{% url 'crm:update_contact' contact.id %}?next_url={{ request.path|urlencode }}" class="btn-action btn-action-secondary">
        <i class="fa fa-edit"></i> Edit
      </a>
      <form action="{% url 'crm:delete_contact' contact.id %}" method="post" style="display: inline; margin: 0; vertical-align: top;" onsubmit="return confirm('Are you sure you want to delete this contact?');">
        {% csrf_token %}
        <button type="submit" class="btn-action btn-action-danger" style="display: inline-flex;">
          <i class="fa fa-trash"></i> Delete
        </button>
      </form>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="detail-grid">
    <!-- Contact Information Card -->
    <div class="detail-card">
      <div class="card-header">
        <h2><i class="fa fa-info-circle"></i> Contact Information</h2>
      </div>
      <div class="info-grid">
        {% if contact.email %}
          <div class="info-item">
            <span class="info-label">Email{{ contact.email|length|pluralize:"s" }}</span>
            <span class="info-value">
              {% for email in contact.email %}
                <a href="mailto:{{ email }}" style="display: block; margin-bottom: 4px;">{{ email }}</a>
              {% endfor %}
            </span>
          </div>
        {% endif %}
        {% if contact.phone %}
          <div class="info-item">
            <span class="info-label">Phone{{ contact.phone|length|pluralize:"s" }}</span>
            <span class="info-value">
              {% for phone in contact.phone %}
                <span style="display: block; margin-bottom: 4px;">{{ phone }}</span>
              {% endfor %}
            </span>
          </div>
        {% endif %}
        {% if contact.job_title %}
          <div class="info-item">
            <span class="info-label">Job Title</span>
            <span class="info-value">{{ contact.job_title }}</span>
          </div>
        {% endif %}
        {% if contact.company %}
          <div class="info-item">
            <span class="info-label">Company</span>
            <span class="info-value">
              <a href="{% url 'crm:company_detail' contact.company.id %}" style="color: #3b82f6; text-decoration: none;">
                <i class="fa fa-building"></i> {{ contact.company.name }}
              </a>
            </span>
          </div>
        {% endif %}
        {% if contact.address %}
          <div class="info-item info-full-width">
            <span class="info-label">Address</span>
            <span class="info-value">{{ contact.address }}</span>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Attach an Item Section -->
  <div class="detail-card attach-card">
    <div class="card-header">
      <h2><i class="fa fa-paperclip"></i> Attach an item</h2>
    </div>
    <div class="attach-options">
      <button type="button" class="attach-option-btn" onclick="toggleAttachSection('note')">
        <i class="fa fa-file-text"></i>
        <span>Note</span>
      </button>
      <button type="button" class="attach-option-btn" onclick="toggleAttachSection('task')">
        <i class="fa fa-check-circle"></i>
        <span>Task</span>
      </button>
    </div>
    
    <!-- Note Attach Section -->
    <div id="attachNoteSection" class="attach-form-section" style="display: none;">
      <div class="attach-form-header">
        <span><i class="fa fa-file-text"></i> Add a note</span>
        <button type="button" class="btn-text" onclick="toggleAttachSection('note')">
          Cancel
        </button>
      </div>
      <form hx-post="{% url 'crm:contact_detail' contact.id %}?action=add_note" 
            hx-swap="none"
            class="attach-form"
            hx-on::after-request="if(event.detail.successful) { this.reset(); toggleAttachSection('note'); htmx.ajax('GET', '/crm/contact/{{ contact.id }}/notes_partial/', {target: '#notesSection', swap: 'outerHTML'}); }">
        {% csrf_token %}
        {{ note_form.as_p }}
        <div class="form-actions">
          <button type="submit" class="btn-action btn-action-primary">Add Note</button>
        </div>
      </form>
    </div>
    
    <!-- Task Attach Section -->
    <div id="attachTaskSection" class="attach-form-section" style="display: none;">
      <div class="attach-form-header">
        <span><i class="fa fa-check-circle"></i> Add a task</span>
        <button type="button" class="btn-text" onclick="toggleAttachSection('task')">
          Cancel
        </button>
      </div>
      <form hx-post="{% url 'crm:contact_detail' contact.id %}?action=add_task" 
            hx-target="#tasksList"
            hx-swap="innerHTML"
            class="attach-form"
            hx-on::after-request="if(event.detail.successful) { this.reset(); toggleAttachSection('task'); }">
        {% csrf_token %}
        {{ task_form.as_p }}
        <div class="form-actions">
          <button type="submit" class="btn-action btn-action-primary">Add Task</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Tasks List -->
  <div class="detail-card">
    <div class="card-header">
      <h2><i class="fa fa-check-circle"></i> Tasks</h2>
    </div>
    <div id="tasksList" class="tasks-list">
      {% for task in tasks|dictsortreversed:'due_date' %}
        {% if not task.completed %}
          <div class="task-item" id="task-{{ task.id }}">
            <div class="task-content" id="task-content-{{ task.id }}">
              <h3 class="task-name">{{ task.name }}</h3>
              {% if task.description %}
                <p class="task-description">{{ task.description }}</p>
              {% endif %}
              <div class="task-meta">
                <span class="task-due">Due: {{ task.due_date|date:"M d, Y" }}</span>
                {% if task.due_date|days_since %}
                  <span class="task-overdue">{{ task.due_date|days_since }}</span>
                {% endif %}
                {% if task.member %}
                  <span class="task-member"><i class="fa fa-user"></i> {{ task.member }}</span>
                {% endif %}
              </div>
            </div>
            <div class="task-actions">
              <button type="button" class="btn-icon-minimal" title="Complete" onclick="confirmDelete('complete_task', {{ task.id }})">
                <i class="fa fa-check"></i>
              </button>
              <button type="button" class="btn-icon-minimal" title="Edit" onclick="editTask({{ task.id }}, '{{ task.name|escapejs }}', '{{ task.description|escapejs }}', '{{ task.due_date|date:"Y-m-d" }}')">
                <i class="fa fa-edit"></i>
              </button>
              <button type="button" class="btn-icon-minimal" title="Delete" onclick="confirmDelete('delete_task', {{ task.id }})">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>
        {% endif %}
      {% empty %}
        <p class="empty-state">No tasks available.</p>
      {% endfor %}
    </div>
  </div>
  
  <!-- Notes History -->
  <div id="notesSection">
    {% history_component company=None contact=contact csrf_token=csrf_token note_form=note_form current_url=request.path %}
  </div>
  
  <script>
    // Store original HTML for cancel
    const taskOriginalHTML = {};
    const noteOriginalHTML = {};
    
    // Inline task editing
    function editTask(taskId, name, description, dueDate) {
      const contentDiv = document.getElementById(`task-content-${taskId}`);
      const csrf = '{{ csrf_token }}';
      
      taskOriginalHTML[taskId] = contentDiv.innerHTML;
      
      contentDiv.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:0.75rem;">
          <div>
            <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:0.25rem;">Task Name</label>
            <input type="text" id="edit-task-name-${taskId}" style="width:100%;padding:0.5rem;border:2px solid #3b82f6;border-radius:6px;font-size:0.875rem;font-weight:600;" />
          </div>
          <div>
            <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:0.25rem;">Description (optional)</label>
            <textarea id="edit-task-desc-${taskId}" style="width:100%;min-height:60px;padding:0.5rem;border:1px solid #cbd5e1;border-radius:6px;font-size:0.8125rem;resize:vertical;">${description || ''}</textarea>
          </div>
          <div>
            <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:0.25rem;">Due Date</label>
            <input type="date" id="edit-task-date-${taskId}" value="${dueDate}" style="padding:0.5rem;border:1px solid #cbd5e1;border-radius:6px;font-size:0.875rem;" />
          </div>
          <div style="display:flex;gap:0.5rem;">
            <button type="button" onclick="saveTask(${taskId})" style="padding:0.5rem 1rem;background:#22c55e;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.8rem;">
              <i class="fa fa-check"></i> Save
            </button>
            <button type="button" onclick="cancelTaskEdit(${taskId})" style="padding:0.5rem 1rem;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.8rem;">
              <i class="fa fa-times"></i> Cancel
            </button>
          </div>
        </div>
      `;
      
      const nameInput = document.getElementById(`edit-task-name-${taskId}`);
      nameInput.value = name;
      nameInput.focus();
      nameInput.setSelectionRange(nameInput.value.length, nameInput.value.length);
    }
    
    function cancelTaskEdit(taskId) {
      if (taskOriginalHTML[taskId]) {
        document.getElementById(`task-content-${taskId}`).innerHTML = taskOriginalHTML[taskId];
        delete taskOriginalHTML[taskId];
      }
    }
    
    function saveTask(taskId) {
      const csrf = '{{ csrf_token }}';
      const name = document.getElementById(`edit-task-name-${taskId}`).value;
      const description = document.getElementById(`edit-task-desc-${taskId}`).value;
      const dueDate = document.getElementById(`edit-task-date-${taskId}`).value;
      
      if (!name.trim()) {
        alert('Task name cannot be empty');
        return;
      }
      
      if (!dueDate) {
        alert('Due date is required');
        return;
      }
      
      fetch(`/todo/tasks/${taskId}/update_ajax/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrf,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `name=${encodeURIComponent(name)}&description=${encodeURIComponent(description)}&due_date=${dueDate}`
      }).then(response => response.json())
      .then(data => {
        if (data.success && data.task) {
          document.getElementById(`task-content-${taskId}`).innerHTML = `
            <h3 class="task-name">${data.task.name}</h3>
            ${data.task.description ? `<p class="task-description">${data.task.description}</p>` : ''}
            <div class="task-meta">
              <span class="task-due">Due: ${data.task.due_date}</span>
              ${data.task.overdue_badge || ''}
            </div>
          `;
        } else {
          alert('Failed to save task: ' + (data.error || 'Unknown error'));
        }
      }).catch(err => {
        alert('Failed to save task');
        console.error(err);
      });
    }

    // Inline note editing
    function editNote(noteId, currentContent) {
      const contentDiv = document.getElementById(`note-content-${noteId}`);
      const csrf = '{{ csrf_token }}';
      
      noteOriginalHTML[noteId] = contentDiv.innerHTML;
      
      contentDiv.innerHTML = `
        <div class="note-meta">
          <span class="note-date" style="color:#64748b;font-size:0.75rem;font-weight:500;margin-bottom:0.5rem;display:block;">Editing...</span>
        </div>
        <textarea id="edit-textarea-${noteId}" style="width:100%;min-height:80px;padding:0.5rem;border:2px solid #3b82f6;border-radius:6px;font-size:0.875rem;font-family:inherit;resize:vertical;">${currentContent}</textarea>
        <div style="display:flex;gap:0.5rem;margin-top:0.5rem;">
          <button type="button" onclick="saveNote(${noteId})" style="padding:0.5rem 1rem;background:#22c55e;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.8rem;">
            <i class="fa fa-check"></i> Save
          </button>
          <button type="button" onclick="cancelEdit(${noteId})" style="padding:0.5rem 1rem;background:#ef4444;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.8rem;">
            <i class="fa fa-times"></i> Cancel
          </button>
        </div>
      `;
      
      document.getElementById(`edit-textarea-${noteId}`).focus();
    }
    
    function cancelEdit(noteId) {
      if (noteOriginalHTML[noteId]) {
        document.getElementById(`note-content-${noteId}`).innerHTML = noteOriginalHTML[noteId];
        delete noteOriginalHTML[noteId];
      }
    }
    
    function saveNote(noteId) {
      const csrf = '{{ csrf_token }}';
      const newContent = document.getElementById(`edit-textarea-${noteId}`).value;
      
      if (!newContent.trim()) {
        alert('Note content cannot be empty');
        return;
      }
      
      fetch(`/crm/notes/${noteId}/update_ajax/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrf,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `content=${encodeURIComponent(newContent)}`
      }).then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById(`note-content-${noteId}`).innerHTML = `
            <div class="note-meta">
              <span class="note-date" style="color:#64748b;font-size:0.75rem;font-weight:500;margin-bottom:0.5rem;display:block;">${data.date}</span>
            </div>
            <p class="note-text" style="margin:0;font-size:0.875rem;color:#1e293b;line-height:1.5;word-break:break-word;">${data.content}</p>
          `;
        } else {
          alert('Failed to save note');
        }
      });
    }

    function toggleAttachSection(type) {
      const sections = {
        'note': 'attachNoteSection',
        'task': 'attachTaskSection'
      };
      
      const sectionId = sections[type];
      const section = document.getElementById(sectionId);
      
      // Hide all sections first
      Object.values(sections).forEach(id => {
        const el = document.getElementById(id);
        if (el && el !== section) {
          el.style.display = 'none';
        }
      });
      
      // Toggle current section
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Custom confirm dialog for delete/complete actions
    function confirmDelete(action, id) {
      const contactId = '{{ contact.id }}';
      const csrf = '{{ csrf_token }}';
      
      // Determine action text and icon
      let actionText = 'Delete';
      let questionText = 'Are you sure?';
      let iconClass = 'fa-trash';
      let iconBg = '#fee2e2';
      let iconColor = '#dc2626';
      let buttonBg = '#ef4444';
      
      if (action === 'complete_task') {
        actionText = 'Complete';
        questionText = 'Mark as complete?';
        iconClass = 'fa-check';
        iconBg = '#dcfce7';
        iconColor = '#16a34a';
        buttonBg = '#22c55e';
      }
      
      // Create overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10000;animation:fadeIn 0.15s;';
      
      const dialog = document.createElement('div');
      dialog.style.cssText = 'background:#fff;border-radius:12px;max-width:420px;width:90%;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:slideIn 0.2s;';
      dialog.innerHTML = `
        <div style="display:flex;gap:12px;align-items:start;margin-bottom:16px;">
          <div style="width:40px;height:40px;border-radius:50%;background:${iconBg};display:flex;align-items:center;justify-content:center;color:${iconColor};flex-shrink:0;">
            <i class="fa ${iconClass}"></i>
          </div>
          <div>
            <div style="font-weight:700;font-size:16px;color:#111827;margin-bottom:4px;">${questionText}</div>
            <div style="font-size:14px;color:#6b7280;">This action cannot be undone.</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button id="cancelBtn" style="padding:10px 20px;border-radius:8px;background:#f3f4f6;color:#374151;border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.15s;">
            Cancel
          </button>
          <button id="confirmBtn" style="padding:10px 20px;border-radius:8px;background:${buttonBg};color:#fff;border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.15s;">
            ${actionText}
          </button>
        </div>
      `;
      
      // Add CSS animations
      if (!document.getElementById('modal-animations')) {
        const style = document.createElement('style');
        style.id = 'modal-animations';
        style.textContent = `
          @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
          @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        `;
        document.head.appendChild(style);
      }
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      // Add hover effects
      const cancelBtn = dialog.querySelector('#cancelBtn');
      const confirmBtn = dialog.querySelector('#confirmBtn');
      
      cancelBtn.onmouseover = () => cancelBtn.style.background = '#e5e7eb';
      cancelBtn.onmouseout = () => cancelBtn.style.background = '#f3f4f6';
      confirmBtn.onmouseover = () => confirmBtn.style.opacity = '0.9';
      confirmBtn.onmouseout = () => confirmBtn.style.opacity = '1';
      
      // Cancel action
      cancelBtn.onclick = () => overlay.remove();
      
      // Confirm action
      confirmBtn.onclick = () => {
        let url = '';
        let body = '';
        
        if (action === 'delete_note') {
          url = `/crm/notes/${id}/delete_note/`;
          body = `note_id=${id}`;
        } else if (action === 'delete_task') {
          url = `/todo/tasks/${id}/delete_task`;
          body = `contact_id=${contactId}`;
        } else if (action === 'complete_task') {
          url = `/todo/tasks/${id}/complete_task`;
          body = `task_id=${id}`;
        }
        
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrf,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body
        }).then(response => {
          if (action === 'complete_task') {
            return response.json();
          }
          return { success: true };
        }).then(data => {
          overlay.remove();
          // Handle different actions
          if (action === 'delete_note') {
            // Remove note item from DOM with smooth animation
            const noteEl = document.getElementById(`note-${id}`);
            if (noteEl) {
              noteEl.style.transition = 'all 0.3s ease';
              noteEl.style.opacity = '0';
              noteEl.style.transform = 'translateX(-20px)';
              setTimeout(() => noteEl.remove(), 300);
            }
          } else if (action === 'delete_task') {
            // Remove task item from DOM with smooth animation
            const taskEl = document.getElementById(`task-${id}`);
            if (taskEl) {
              taskEl.style.transition = 'all 0.3s ease';
              taskEl.style.opacity = '0';
              taskEl.style.transform = 'translateX(-20px)';
              setTimeout(() => taskEl.remove(), 300);
            }
          } else if (action === 'complete_task' && data.success) {
            // Remove task from task list
            const taskEl = document.getElementById(`task-${id}`);
            if (taskEl) {
              taskEl.style.transition = 'all 0.3s ease';
              taskEl.style.opacity = '0';
              taskEl.style.transform = 'translateX(-20px)';
              setTimeout(() => taskEl.remove(), 300);
            }
            
            // Add completed task to history (at the top of notes list)
            const notesList = document.querySelector('.notes-list');
            if (notesList && data.task) {
              const completedTaskHTML = `
                <div class="note-item completed-task-item" style="opacity:0;transform:translateY(-10px);transition:all 0.3s ease;">
                  <div class="note-content">
                    <div class="note-meta">
                      <span class="note-date">${data.task.completed_at}</span>
                      <span class="note-badge"><i class="fa fa-check-circle"></i> Completed</span>
                    </div>
                    <p class="note-text"><strong>${data.task.name}</strong></p>
                    ${data.task.description ? `<p class="note-description">${data.task.description}</p>` : ''}
                  </div>
                </div>
              `;
              
              // Insert at the top (first child)
              notesList.insertAdjacentHTML('afterbegin', completedTaskHTML);
              
              // Trigger animation
              setTimeout(() => {
                const newItem = notesList.firstElementChild;
                if (newItem) {
                  newItem.style.opacity = '1';
                  newItem.style.transform = 'translateY(0)';
                }
              }, 10);
            }
          }
        }).catch(() => overlay.remove());
      };
    }
  </script>
</div>
{% endblock %}
