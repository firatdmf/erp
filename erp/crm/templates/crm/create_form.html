{% extends 'base.html' %}
{% block content %}
  {% load static %}
  {% block css %}
    <link rel="stylesheet" href="{% static 'crm/css/create_form.css' %}" />
  {% endblock %}
  <div id="CreateFormPage">
    <p>
      <a href="{% url 'crm:index' %}"><--- Go to CRM home page</a>
    </p>
    <h1>Create {{ model_type }}</h1>
    {% comment %} {% if model_type == 'contact' %}
      <label for="company_name">Company Name</label>
      <input type="text" id="company_name" name="company_name" autocomplete="off" hx-get="{% url 'crm:company_search' %}" hx-trigger="keyup changed delay:300ms" hx-target="#company-suggestions" hx-params="*" />
      <div id="company-suggestions"></div>
    {% endif %} {% endcomment %}
    <form method="post">
      {% csrf_token %}
      {% comment %} {{ form.as_p }} {# Render each form field as a paragraph #} {% endcomment %}
      {% for field in form %}
        {% if field.name == 'company_suggestions' %}
          <div id="company-suggestions"></div>
        {% elif field.name == 'contact_id' %}
          {{ field }}
          {% if model_type == 'company' %}
          <div class="contact-selector-container">
            <label>Attach Contact</label>
            <div class="contact-selector-wrapper">
              <div class="contact-search-box">
                <input 
                  type="text" 
                  id="contact_search_input" 
                  placeholder="Search contacts..."
                  autocomplete="off"
                />
                <button type="button" class="add-contact-btn" id="add_new_contact_btn" title="Add new contact">
                  <i class="fa fa-plus"></i>
                </button>
              </div>
              <div id="contact-search-results" class="contact-results"></div>
              <div id="selected-contact-display" class="selected-contact"></div>
            </div>
          </div>
          {% endif %}
        {% elif field.name == 'send_followup_emails' %}
          <div class="email-option-container">
            <div class="checkbox-wrapper">
              {{ field }}
              <label for="{{ field.id_for_label }}" class="checkbox-label">
                <span class="checkbox-title">{{ field.label }}</span>
                <span class="checkbox-description">{{ field.help_text }}</span>
              </label>
            </div>
          </div>
        {% else %}
          <p>
            {{ field.label_tag }}<br />
            {{ field }}
            {% if field.help_text %}
              <small>{{ field.help_text }}</small>
            {% endif %}
          </p>
          {% for error in field.errors %}
            <div class="error">{{ error }}</div>
          {% endfor %}
        {% endif %}
      {% endfor %}
      <button type="submit" id="submit-btn" class="submit-btn">
        <span class="btn-text">Create {{ model_type|title }}</span>
        <span class="btn-spinner" style="display: none;">
          <svg class="spinner" viewBox="0 0 50 50">
            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
          </svg>
          Creating...
        </span>
      </button>
    </form>
  </div>

  <!-- Toast Notification -->
  <div id="toast-notification" class="toast-notification">
    <div class="toast-content">
      <i class="fa fa-check-circle toast-icon"></i>
      <span class="toast-message"></span>
    </div>
  </div>

  <style>
  .contact-selector-container {
    margin: 1.5rem 0;
    padding: 1.25rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }

  .contact-selector-container label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
  }

  .contact-search-box {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  #contact_search_input {
    flex: 1;
    padding: 0.625rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.9375rem;
    transition: all 0.2s ease;
  }

  #contact_search_input:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
  }

  .add-contact-btn {
    width: 40px;
    height: 40px;
    background: #4f46e5;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.2s ease;
  }

  .add-contact-btn:hover {
    background: #4338ca;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
  }

  .contact-results {
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    display: none;
  }

  .contact-results.active {
    display: block;
  }

  .contact-result-item {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    transition: background 0.15s ease;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .contact-result-item:last-child {
    border-bottom: none;
  }

  .contact-result-item:hover {
    background: #f9fafb;
  }

  .contact-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
    flex-shrink: 0;
  }

  .contact-info {
    flex: 1;
    min-width: 0;
  }

  .contact-name {
    font-weight: 600;
    color: #111827;
    font-size: 0.9375rem;
  }

  .contact-details {
    font-size: 0.8125rem;
    color: #6b7280;
    margin-top: 0.125rem;
  }

  .selected-contact {
    margin-top: 0.75rem;
    padding: 1rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    display: none;
  }

  .selected-contact.active {
    display: flex;
    align-items: center;
    gap: 0.875rem;
  }

  .selected-contact-info {
    flex: 1;
  }

  .remove-contact-btn {
    padding: 0.5rem 0.75rem;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8125rem;
    transition: background 0.2s ease;
  }

  .remove-contact-btn:hover {
    background: #dc2626;
  }

  .no-results {
    padding: 1.5rem;
    text-align: center;
    color: #9ca3af;
    font-size: 0.875rem;
  }

  /* Email Option Styling */
  .email-option-container {
    margin: 1.5rem 0;
    padding: 1.25rem;
    background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
    border: 2px solid #667eea;
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .email-option-container:hover {
    border-color: #764ba2;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
  }

  .checkbox-wrapper {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }

  .checkbox-wrapper input[type="checkbox"] {
    width: 22px;
    height: 22px;
    margin-top: 2px;
    cursor: pointer;
    accent-color: #667eea;
    flex-shrink: 0;
  }

  .checkbox-label {
    flex: 1;
    cursor: pointer;
  }

  .checkbox-title {
    display: block;
    font-weight: 600;
    color: #374151;
    font-size: 1rem;
    margin-bottom: 0.375rem;
  }

  .checkbox-description {
    display: block;
    font-size: 0.875rem;
    color: #6b7280;
    line-height: 1.5;
  }

  /* Submit Button with Spinner */
  .submit-btn {
    position: relative;
    padding: 0.875rem 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 180px;
    box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
  }

  .submit-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
  }

  .submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .btn-spinner {
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
  }

  .spinner {
    animation: rotate 2s linear infinite;
    width: 20px;
    height: 20px;
  }

  .spinner .path {
    stroke: white;
    stroke-linecap: round;
    animation: dash 1.5s ease-in-out infinite;
  }

  @keyframes rotate {
    100% {
      transform: rotate(360deg);
    }
  }

  @keyframes dash {
    0% {
      stroke-dasharray: 1, 150;
      stroke-dashoffset: 0;
    }
    50% {
      stroke-dasharray: 90, 150;
      stroke-dashoffset: -35;
    }
    100% {
      stroke-dasharray: 90, 150;
      stroke-dashoffset: -124;
    }
  }

  /* Toast Notification */
  .toast-notification {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 0.875rem;
    transform: translateX(400px);
    transition: transform 0.3s ease;
    z-index: 9999;
    border-left: 4px solid #10b981;
    min-width: 300px;
  }

  .toast-notification.show {
    transform: translateX(0);
  }

  .toast-content {
    display: flex;
    align-items: center;
    gap: 0.875rem;
  }

  .toast-icon {
    color: #10b981;
    font-size: 1.5rem;
  }

  .toast-message {
    color: #374151;
    font-weight: 500;
    font-size: 0.9375rem;
  }
  </style>

  <script>
  {% if model_type == 'company' %}
  let searchTimeout = null;
  const searchInput = document.getElementById('contact_search_input');
  const searchResults = document.getElementById('contact-search-results');
  const selectedDisplay = document.getElementById('selected-contact-display');
  const contactIdInput = document.getElementById('selected_contact_id');
  const addNewBtn = document.getElementById('add_new_contact_btn');

  // Search contacts
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();

    if (query.length < 2) {
      searchResults.classList.remove('active');
      return;
    }

    searchTimeout = setTimeout(() => {
      fetch(`/crm/search_contacts_only/?search_term=${encodeURIComponent(query)}`)
        .then(response => response.text())
        .then(html => {
          searchResults.innerHTML = html;
          searchResults.classList.add('active');
          
          // Add click handlers to results
          document.querySelectorAll('.contact-result-item').forEach(item => {
            item.addEventListener('click', function() {
              selectContact(
                this.dataset.contactId,
                this.dataset.contactName,
                this.dataset.contactEmail,
                this.dataset.contactCompany
              );
            });
          });
        })
        .catch(error => {
          console.error('Error searching contacts:', error);
        });
    }, 300);
  });

  // Select contact
  function selectContact(id, name, email, company) {
    contactIdInput.value = id;
    searchInput.value = '';
    searchResults.classList.remove('active');

    const initial = name.charAt(0).toUpperCase();
    selectedDisplay.innerHTML = `
      <div class="contact-avatar">${initial}</div>
      <div class="selected-contact-info">
        <div class="contact-name">${name}</div>
        <div class="contact-details">${email}${company ? ' â€¢ ' + company : ''}</div>
      </div>
      <button type="button" class="remove-contact-btn" onclick="removeContact()">
        <i class="fa fa-times"></i> Remove
      </button>
    `;
    selectedDisplay.classList.add('active');
  }

  // Remove selected contact
  function removeContact() {
    contactIdInput.value = '';
    selectedDisplay.classList.remove('active');
    selectedDisplay.innerHTML = '';
  }

  // Add new contact button
  addNewBtn.addEventListener('click', function() {
    window.open('/crm/contact/create/', '_blank');
  });

  // Hide results when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.contact-selector-wrapper')) {
      searchResults.classList.remove('active');
    }
  });
  {% endif %}

  // Form submission with loading spinner and toast
  const form = document.querySelector('form');
  const submitBtn = document.getElementById('submit-btn');
  const btnText = submitBtn.querySelector('.btn-text');
  const btnSpinner = submitBtn.querySelector('.btn-spinner');
  const toast = document.getElementById('toast-notification');
  const toastMessage = toast.querySelector('.toast-message');

  form.addEventListener('submit', function(e) {
    // Show loading state
    btnText.style.display = 'none';
    btnSpinner.style.display = 'inline-flex';
    submitBtn.disabled = true;

    // Check if this is an AJAX-enabled form
    const isAjax = form.closest('#CreateFormPage');
    
    if (isAjax && typeof XMLHttpRequest !== 'undefined') {
      e.preventDefault();
      
      const formData = new FormData(form);
      const xhr = new XMLHttpRequest();
      
      xhr.open('POST', form.action || window.location.href);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      xhr.setRequestHeader('X-CSRFToken', formData.get('csrfmiddlewaretoken'));
      
      xhr.onload = function() {
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            
            if (response.success) {
              // Show success toast
              toastMessage.textContent = `{{ model_type|title }} "${response.company_name || 'successfully'}" created successfully!`;
              toast.classList.add('show');
              
              // Hide toast after 3 seconds
              setTimeout(() => {
                toast.classList.remove('show');
              }, 3000);
              
              // Redirect after a short delay
              setTimeout(() => {
                window.location.href = response.redirect_url;
              }, 1000);
            } else {
              // Show error
              alert('Error: ' + (response.error || 'An error occurred while creating the {{ model_type }}'));
              resetButton();
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            resetButton();
          }
        } else {
          alert('Error: Failed to create {{ model_type }}. Please try again.');
          resetButton();
        }
      };
      
      xhr.onerror = function() {
        alert('Network error. Please check your connection and try again.');
        resetButton();
      };
      
      xhr.send(formData);
    }
    // If not AJAX, form will submit normally with loading state
  });

  function resetButton() {
    btnText.style.display = 'inline';
    btnSpinner.style.display = 'none';
    submitBtn.disabled = false;
  }
  </script>
{% endblock %}
