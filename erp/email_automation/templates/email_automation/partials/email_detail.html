{% if error %}
<div class="email-detail-empty">
    <i class="fas fa-exclamation-circle" style="color: #ef4444;"></i>
    <p>{{ error }}</p>
</div>
{% else %}
<div class="ed-layout">
    <!-- ========== MAIN CONTENT (LEFT) ========== -->
    <div class="ed-main">
        <!-- Top Action Bar -->
        <div class="ed-topbar">
            <div class="ed-breadcrumb">
                <i class="fas fa-envelope"></i>
                <span>{{ email.folder|title }} / {{ email.subject|default:"(No Subject)"|truncatewords:6 }}</span>
            </div>
            <div class="ed-topbar-actions">
                <button class="ed-action-btn" title="Reply"
                    onclick="openComposeModal(null, '{{ email.from_email }}', 'Re: {{ email.subject|cut:" Re: " }}')">
                    <i class="fas fa-reply"></i> <span>Reply</span>
                </button>
                <button class="ed-action-btn" title="Forward">
                    <i class="fas fa-share"></i> <span>Forward</span>
                </button>
                {% if email.folder != 'trash' %}
                <button class="ed-action-btn ed-action-danger" title="Delete" onclick="deleteEmail({{ email.id }})">
                    <i class="fas fa-trash-alt"></i>
                </button>
                {% endif %}
                {% if email.folder == 'inbox' %}
                <button class="ed-action-btn" title="Archive" onclick="moveEmail({{ email.id }}, 'archive')">
                    <i class="fas fa-archive"></i>
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Email Header -->
        <div class="ed-header">
            <div class="ed-meta">
                <div class="ed-avatar">
                    {{ email.from_name|default:email.from_email|make_list|first|upper }}
                </div>
                <div class="ed-meta-info">
                    <div class="ed-from-row">
                        <span class="ed-from-name">{{ email.from_name|default:email.from_email }}</span>
                        {% for company in email.companies.all %}
                        <span class="ed-association-badge">
                            <i class="fas fa-building"></i> Associated with {{ company.name }}
                        </span>
                        {% empty %}
                        {% if email.company %}
                        <span class="ed-association-badge">
                            <i class="fas fa-building"></i> Associated with {{ email.company.name }}
                        </span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <div class="ed-sub-info">
                        <span class="ed-from-email">{{ email.from_email }}</span>
                        <span class="ed-separator">·</span>
                        <span class="ed-recipients-summary">to {{ email.to_emails|join:", " }}</span>
                    </div>
                </div>
                <div class="ed-right">
                    <div class="ed-date">
                        {% if email.sent_at %}
                        {{ email.sent_at|date:"M d, Y, H:i" }}
                        {% elif email.received_at %}
                        {{ email.received_at|date:"M d, Y, H:i" }}
                        {% else %}
                        {{ email.created_at|date:"M d, Y, H:i" }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject -->
        <div class="ed-subject-section">
            <h1 class="ed-subject">{{ email.subject|default:"(No Subject)" }}</h1>
        </div>

        <!-- Email Body -->
        <div class="ed-body">
            {% autoescape off %}
            {{ email.body_html|default:email.body_text|linebreaks }}
            {% endautoescape %}
        </div>

        <!-- Attachments -->
        {% if attachments %}
        <div class="ed-attachments">
            <div class="ed-attachments-title">
                <i class="fas fa-paperclip"></i>
                <span>ATTACHMENTS ({{ attachments.count }})</span>
            </div>
            <div class="ed-attachment-grid">
                {% for attachment in attachments %}
                <a href="{% url 'email_automation:download_attachment' attachment.id %}" target="_blank"
                    class="ed-attachment-card" title="Download {{ attachment.filename }}">
                    <div class="ed-att-icon">
                        <i class="fas {{ attachment.get_file_icon }}"></i>
                    </div>
                    <div class="ed-att-info">
                        <div class="ed-att-name">{{ attachment.filename }}</div>
                        <div class="ed-att-size">{{ attachment.get_size_display }}</div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ========== CRM SIDEBAR (RIGHT) ========== -->
    {% with companies=email.companies.all contacts=email.contacts.all %}
    {% if companies or contacts or email.company or email.contact %}
    <div class="ed-crm-sidebar">
        <!-- Company Card -->
        {% for company in companies %}
        <div class="crm-sidebar-section">
            <div class="crm-section-title">
                <i class="fas fa-sparkles"></i> RELATED CRM RECORD
            </div>
            <div class="crm-card">
                <div class="crm-card-header">
                    <div class="crm-card-icon company">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="crm-card-info">
                        <div class="crm-card-name">{{ company.name }}</div>
                        <div class="crm-card-type">Company</div>
                    </div>
                </div>
                {% if company.address %}
                <div class="crm-card-detail">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ company.address }}</span>
                </div>
                {% endif %}
                {% if company.phone %}
                <div class="crm-card-detail">
                    <i class="fas fa-phone"></i>
                    <span>{{ company.phone }}</span>
                </div>
                {% endif %}
                <a href="{% url 'crm:company_detail' company.id %}" class="crm-profile-btn">
                    View Profile <i class="fas fa-external-link-alt"></i>
                </a>
            </div>
        </div>
        {% empty %}
        {% if email.company %}
        <div class="crm-sidebar-section">
            <div class="crm-section-title">
                <i class="fas fa-sparkles"></i> RELATED CRM RECORD
            </div>
            <div class="crm-card">
                <div class="crm-card-header">
                    <div class="crm-card-icon company">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="crm-card-info">
                        <div class="crm-card-name">{{ email.company.name }}</div>
                        <div class="crm-card-type">Company</div>
                    </div>
                </div>
                <a href="{% url 'crm:company_detail' email.company.id %}" class="crm-profile-btn">
                    View Profile <i class="fas fa-external-link-alt"></i>
                </a>
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <!-- Contact Card -->
        {% for contact in contacts %}
        <div class="crm-sidebar-section">
            <div class="crm-section-title">
                <i class="fas fa-user"></i> CONTACT
            </div>
            <div class="crm-card">
                <div class="crm-card-header">
                    <div class="crm-card-icon contact">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="crm-card-info">
                        <div class="crm-card-name">{{ contact.name }}</div>
                        <div class="crm-card-type">Contact{% if contact.company %} · {{ contact.company.name }}{% endif
                            %}</div>
                    </div>
                </div>
                {% if contact.phone %}
                <div class="crm-card-detail">
                    <i class="fas fa-phone"></i>
                    <span>{{ contact.phone }}</span>
                </div>
                {% endif %}
                <a href="{% url 'crm:contact_detail' contact.id %}" class="crm-profile-btn">
                    View Profile <i class="fas fa-external-link-alt"></i>
                </a>
            </div>
        </div>
        {% empty %}
        {% if email.contact %}
        <div class="crm-sidebar-section">
            <div class="crm-section-title">
                <i class="fas fa-user"></i> CONTACT
            </div>
            <div class="crm-card">
                <div class="crm-card-header">
                    <div class="crm-card-icon contact">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="crm-card-info">
                        <div class="crm-card-name">{{ email.contact.name }}</div>
                        <div class="crm-card-type">Contact</div>
                    </div>
                </div>
                <a href="{% url 'crm:contact_detail' email.contact.id %}" class="crm-profile-btn">
                    View Profile <i class="fas fa-external-link-alt"></i>
                </a>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
</div>
{% endif %}

<script>
    function moveEmail(emailId, folder) {
        if (!confirm('Move this email?')) return;

        fetch(`/email/email/${emailId}/move/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `folder=${folder}`
        })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    const activeLink = document.querySelector('.folder-link.active');
                    if (activeLink && typeof htmx !== 'undefined') {
                        htmx.trigger(activeLink, 'click');
                    }
                    const dp = document.getElementById('emailDetailContent');
                    if (dp) dp.innerHTML = `
                    <div class="email-detail-empty">
                        <i class="far fa-envelope"></i>
                        <p>Select an email to view</p>
                        <span>Select an email from the list.</span>
                    </div>`;
                }
            });
    }

    function deleteEmail(emailId) {
        if (!confirm('Are you sure you want to delete this email?')) return;

        fetch(`/email/email/${emailId}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    const activeLink = document.querySelector('.folder-link.active');
                    if (activeLink && typeof htmx !== 'undefined') {
                        htmx.trigger(activeLink, 'click');
                    }
                    const dp = document.getElementById('emailDetailContent');
                    if (dp) dp.innerHTML = `
                    <div class="email-detail-empty">
                        <i class="far fa-envelope"></i>
                        <p>Select an email to view</p>
                        <span>Select an email from the list.</span>
                    </div>`;
                }
            });
    }
</script>