{% load static %}
{% load erp_tags %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}ERP{% endblock %}</title>

  <!-- CSS Files -->
  <link rel="stylesheet" href="{% static 'erp/css/base.css' %}?v=4.4" />
  <link rel="shortcut icon" type="image/ico" href="{% static 'erp/images/favicon.ico' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="{% static 'erp/css/command_palette.css' %}?v=9" />

  <!-- HTMX -->
  <script src="{% static 'erp/htmx.min.js' %}" defer></script>
  {% comment %}
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.5/dist/htmx.min.js"></script> {% endcomment %}
  {% comment %}Unsaved changes handler - now inline in base.html script section{% endcomment %}
  {% block css %}
  <link rel="stylesheet" href="{% static 'todo/css/components/tasks_new.css' %}" />
  <link rel="stylesheet" href="{% static 'operating/css/create_order.css' %}" />
  {% endblock %}
  <style>
    /* Dynamic Email/Phone Fields - Modern Circular Buttons */
    .dynamic-field-container {
      display: flex;
      flex-direction: column;
      gap: 8px !important;
    }

    .dynamic-field-wrapper {
      display: flex !important;
      align-items: center !important;
      gap: 8px !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    .dynamic-field-input-wrapper {
      flex: 1 1 0 !important;
      max-width: 100% !important;
      background: #fff !important;
      border: 1px solid #e5e7eb !important;
      border-radius: 8px !important;
      transition: border-color 0.2s !important;
      min-height: 42px !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
    }

    .dynamic-field-input-wrapper:hover {
      border-color: #cbd5e1 !important;
    }

    .dynamic-field-input-wrapper:focus-within {
      border-color: #667eea !important;
      box-shadow: none !important;
      outline: none !important;
    }

    .dynamic-field-input {
      width: 100%;
      padding: 11px 14px !important;
      font-size: 14px !important;
      border: none !important;
      background: transparent !important;
      min-height: 42px;
    }

    .dynamic-field-input:focus {
      outline: none !important;
    }

    .btn-remove-field,
    .btn-add-field {
      width: 28px !important;
      height: 28px !important;
      min-width: 28px !important;
      border: 1.5px solid #d1d5db !important;
      border-radius: 50% !important;
      background: #fff !important;
      cursor: pointer;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 14px !important;
      color: #6b7280 !important;
      transition: all 0.15s ease;
      flex-shrink: 0 !important;
      padding: 0 !important;
      line-height: 1 !important;
    }

    .btn-add-field:hover {
      background: #f0fdf4 !important;
      border-color: #86efac !important;
      color: #16a34a !important;
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
    }

    .btn-remove-field:hover {
      background: #fef2f2 !important;
      border-color: #fca5a5 !important;
      color: #dc2626 !important;
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
    }

    /* Modern Contact Search Results */
    .contact-results {
      max-height: 300px;
      overflow-y: auto;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      display: none;
      margin-top: 8px;
    }

    .contact-results.active {
      display: block;
    }

    .contact-result-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      user-select: none;
    }

    .contact-result-item:hover {
      background: #f0f4ff;
    }

    .contact-result-item:active {
      background: #e0e7ff;
    }

    .contact-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      flex-shrink: 0;
    }

    .contact-info {
      flex: 1;
      min-width: 0;
      pointer-events: none;
    }

    .contact-name {
      font-weight: 600;
      color: #111827;
      font-size: 15px;
      cursor: pointer;
    }

    .contact-details {
      font-size: 13px;
      color: #6b7280;
      margin-top: 2px;
      cursor: pointer;
    }

    .selected-contact {
      margin-top: 12px;
      padding: 12px 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      display: none;
      align-items: center;
      gap: 12px;
    }

    .selected-contact.active {
      display: flex;
    }

    /* ===== MOBILE RESPONSIVE FIXES ===== */
    @media (max-width: 768px) {

      /* Mobile: Main area adjustments */
      main {
        margin-left: 0 !important;
        padding: 1rem !important;
        padding-bottom: 6rem !important;
      }

      /* Mobile: Bottom navbar */
      .navbar {
        width: 100% !important;
        height: auto !important;
        bottom: 0 !important;
        top: auto !important;
        left: 0 !important;
        border-right: none !important;
        border-top: 1px solid #e2e8f0 !important;
        position: fixed !important;
      }

      .navbar-nav {
        flex-direction: row !important;
        justify-content: space-around !important;
        width: 100% !important;
        padding: 0.5rem 0 !important;
      }

      .logo {
        display: none !important;
      }

      .link-text {
        display: none !important;
      }

      .nav-link {
        height: 3.5rem !important;
        min-width: 3.5rem !important;
        padding: 0.5rem !important;
      }

      .last2items {
        display: flex !important;
        flex-direction: row !important;
        margin-top: 0 !important;
      }

      /* Mobile: Dropdown menus - CENTERED above bottom navbar */
      .nav-item #addExpanded,
      #marketingExpanded,
      #operatingExpanded,
      #accountingExpanded {
        position: fixed !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        bottom: 5rem !important;
        top: auto !important;
        width: calc(100vw - 2rem) !important;
        max-width: 340px !important;
        max-height: 50vh !important;
        overflow-y: auto !important;
        z-index: 99999 !important;
      }

      /* Mobile: Remove hover bridge */
      #addButton::after,
      #marketingButton::after,
      #operatingButton::after,
      #accountingButton::after {
        display: none !important;
      }

      /* Mobile: Sidebar modals full width */
      .sidebar-modal {
        width: 100vw !important;
        max-width: 100vw !important;
        border-radius: 0 !important;
      }

      .sidebar-content {
        padding: 1rem !important;
      }

      .sidebar-header {
        padding: 1rem !important;
      }

      .sidebar-footer {
        padding: 1rem !important;
        flex-direction: column !important;
      }

      .sidebar-footer .btn {
        width: 100% !important;
      }

      /* Mobile: Stats bar vertical */
      .stats-bar {
        flex-direction: column !important;
        gap: 1rem !important;
        padding: 1rem !important;
      }

      .stat-divider {
        display: none !important;
      }

      /* Mobile: Dashboard tabs horizontal scroll */
      .main-tabs-container {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        flex-wrap: nowrap !important;
        padding-bottom: 4px !important;
      }

      .main-tab {
        flex-shrink: 0 !important;
        white-space: nowrap !important;
        padding: 10px 16px !important;
        font-size: 0.875rem !important;
      }

      /* Mobile: Search Overlay Responsive */
      .navbar .overlay {
        padding-top: 2rem !important;
        align-items: flex-start !important;
        z-index: 999999 !important;
      }

      .navbar .overlay .overlayContent {
        width: 95% !important;
        max-width: 100% !important;
        padding: 1.5rem !important;
        max-height: 85vh !important;
        overflow-y: auto !important;
        margin-top: 1rem !important;
      }

      .navbar .overlay #searchInput {
        font-size: 16px !important;
        /* Prevent zoom on iOS */
      }
    }
  </style>
</head>

<body>
  <!-- Global Top Bar -->
  <div class="global-top-bar">
    <div class="top-bar-left">
      <span class="welcome-text">Welcome to the base page, {{ user.first_name }} {{ user.last_name }}!</span>
      <span class="header-date">{% now 'F j, Y' %}</span>
    </div>

    <div class="top-bar-center">
      <div class="search-container" id="searchContainer">
        <!-- Single Search Box with Input -->
        <div class="search-box-wrapper" id="searchBoxWrapper">
          <i class="fas fa-search search-icon"></i>
          <div class="search-filter-chips" id="cmdFilterChips"></div>
          <input type="text" class="search-input" id="cmdSearchInput" placeholder="Search..." autocomplete="off"
            onfocus="openSearchDropdown()" />
          <div class="search-shortcut" id="searchShortcut">
            <kbd>Ctrl</kbd><kbd>K</kbd>
          </div>
          <button class="search-clear-btn hidden" id="cmdClearBtn" onclick="clearCmdSearch(); event.stopPropagation();">
            <i class="fas fa-times-circle"></i>
          </button>
          <button class="filter-toggle-btn hidden" id="filterToggle"
            onclick="toggleCmdFilterMenu(); event.stopPropagation();" title="Filter">
            <i class="fas fa-sliders-h"></i>
          </button>
        </div>

        <!-- Dropdown Panel (no separate search header) -->
        <div class="search-dropdown-panel" id="searchDropdownPanel">
          <div class="search-dropdown-tabs" id="cmdModalTabs">
            <button class="cmd-tab active" data-tab="all" onclick="setCmdTab('all')">All</button>
            <button class="cmd-tab" data-tab="contacts" onclick="setCmdTab('contacts')">Contacts</button>
            <button class="cmd-tab" data-tab="products" onclick="setCmdTab('products')">Products</button>
            <button class="cmd-tab" data-tab="orders" onclick="setCmdTab('orders')">Orders</button>
            <button class="cmd-tab" data-tab="menu" onclick="setCmdTab('menu')">Navigation</button>
          </div>

          <div class="search-dropdown-body" id="cmdModalBody">
            <div class="search-section" id="cmdRecentSection">
              <div class="section-header">
                <span>RECENT SEARCHES</span>
                <button class="clear-recent-btn" onclick="clearCmdRecentSearches()">Clear history</button>
              </div>
              <div class="recent-list" id="cmdRecentList"></div>
            </div>
            <div class="search-results-container" id="cmdResultsContainer"></div>
            <div class="search-empty-state hidden" id="cmdEmptyState">
              <i class="fas fa-search"></i>
              <p>Search for something...</p>
            </div>
            <div class="filter-menu hidden" id="cmdFilterMenu">
              <div class="filter-menu-header">Filter by category</div>
              <div class="filter-menu-list" id="cmdFilterMenuList"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="top-bar-right">
      <div class="notification-container">
        <button class="top-bar-btn" onclick="toggleNotifications()" id="topBarNotificationBell">
          <i class="far fa-bell"></i>
          <span class="notification-dot hidden" id="notificationBadge"></span>
        </button>
        <div class="notification-dropdown" id="notificationDropdown">
          <div class="notification-header">
            <h3>Notifications</h3>
            <button class="mark-all-read-btn" onclick="markAllNotificationsRead()">
              <i class="fas fa-check-double"></i>
            </button>
          </div>
          <div class="notification-list" id="notificationList">
            <div class="notification-empty">
              <i class="far fa-bell-slash"></i>
              <p>No new notifications</p>
            </div>
          </div>
        </div>
      </div>
      <a href="{% url 'user_settings' %}" class="top-bar-btn" title="Settings">
        <i class="fas fa-cog"></i>
      </a>
      <a href="{% url 'authentication:signout' %}" class="top-bar-btn" title="Sign Out">
        <i class="fas fa-sign-out-alt"></i>
      </a>
    </div>
  </div>

  {% with member=user.member %}
  <nav class="navbar">
    <ul class="navbar-nav">
      <!-- Logo in sidebar -->
      <li class="logo">
        <a href="{% url 'index' %}" class="nav-link">
          <span id="nejum_logo_text" class="link-text logo-text">nejum</span>
        </a>
      </li>

      <li class="nav-item" id="addButton">
        <a href="#add" class="nav-link">
          <i class="fas fa-plus fa-2x" aria-hidden="true"></i>
          <span class="link-text">Add</span>
        </a>
        <div id="addExpanded">
          <div class="add-menu-header">
            <i class="fas fa-plus-circle" aria-hidden="true"></i>
            <h2>Add new records</h2>
          </div>
          <div class="add-menu-section">
            <h3>Add a single record</h3>
            <ul>
              <li>
                <a href="#" onclick="openMainContactSidebar(); return false;">
                  <i class="fas fa-user" aria-hidden="true"></i>
                  <span>Contact</span>
                </a>
              </li>
              <li>
                <a href="#" onclick="openCompanySidebar(); return false;">
                  <i class="fas fa-building" aria-hidden="true"></i>
                  <span>Company</span>
                </a>
              </li>
              <li>
                <a href="#" onclick="openTaskSidebar(); return false;">
                  <i class="fas fa-check-circle" aria-hidden="true"></i>
                  <span>Task</span>
                </a>
              </li>
              <li>
                <a href="{% url 'marketing:product_create' %}">
                  <i class="fas fa-tag" aria-hidden="true"></i>
                  <span>Product</span>
                </a>
              </li>
              <li>
                <a href="#" onclick="openOrderSidebar(); return false;">
                  <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                  <span>Order</span>
                </a>
              </li>
              <li>
                <a href="{% url 'marketing:blog_create' %}">
                  <i class="fas fa-newspaper" aria-hidden="true"></i>
                  <span>Blog</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="nav-separator-in-add">
          <div class="nav-separator-line"></div>
        </div>
      </li>
      <li class="nav-item">
        <a href="{% url 'index' %}" class="nav-link">
          <i class="fas fa-home fa-2x" aria-hidden="true"></i>
          {% comment %} <i class="fas fa-table-columns fa-2x" aria-hidden="true"></i> {% endcomment %}
          <span class="link-text">Home</span>
        </a>
      </li>
      <li class="nav-item" id="teamButton">
        <a href="#team" class="nav-link">
          <i class="fas fa-users fa-2x" aria-hidden="true"></i>
          <span class="link-text">My Team</span>
        </a>
        <div id="teamExpanded" style="top: 135px !important; max-height: 90vh !important; overflow-y: auto !important;">
          <div class="add-menu-header">
            <i class="fas fa-users" aria-hidden="true"></i>
            <h2>My Team</h2>
          </div>
          <div class="add-menu-section">
            <h3>Team Management</h3>
            <ul>
              <li>
                <a href="{% url 'team:team_list' %}">
                  <i class="fas fa-list" aria-hidden="true"></i>
                  <span>Team Members</span>
                </a>
              </li>
              <li>
                <a href="{% url 'team:team_tasks' %}">
                  <i class="fas fa-tasks" aria-hidden="true"></i>
                  <span>Assign Tasks</span>
                </a>
              </li>
              <li>
                <a href="{% url 'team:team_messages' %}">
                  <i class="fas fa-comments" aria-hidden="true"></i>
                  <span>Messages</span>
                </a>
              </li>
              <li>
                <a href="{% url 'team:team_roles' %}">
                  <i class="fas fa-shield-alt" aria-hidden="true"></i>
                  <span>Manage Roles</span>
                </a>
              </li>
              <li>
                <a href="{% url 'team:team_meetings' %}">
                  <i class="fas fa-video" aria-hidden="true"></i>
                  <span>Schedule Meetings</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </li>
      {% comment %} <li class="nav-item">
        <a href="{% url 'crm:index' %}" class="nav-link">
          <i class="fas fa-users fa-2x" aria-hidden="true"></i>
          <span class="link-text">Contacts</span>
        </a>
      </li> {% endcomment %}
      <li class="nav-item" id="accountingButton">
        <a href="#accounting" class="nav-link">
          <i class="fa-solid fa-money-bill fa-2x" aria-hidden="true"></i>
          <span class="link-text">Accounting</span>
        </a>
        <div id="accountingExpanded"
          style="top: 195px !important; max-height: 90vh !important; overflow-y: auto !important;">
          <div class="add-menu-header">
            <i class="fas fa-money-bill" aria-hidden="true"></i>
            <h2>Accounting</h2>
          </div>
          <div class="add-menu-section">
            <h3>Books</h3>
            <ul>
              <li>
                <a href="{% url 'accounting:index' %}">
                  <i class="fas fa-book" aria-hidden="true"></i>
                  <span>View Books</span>
                </a>
              </li>
              <li>
                <a href="#" onclick="openBookSidebar(); return false;">
                  <i class="fas fa-plus-circle" aria-hidden="true"></i>
                  <span>Create Book</span>
                </a>
              </li>
            </ul>
          </div>
          <div class="add-menu-section">
            <h3>Reports</h3>
            <ul>
              <li>
                <a href="{% url 'accounting:sales_dashboard' %}">
                  <i class="fas fa-chart-bar" aria-hidden="true"></i>
                  <span>Sales Dashboard</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </li>
      <li class="nav-item" id="marketingButton">
        <a href="#marketing" class="nav-link">
          {% comment %} <i class="fas fa-cogs fa-2x" aria-hidden="true"></i> {% endcomment %}
          <i class="fa-solid fa-bullseye fa-2x" aria-hidden="true"></i>
          <span class="link-text">Marketing</span>
        </a>
        <div id="marketingExpanded"
          style="top: 255px !important; max-height: 90vh !important; overflow-y: auto !important;">
          <div class="add-menu-header">
            <i class="fas fa-bullseye" aria-hidden="true"></i>
            <h2>Marketing</h2>
          </div>
          <div class="add-menu-section">
            <h3>Products</h3>
            <ul>
              <li>
                <a href="{% url 'marketing:product_create' %}">
                  <i class="fas fa-plus-circle" aria-hidden="true"></i>
                  <span>Create Product</span>
                </a>
              </li>
              <li>
                <a href="{% url 'marketing:product_list' %}">
                  <i class="fas fa-list" aria-hidden="true"></i>
                  <span>Product List</span>
                </a>
              </li>
            </ul>
          </div>
          <div class="add-menu-section">
            <h3>Customers</h3>
            <ul>
              <li>
                <a href="{% url 'crm:company_list' %}">
                  <i class="fas fa-building" aria-hidden="true"></i>
                  <span>Companies</span>
                </a>
              </li>
              <li>
                <a href="{% url 'crm:contact_list' %}">
                  <i class="fas fa-users" aria-hidden="true"></i>
                  <span>Contacts</span>
                </a>
              </li>
            </ul>
          </div>
          <div class="add-menu-section">
            <h3>Blog</h3>
            <ul>
              <li>
                <a href="{% url 'marketing:blog_create' %}">
                  <i class="fas fa-plus-circle" aria-hidden="true"></i>
                  <span>Create Blog Post</span>
                </a>
              </li>
              <li>
                <a href="{% url 'marketing:blog_list' %}">
                  <i class="fas fa-newspaper" aria-hidden="true"></i>
                  <span>Blog List</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </li>
      <li class="nav-item" id="operatingButton">
        <a href="#operating" class="nav-link">
          <i class="fas fa-cogs fa-2x" aria-hidden="true"></i>
          <span class="link-text">Operating</span>
        </a>
        <div id="operatingExpanded"
          style="top: 315px !important; max-height: 90vh !important; overflow-y: auto !important;">
          <div class="add-menu-header">
            <i class="fas fa-cogs" aria-hidden="true"></i>
            <h2>Operating</h2>
          </div>
          <div class="add-menu-section">
            <h3>QR Operations</h3>
            <ul>
              <li>
                <a href="{% url 'operating:scan_order_item_unit' %}">
                  <i class="fas fa-qrcode" aria-hidden="true"></i>
                  <span>QR Scan</span>
                </a>
              </li>
              <li>
                <a href="{% url 'operating:scan_order_item_unit_pack' %}">
                  <i class="fa-solid fa-box" aria-hidden="true"></i>
                  <span>QR Scan Pack</span>
                </a>
              </li>
            </ul>
          </div>
          <div class="add-menu-section">
            <h3>Raw Materials</h3>
            <ul>
              <li>
                <a href="{% url 'operating:raw_material_good_list' %}">
                  <i class="fas fa-list" aria-hidden="true"></i>
                  <span>Raw Material List</span>
                </a>
              </li>
              <li>
                <a href="#" onclick="openRawMaterialSidebar(); return false;">
                  <i class="fas fa-cube" aria-hidden="true"></i>
                  <span>Create Raw Material Good</span>
                </a>
              </li>
              <li>
                <a href="#" onclick="openRawMaterialReceiptSidebar(); return false;">
                  <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
                  <span>Create Raw Material Good Receipt</span>
                </a>
              </li>
              <li>
                <a href="#" onclick="openRawMaterialItemSidebar(); return false;">
                  <i class="fas fa-plus-square" aria-hidden="true"></i>
                  <span>Create Raw Material Good Item</span>
                </a>
              </li>
            </ul>
          </div>
          <div class="add-menu-section">
            <h3>Orders</h3>
            <ul>
              <li>
                <a href="#" onclick="openOrderSidebar(); return false;">
                  <i class="fas fa-plus-circle" aria-hidden="true"></i>
                  <span>Create Order</span>
                </a>
              </li>
              <li>
                <a href="{% url 'operating:order_list' %}">
                  <i class="fas fa-list" aria-hidden="true"></i>
                  <span>Order List</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </li>
      <li class="nav-item">
        <a href="{% url 'operating:order_analytics' %}" class="nav-link">
          <i class="fas fa-chart-line fa-2x" aria-hidden="true"></i>
          <span class="link-text">Analytics</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="{% url 'email_automation:dashboard' %}" class="nav-link">
          <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
          <span class="link-text">Mail</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="{% url 'reports' %}" class="nav-link">
          <i class="fa-solid fa-paste fa-2x"></i>
          <span class="link-text">Reports</span>
        </a>
      </li>
    </ul>
  </nav>
  <main>
    {% block content %}

    {% endblock %}
  </main>
  {% endwith %}

  <script src="{% static 'erp/js/command_palette.js' %}"></script>

  <!-- Task Sidebar Modal -->
  <div id="taskSidebarOverlay" class="sidebar-overlay" onclick="closeTaskSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeTaskSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-check-circle"></i>
          <h2>Create a new task</h2>
        </div>
      </div>
      <div class="sidebar-content">
        <form id="taskForm" method="post" action="{% url 'todo:create_task' %}">
          {% csrf_token %}
          <div class="form-group">
            <label for="id_name">Task name</label>
            <input type="text" name="name" id="id_name" class="form-input" required autofocus>
          </div>

          <div class="form-group">
            <label for="id_due_date">Due date</label>
            <input type="date" name="due_date" id="id_due_date" class="form-input" value="{{ today }}">
          </div>

          <div class="form-group">
            <label for="id_priority">Priority</label>
            <select name="priority" id="id_priority" class="form-input">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>

          <div class="form-group">
            <label for="id_description">Description</label>
            <textarea name="description" id="id_description" class="form-textarea" rows="3"
              placeholder="Enter a description or any notes about this task."></textarea>
          </div>

          <div class="form-group">
            <label for="id_task_member">Assign to</label>
            <select name="member" id="id_task_member" class="form-input">
              {% for member in all_members %}
              <option value="{{ member.id }}" {% if member.user == request.user %}selected{% endif %}>{{ member }}
              </option>
              {% endfor %}
            </select>
          </div>

          <!-- Attach an item section -->
          <div class="attach-section">
            <div class="attach-header">
              <i class="fas fa-paperclip"></i>
              <span>Attach to</span>
            </div>
            <div class="attach-buttons">
              <button type="button" class="attach-btn" onclick="toggleAttachment('taskCompany')">
                <i class="fas fa-building"></i> Company
              </button>
              <button type="button" class="attach-btn" onclick="toggleAttachment('taskContact')">
                <i class="fas fa-user"></i> Contact
              </button>
            </div>
          </div>

          <!-- Company attachment -->
          <div id="taskCompanySection" class="attachment-section" style="display: none;">
            <div class="attachment-header">
              <span><i class="fas fa-building"></i> Attach to company</span>
              <button type="button" class="remove-attachment" onclick="toggleAttachment('taskCompany')">
                Remove
              </button>
            </div>
            <div class="form-group">
              <label for="id_task_company_search">Search company</label>
              <input type="text" id="id_task_company_search" class="form-input" placeholder="Type company name..."
                hx-get="{% url 'crm:company_search' %}" hx-trigger="keyup changed delay:300ms"
                hx-target="#taskCompanyResults" hx-params="*" name="company_name" autocomplete="off">
              <div id="taskCompanyResults" class="search-results"></div>
            </div>
            <input type="hidden" name="company" id="id_company" value="">
          </div>

          <!-- Contact attachment -->
          <div id="taskContactSection" class="attachment-section" style="display: none;">
            <div class="attachment-header">
              <span><i class="fas fa-user"></i> Attach to contact</span>
              <button type="button" class="remove-attachment" onclick="toggleAttachment('taskContact')">
                Remove
              </button>
            </div>
            <div class="form-group">
              <label for="id_task_contact_search">Search contact</label>
              <input type="text" id="id_task_contact_search" class="form-input" placeholder="Type contact name..."
                hx-post="{% url 'crm:search_contacts_only' %}" hx-trigger="keyup changed delay:300ms"
                hx-target="#taskContactResults" hx-params="*" name="searchInput" autocomplete="off">
              <div id="taskContactResults" class="search-results"></div>
            </div>
            <input type="hidden" name="contact" id="id_contact" value="">
          </div>

          <div class="sidebar-footer">
            <button type="submit" class="btn btn-primary">Create task</button>
            <button type="button" class="btn btn-secondary" onclick="closeTaskSidebar()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Company Sidebar Modal -->
  <div id="companySidebarOverlay" class="sidebar-overlay" onclick="closeCompanySidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeCompanySidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-building"></i>
          <h2>Add a Company</h2>
        </div>
      </div>
      <div class="sidebar-content">
        <form id="companyForm" method="post" onsubmit="submitCompanyForm(event); return false;">
          {% csrf_token %}
          <div class="form-group">
            <label for="id_company_name">Company Name <span style="color: #ef4444;">*</span></label>
            <input type="text" name="name" id="id_company_name" class="form-input" required autofocus
              hx-get="{% url 'crm:check_company_duplicate' %}" hx-trigger="keyup changed delay:500ms"
              hx-target="#company_name_error">
            <div id="company_name_error"></div>
          </div>

          <div class="form-group">
            <label>Email addresses</label>
            <div id="company_emails_container"></div>
            <input type="hidden" name="emails_data" id="emails_data">
          </div>

          <div class="form-group">
            <label>Phone numbers</label>
            <div id="company_phones_container"></div>
            <input type="hidden" name="phones_data" id="phones_data">
          </div>

          <div class="form-group">
            <label for="id_company_website">Website</label>
            <input type="text" name="website" id="id_company_website" class="form-input">
          </div>

          <div class="form-group">
            <label for="id_company_address">Address</label>
            <textarea name="address" id="id_company_address" class="form-textarea" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="id_company_background">Background info</label>
            <textarea name="backgroundInfo" id="id_company_background" class="form-textarea" rows="2"></textarea>
          </div>

          <div class="form-group">
            <label for="id_company_country">Country</label>
            <input type="text" name="country" id="id_company_country" class="form-input">
          </div>

          <div class="form-group">
            <label for="id_company_group">Group</label>
            <select name="group" id="id_company_group" class="form-input">
              <option value="">---------</option>
              {% for group in client_groups %}
              <option value="{{ group.id }}">{{ group.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="id_company_status">Status</label>
            <select name="status" id="id_company_status" class="form-input" required>
              <option value="prospect">Prospect</option>
              <option value="qualified">Qualified</option>
            </select>
          </div>

          <!-- Email Follow-up Option -->
          <div class="email-followup-option">
            <div class="email-checkbox-wrapper">
              <input type="checkbox" name="send_followup_emails" id="send_followup_emails" class="email-checkbox">
              <label for="send_followup_emails" class="email-checkbox-label">
                <span class="email-checkbox-title">ðŸ“§ Send Follow-up Emails</span>
                <span class="email-checkbox-description">Automatically send 5 follow-up emails over 54 days</span>
              </label>
            </div>
          </div>

          <!-- Attach an item section -->
          <div class="attach-section">
            <div class="attach-header">
              <i class="fas fa-paperclip"></i>
              <span>Attach an item</span>
            </div>
            <div class="attach-buttons">
              <button type="button" class="attach-btn" onclick="toggleAttachment('companyContact')">
                <i class="fas fa-user"></i> Contact
              </button>
              <button type="button" class="attach-btn" onclick="toggleAttachment('companyNote')">
                <i class="fas fa-file-text"></i> Note
              </button>
              <button type="button" class="attach-btn" onclick="toggleAttachment('companyTask')">
                <i class="fas fa-check-circle"></i> Task
              </button>
            </div>
          </div>

          <!-- Contact attachment -->
          <div id="companyContactSection" class="attachment-section" style="display: none;">
            <div class="attachment-header">
              <span><i class="fas fa-user"></i> Attach a contact</span>
              <button type="button" class="remove-attachment" onclick="toggleAttachment('companyContact')">
                Remove this contact
              </button>
            </div>
            <div class="contact-selector-wrapper">
              <div class="contact-search-box">
                <input type="text" id="company_contact_search" class="form-input" placeholder="Search contacts..."
                  autocomplete="off" />
                <button type="button" class="add-contact-icon-btn" onclick="openContactSidebarFromCompany()"
                  title="Add new contact">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div id="company_contact_results" class="contact-results"></div>
              <div id="company_selected_contact" class="selected-contact"></div>
              <input type="hidden" name="contact_id" id="company_contact_id" value="">
            </div>
          </div>

          <!-- Note attachment -->
          <div id="companyNoteSection" class="attachment-section" style="display: none;">
            <div class="attachment-header">
              <span><i class="fas fa-file-text"></i> Attach a note</span>
              <button type="button" class="remove-attachment" onclick="toggleAttachment('companyNote')">
                Remove this note
              </button>
            </div>
            <div class="form-group">
              <label for="id_company_note">Note</label>
              <textarea name="note_content" id="id_company_note" class="form-textarea" rows="3"></textarea>
            </div>
          </div>

          <!-- Task attachment -->
          <div id="companyTaskSection" class="attachment-section" style="display: none;">
            <div class="attachment-header">
              <span><i class="fas fa-check-circle"></i> Attach a task</span>
              <button type="button" class="remove-attachment" onclick="toggleAttachment('companyTask')">
                Remove this task
              </button>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 1;">
                <label for="id_company_task_name">Task name</label>
                <input type="text" name="task_name" id="id_company_task_name" class="form-input">
              </div>
              <div class="form-group" style="flex: 1;">
                <label for="id_company_task_due">Due date</label>
                <input type="date" name="task_due_date" id="id_company_task_due" class="form-input">
              </div>
            </div>
            <div class="form-group">
              <label for="id_company_task_desc">Description</label>
              <textarea name="task_description" id="id_company_task_desc" class="form-textarea" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="id_company_task_member">Assign to</label>
              <select name="task_member" id="id_company_task_member" class="form-input">
                {% for member in all_members %}
                <option value="{{ member.id }}" {% if member.user == request.user %}selected{% endif %}>{{ member }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="sidebar-footer">
            <button type="submit" id="companySubmitBtn" class="btn btn-primary">
              <span class="btn-text">Create company</span>
              <span class="btn-spinner" style="display: none;">
                <svg class="spinner-icon" viewBox="0 0 50 50">
                  <circle class="spinner-path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
                </svg>
                Creating...
              </span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeCompanySidebar()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Main Contact Sidebar Modal (From Add Menu) -->
  <div id="mainContactSidebarOverlay" class="sidebar-overlay" onclick="closeMainContactSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeMainContactSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-user"></i>
          <h2>Add a Contact</h2>
        </div>
      </div>
      <div class="sidebar-content">
        <form id="mainContactForm" method="post" onsubmit="submitMainContactForm(event); return false;">
          {% csrf_token %}
          <div class="form-group">
            <label for="id_main_contact_name">Name <span style="color: #ef4444;">*</span></label>
            <input type="text" name="name" id="id_main_contact_name" class="form-input" required autofocus
              hx-get="{% url 'crm:check_contact_duplicate' %}" hx-trigger="keyup changed delay:500ms"
              hx-target="#contact_name_error">
            <div id="contact_name_error"></div>
          </div>

          <div class="form-group">
            <label>Email addresses</label>
            <div id="main_contact_emails_container"></div>
            <input type="hidden" name="emails_data" id="contact_emails_data">
          </div>

          <div class="form-group">
            <label>Phone numbers</label>
            <div id="main_contact_phones_container"></div>
            <input type="hidden" name="phones_data" id="contact_phones_data">
          </div>

          <div class="form-group">
            <label for="id_main_contact_job">Job Title</label>
            <input type="text" name="job_title" id="id_main_contact_job" class="form-input">
          </div>

          <div class="form-group">
            <label for="id_main_contact_address">Address</label>
            <textarea name="address" id="id_main_contact_address" class="form-textarea" rows="2"></textarea>
          </div>

          <!-- Attach an item section -->
          <div class="attach-section">
            <div class="attach-header">
              <i class="fas fa-paperclip"></i>
              <span>Attach an item</span>
            </div>
            <div class="attach-buttons">
              <button type="button" class="attach-btn" onclick="toggleAttachment('mainContactNote')">
                <i class="fas fa-file-text"></i> Note
              </button>
              <button type="button" class="attach-btn" onclick="toggleAttachment('mainContactTask')">
                <i class="fas fa-check-circle"></i> Task
              </button>
            </div>
          </div>

          <!-- Note attachment -->
          <div id="mainContactNoteSection" class="attachment-section" style="display: none;">
            <div class="attachment-header">
              <span><i class="fas fa-file-text"></i> Attach a note</span>
              <button type="button" class="remove-attachment" onclick="toggleAttachment('mainContactNote')">
                Remove this note
              </button>
            </div>
            <div class="form-group">
              <label for="id_main_contact_note">Note</label>
              <textarea name="note_content" id="id_main_contact_note" class="form-textarea" rows="3"></textarea>
            </div>
          </div>

          <!-- Task attachment -->
          <div id="mainContactTaskSection" class="attachment-section" style="display: none;">
            <div class="attachment-header">
              <span><i class="fas fa-check-circle"></i> Attach a task</span>
              <button type="button" class="remove-attachment" onclick="toggleAttachment('mainContactTask')">
                Remove this task
              </button>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 1;">
                <label for="id_main_contact_task_name">Task name</label>
                <input type="text" name="task_name" id="id_main_contact_task_name" class="form-input">
              </div>
              <div class="form-group" style="flex: 1;">
                <label for="id_main_contact_task_due">Due date</label>
                <input type="date" name="task_due_date" id="id_main_contact_task_due" class="form-input">
              </div>
            </div>
            <div class="form-group">
              <label for="id_main_contact_task_desc">Description</label>
              <textarea name="task_description" id="id_main_contact_task_desc" class="form-textarea"
                rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="id_main_contact_task_member">Assign to</label>
              <select name="task_member" id="id_main_contact_task_member" class="form-input">
                {% for member in all_members %}
                <option value="{{ member.id }}" {% if member.user == request.user %}selected{% endif %}>{{ member }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="sidebar-footer">
            <button type="submit" id="mainContactSubmitBtn" class="btn btn-primary">
              <span class="btn-text">Add Contact</span>
              <span class="btn-spinner" style="display: none;">
                <svg class="spinner-icon" viewBox="0 0 50 50">
                  <circle class="spinner-path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
                </svg>
                Creating...
              </span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeMainContactSidebar()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Contact Sidebar Modal (Nested from Company) -->
  <div id="contactSidebarOverlay" class="sidebar-overlay sidebar-nested" onclick="closeContactSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation()">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeContactSidebar()">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <div class="sidebar-title">
          <i class="fas fa-user"></i>
          <h2>Add a Contact</h2>
        </div>
      </div>
      <div class="sidebar-content">
        <form id="contactForm" method="post" onsubmit="submitContactForm(event); return false;">
          {% csrf_token %}
          <div class="form-group">
            <label for="id_contact_name">Name <span style="color: #ef4444;">*</span></label>
            <input type="text" name="name" id="id_contact_name" class="form-input" required autofocus
              hx-get="{% url 'crm:check_contact_duplicate' %}?input_id=id_contact_name"
              hx-trigger="keyup changed delay:500ms" hx-target="#nested_contact_name_error">
            <div id="nested_contact_name_error"></div>
          </div>

          <div class="form-group">
            <label>Email addresses</label>
            <div id="nested_contact_emails_container"></div>
            <input type="hidden" name="emails_data" id="nested_contact_emails_data">
          </div>

          <div class="form-group">
            <label>Phone numbers</label>
            <div id="nested_contact_phones_container"></div>
            <input type="hidden" name="phones_data" id="nested_contact_phones_data">
          </div>

          <div class="form-group">
            <label for="id_contact_job">Job Title</label>
            <input type="text" name="job_title" id="id_contact_job" class="form-input">
          </div>

          <div class="form-group">
            <label for="id_contact_address">Address</label>
            <textarea name="address" id="id_contact_address" class="form-textarea" rows="2"></textarea>
          </div>

          <div class="sidebar-footer">
            <button type="submit" class="btn btn-primary">Add Contact</button>
            <button type="button" class="btn btn-secondary" onclick="closeContactSidebar()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Configure HTMX tCSRF token in all requests
    document.body.addEventListener('htmx:configRequest', (event) => {
      event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
    });

    // Preserve navbar scroll position across page navigations
    (function () {
      const navbar = document.querySelector('.navbar');

      // Restore scroll position if it exists
      const savedScrollPos = sessionStorage.getItem('navbarScrollPos');
      if (savedScrollPos !== null && navbar) {
        navbar.scrollTop = parseInt(savedScrollPos);
        sessionStorage.removeItem('navbarScrollPos');
      }

      // Save scroll position before navigating away
      window.addEventListener('beforeunload', function () {
        if (navbar) {
          sessionStorage.setItem('navbarScrollPos', navbar.scrollTop);
        }
      });
    })();


    // Unified menu system
    document.addEventListener('DOMContentLoaded', function () {
      const addButton = document.getElementById('addButton');
      const addExpanded = document.getElementById('addExpanded');
      const marketingButton = document.getElementById('marketingButton');
      const marketingExpanded = document.getElementById('marketingExpanded');
      const operatingButton = document.getElementById('operatingButton');
      const operatingExpanded = document.getElementById('operatingExpanded');

      // Search overlay functionality
      const searchButton = document.getElementById('searchButton');
      const searchOverlay = document.getElementById('searchOverlay');
      const searchInput = document.getElementById('searchInput');

      if (searchButton && searchOverlay) {
        // Open search overlay when search button is clicked
        searchButton.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          searchOverlay.style.display = 'flex';
          // Focus on search input after a short delay to allow overlay to render
          setTimeout(() => {
            if (searchInput) searchInput.focus();
          }, 100);
        });

        // Close search overlay when clicking outside the overlay content
        searchOverlay.addEventListener('click', function (e) {
          if (e.target === searchOverlay) {
            searchOverlay.style.display = 'none';
            if (searchInput) searchInput.value = '';
          }
        });

        // Close search overlay when pressing ESC key
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape' && searchOverlay.style.display === 'flex') {
            searchOverlay.style.display = 'none';
            if (searchInput) searchInput.value = '';
          }
        });
      }

      let hoverTimeout;
      let marketingHoverTimeout;
      let operatingHoverTimeout;
      let isMenuOpen = false;
      let isMarketingMenuOpen = false;
      let isOperatingMenuOpen = false;

      // TÃ¼m menÃ¼leri kapat (sadece gÃ¶rÃ¼nÃ¼mÃ¼ gizle, bayraklarÄ± dokunma)
      function closeAllMenus(except) {
        if (except !== 'add' && addExpanded) {
          addExpanded.style.display = 'none';
        }
        if (except !== 'marketing' && marketingExpanded) {
          marketingExpanded.style.display = 'none';
        }
        if (except !== 'operating' && operatingExpanded) {
          operatingExpanded.style.display = 'none';
        }
      }

      // Add menu
      if (addButton && addExpanded) {
        addButton.addEventListener('mouseenter', function () {
          clearTimeout(hoverTimeout);
          clearTimeout(marketingHoverTimeout);
          clearTimeout(operatingHoverTimeout);
          closeAllMenus('add');
          // Position menu at button's vertical position
          const rect = addButton.getBoundingClientRect();
          addExpanded.style.top = rect.top + 'px';
          addExpanded.style.display = 'block';
          isMenuOpen = true;
        });

        addExpanded.addEventListener('mouseenter', function () {
          clearTimeout(hoverTimeout);
          isMenuOpen = true;
        });

        addButton.addEventListener('mouseleave', function () {
          isMenuOpen = false;
          hoverTimeout = setTimeout(function () {
            if (!isMenuOpen) {
              addExpanded.style.display = 'none';
            }
          }, 150);
        });

        addExpanded.addEventListener('mouseleave', function () {
          isMenuOpen = false;
          hoverTimeout = setTimeout(function () {
            addExpanded.style.display = 'none';
          }, 150);
        });
      }

      // Marketing menu
      if (marketingButton && marketingExpanded) {
        marketingButton.addEventListener('mouseenter', function () {
          clearTimeout(hoverTimeout);
          clearTimeout(marketingHoverTimeout);
          clearTimeout(operatingHoverTimeout);
          closeAllMenus('marketing');
          // Position menu at button's vertical position with offset
          const rect = marketingButton.getBoundingClientRect();
          const offset = 80; // Move menu up by 80px
          marketingExpanded.style.top = (rect.top - offset) + 'px';
          marketingExpanded.style.display = 'block';
          isMarketingMenuOpen = true;
        });

        marketingExpanded.addEventListener('mouseenter', function () {
          clearTimeout(marketingHoverTimeout);
          isMarketingMenuOpen = true;
        });

        marketingButton.addEventListener('mouseleave', function () {
          isMarketingMenuOpen = false;
          marketingHoverTimeout = setTimeout(function () {
            if (!isMarketingMenuOpen) {
              marketingExpanded.style.display = 'none';
            }
          }, 150);
        });

        marketingExpanded.addEventListener('mouseleave', function () {
          isMarketingMenuOpen = false;
          marketingHoverTimeout = setTimeout(function () {
            marketingExpanded.style.display = 'none';
          }, 150);
        });
      }

      // Operating menu
      if (operatingButton && operatingExpanded) {
        operatingButton.addEventListener('mouseenter', function () {
          clearTimeout(hoverTimeout);
          clearTimeout(marketingHoverTimeout);
          clearTimeout(operatingHoverTimeout);
          closeAllMenus('operating');
          // Position menu at button's vertical position with offset
          const rect = operatingButton.getBoundingClientRect();
          const offset = 290; // Move menu up by 290px
          operatingExpanded.style.top = (rect.top - offset) + 'px';
          operatingExpanded.style.display = 'block';
          isOperatingMenuOpen = true;
        });

        operatingExpanded.addEventListener('mouseenter', function () {
          clearTimeout(operatingHoverTimeout);
          isOperatingMenuOpen = true;
        });

        operatingButton.addEventListener('mouseleave', function () {
          isOperatingMenuOpen = false;
          operatingHoverTimeout = setTimeout(function () {
            if (!isOperatingMenuOpen) {
              operatingExpanded.style.display = 'none';
            }
          }, 150);
        });

        operatingExpanded.addEventListener('mouseleave', function () {
          isOperatingMenuOpen = false;
          operatingHoverTimeout = setTimeout(function () {
            operatingExpanded.style.display = 'none';
          }, 150);
        });
      }

      // Set today's date on page load
      const today = new Date().toISOString().split('T')[0];
      const dueDateField = document.getElementById('id_due_date');
      if (dueDateField) {
        dueDateField.value = today;
      }
    });

    function openTaskSidebar() {
      document.getElementById('taskSidebarOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
      // Set today's date again
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('id_due_date').value = today;
      // Initialize form tracking
      setTimeout(() => {
        initializeFormTracking('taskForm');
        document.getElementById('id_name').focus();
      }, 300);
    }

    // Original close function (without checks)
    function _closeTaskSidebarOriginal() {
      document.getElementById('taskSidebarOverlay').classList.remove('active');
      document.body.style.overflow = '';
      // Reset form
      document.getElementById('taskForm').reset();
      // Hide all attachment sections
      document.getElementById('taskCompanySection').style.display = 'none';
      document.getElementById('taskContactSection').style.display = 'none';
      // Clear hidden fields
      document.getElementById('id_company').value = '';
      document.getElementById('id_contact').value = '';
      resetFormTracking();
    }

    // Wrapped close function (with unsaved changes check)
    const closeTaskSidebar = function () {
      // Don't show modal if form is being submitted
      const isSubmitting = window.formChangeTracker && window.formChangeTracker.isSubmitting && window.formChangeTracker.isSubmitting();

      if (!isSubmitting && window.formChangeTracker && window.formChangeTracker.hasChanges && window.formChangeTracker.hasChanges()) {
        window.showUnsavedChangesModal(
          () => _closeTaskSidebarOriginal(),
          () => { }
        );
      } else {
        _closeTaskSidebarOriginal();
      }
    };

    // Company Modal Functions
    function openCompanySidebar() {
      document.getElementById('companySidebarOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
      // Initialize dynamic email/phone fields
      initDynamicFields('company_emails_container', 'emails_data', 'email', []);
      initDynamicFields('company_phones_container', 'phones_data', 'phone', []);
      // Set today's date for task
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('id_company_task_due').value = today;
      // Initialize form tracking and focus
      setTimeout(() => {
        initializeFormTracking('companyForm');
        document.getElementById('id_company_name').focus();
      }, 300);
    }

    function submitCompanyForm(event) {
      event.preventDefault();
      if (window.formChangeTracker) window.formChangeTracker.setSubmitting();
      const form = document.getElementById('companyForm');
      const submitBtn = document.getElementById('companySubmitBtn');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnSpinner = submitBtn.querySelector('.btn-spinner');
      const toast = document.getElementById('toastNotification');
      const toastMessage = toast.querySelector('.toast-message-global');

      // Show loading state
      btnText.style.display = 'none';
      btnSpinner.style.display = 'inline-flex';
      submitBtn.disabled = true;

      const formData = new FormData(form);

      fetch('{% url "crm:create_company" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success toast
            toastMessage.textContent = `Company "${data.company_name || ''}" created successfully!`;
            toast.classList.add('show');

            // Hide toast after 3 seconds
            setTimeout(() => {
              toast.classList.remove('show');
            }, 3000);

            // Close sidebar
            closeCompanySidebar();

            // Redirect after short delay
            setTimeout(() => {
              if (data.redirect_url) {
                window.location.href = data.redirect_url;
              }
            }, 800);
          } else {
            // Reset button
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
            submitBtn.disabled = false;
            // Show errors
            alert('Error: ' + (data.error || 'Failed to create company'));
          }
        })
        .catch(error => {
          // Reset button
          btnText.style.display = 'inline';
          btnSpinner.style.display = 'none';
          submitBtn.disabled = false;
          console.error('Error:', error);
          alert('An error occurred while creating the company.');
        });
    }

    // Original close function
    function _closeCompanySidebarOriginal() {
      document.getElementById('companySidebarOverlay').classList.remove('active');
      document.body.style.overflow = '';
      // Reset form
      document.getElementById('companyForm').reset();
      // Hide all attachment sections
      document.getElementById('companyContactSection').style.display = 'none';
      document.getElementById('companyNoteSection').style.display = 'none';
      document.getElementById('companyTaskSection').style.display = 'none';
      // Clear contact selection
      removeCompanyContact();
      resetFormTracking();
    }

    // Wrapped close function
    const closeCompanySidebar = function () {
      // Don't show modal if form is being submitted
      const isSubmitting = window.formChangeTracker && window.formChangeTracker.isSubmitting && window.formChangeTracker.isSubmitting();

      if (!isSubmitting && window.formChangeTracker && window.formChangeTracker.hasChanges && window.formChangeTracker.hasChanges()) {
        window.showUnsavedChangesModal(
          () => _closeCompanySidebarOriginal(),
          () => { }
        );
      } else {
        _closeCompanySidebarOriginal();
      }
    };

    // Main Contact Sidebar Functions
    function openMainContactSidebar() {
      document.getElementById('mainContactSidebarOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
      // Initialize dynamic email/phone fields
      initDynamicFields('main_contact_emails_container', 'contact_emails_data', 'email', []);
      initDynamicFields('main_contact_phones_container', 'contact_phones_data', 'phone', []);
      // Set today's date for task
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('id_main_contact_task_due').value = today;
      // Initialize form tracking and focus
      setTimeout(() => {
        initializeFormTracking('mainContactForm');
        document.getElementById('id_main_contact_name').focus();
      }, 300);
    }

    // Original close function
    function _closeMainContactSidebarOriginal() {
      document.getElementById('mainContactSidebarOverlay').classList.remove('active');
      document.body.style.overflow = '';
      // Reset form
      document.getElementById('mainContactForm').reset();
      // Hide all attachment sections
      document.getElementById('mainContactNoteSection').style.display = 'none';
      document.getElementById('mainContactTaskSection').style.display = 'none';
      resetFormTracking();
    }

    // Wrapped close function
    const closeMainContactSidebar = function () {
      // Don't show modal if form is being submitted
      const isSubmitting = window.formChangeTracker && window.formChangeTracker.isSubmitting && window.formChangeTracker.isSubmitting();

      if (!isSubmitting && window.formChangeTracker && window.formChangeTracker.hasChanges && window.formChangeTracker.hasChanges()) {
        window.showUnsavedChangesModal(
          () => _closeMainContactSidebarOriginal(),
          () => { }
        );
      } else {
        _closeMainContactSidebarOriginal();
      }
    };

    // Product Sidebar Functions
    function openProductSidebar() {
      document.getElementById('productSidebarOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
      // Initialize variant system
      setTimeout(() => {
        initVariantSystem();
        document.getElementById('id_product_title').focus();
      }, 300);
    }

    function closeProductSidebar() {
      document.getElementById('productSidebarOverlay').classList.remove('active');
      document.body.style.overflow = '';
      document.getElementById('productForm').reset();
      // Reset variant system
      variantOptionCount = 0;
      for (let key in variantOptions) {
        delete variantOptions[key];
      }
      document.getElementById('variant_options_container').innerHTML = '';
      document.getElementById('variant_table_container').innerHTML = '';
      document.getElementById('variant_section').style.display = 'none';
    }

    function submitProductForm(event) {
      event.preventDefault();
      if (window.formChangeTracker) window.formChangeTracker.setSubmitting();
      const form = document.getElementById('productForm');
      const formData = new FormData(form);

      fetch('{% url "marketing:product_create" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            closeProductSidebar();
            if (data.redirect_url) {
              window.location.href = data.redirect_url;
            }
          } else {
            alert('Error: ' + (data.errors || 'Failed to create product'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while creating the product.');
        });
    }

    function submitMainContactForm(event) {
      event.preventDefault();
      if (window.formChangeTracker) window.formChangeTracker.setSubmitting();
      const form = document.getElementById('mainContactForm');
      const submitBtn = document.getElementById('mainContactSubmitBtn');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnSpinner = submitBtn.querySelector('.btn-spinner');
      const toast = document.getElementById('toastNotification');
      const toastMessage = toast.querySelector('.toast-message-global');

      // Show loading state
      btnText.style.display = 'none';
      btnSpinner.style.display = 'inline-flex';
      submitBtn.disabled = true;

      const formData = new FormData(form);

      fetch('{% url "crm:create_contact" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success toast
            toastMessage.textContent = `Contact "${data.contact.name || ''}" created successfully!`;
            toast.classList.add('show');

            // Hide toast after 3 seconds
            setTimeout(() => {
              toast.classList.remove('show');
            }, 3000);

            // Close sidebar
            closeMainContactSidebar();

            // Redirect to contact detail page
            setTimeout(() => {
              if (data.redirect_url) {
                window.location.href = data.redirect_url;
              }
            }, 800);
          } else {
            // Reset button
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
            submitBtn.disabled = false;
            // Show errors
            alert('Error: ' + (data.errors || 'Failed to create contact'));
          }
        })
        .catch(error => {
          // Reset button
          btnText.style.display = 'inline';
          btnSpinner.style.display = 'none';
          submitBtn.disabled = false;
          console.error('Error:', error);
          alert('An error occurred while creating the contact.');
        });
    }

    // Dynamic Email/Phone Management
    function initDynamicFields(containerId, hiddenFieldId, type, existingData = []) {
      const container = document.getElementById(containerId);
      if (!container) return;

      container.innerHTML = '';
      container.className = 'dynamic-field-container';

      // Add existing data
      if (existingData && existingData.length > 0) {
        existingData.forEach((value, index) => {
          addDynamicField(containerId, hiddenFieldId, type, value, index);
        });
      } else {
        // Add first empty field with + button
        addDynamicField(containerId, hiddenFieldId, type, '', 0);
      }
    }

    function addDynamicField(containerId, hiddenFieldId, type, value = '', index = null) {
      const container = document.getElementById(containerId);
      if (!container) return;

      // Get actual field count (exclude the + button)
      const fieldCount = container.querySelectorAll('.dynamic-field-wrapper').length;
      const placeholder = type === 'email' ? 'email@example.com' : '+1234567890';

      const fieldWrapper = document.createElement('div');
      fieldWrapper.className = 'dynamic-field-wrapper';

      // Create input wrapper
      const inputWrapper = document.createElement('div');
      inputWrapper.className = 'dynamic-field-input-wrapper';
      inputWrapper.innerHTML = `
          <input 
            type="${type === 'email' ? 'email' : 'text'}" 
            class="dynamic-field-input" 
            placeholder="${placeholder}" 
            value="${value}"
            onchange="updateHiddenField('${containerId}', '${hiddenFieldId}')"
          />
        `;

      fieldWrapper.appendChild(inputWrapper);

      // Create button
      const button = document.createElement('button');
      button.type = 'button';

      if (fieldCount === 0) {
        // First field has + button
        button.className = 'btn-add-field';
        button.innerHTML = '<i class="fas fa-plus"></i>';
        button.onclick = () => addDynamicField(containerId, hiddenFieldId, type);
        button.title = `Add ${type}`;
      } else {
        // Other fields have - button
        button.className = 'btn-remove-field';
        button.innerHTML = '<i class="fas fa-minus"></i>';
        button.onclick = () => removeDynamicField(button, containerId, hiddenFieldId);
        button.title = `Remove ${type}`;
      }

      fieldWrapper.appendChild(button);

      container.appendChild(fieldWrapper);

      // Update hidden field
      updateHiddenField(containerId, hiddenFieldId);
    }

    function removeDynamicField(button, containerId, hiddenFieldId) {
      const wrapper = button.closest('.dynamic-field-wrapper');
      wrapper.remove();
      updateHiddenField(containerId, hiddenFieldId);
    }

    function updateHiddenField(containerId, hiddenFieldId) {
      const container = document.getElementById(containerId);
      const hiddenField = document.getElementById(hiddenFieldId);
      if (!container || !hiddenField) return;

      const values = [];
      container.querySelectorAll('.dynamic-field-input').forEach(input => {
        const val = input.value.trim();
        if (val) values.push(val);
      });

      hiddenField.value = JSON.stringify(values);
    }

    // Toggle attachment sections
    function toggleAttachment(type) {
      const sections = {
        'mainContactNote': 'mainContactNoteSection',
        'mainContactTask': 'mainContactTaskSection',
        'companyContact': 'companyContactSection',
        'companyNote': 'companyNoteSection',
        'companyTask': 'companyTaskSection',
        'taskCompany': 'taskCompanySection',
        'taskContact': 'taskContactSection'
      };

      const sectionId = sections[type];
      const section = document.getElementById(sectionId);

      if (section.style.display === 'none') {
        section.style.display = 'block';
        // Set focus to first input in the section
        setTimeout(() => {
          const firstInput = section.querySelector('input, textarea');
          if (firstInput) firstInput.focus();
        }, 100);
      } else {
        section.style.display = 'none';
        // Clear fields
        section.querySelectorAll('input, textarea').forEach(input => {
          input.value = '';
        });
        // Clear contact selection
        if (type === 'companyContact') {
          removeCompanyContact();
        }
      }
    }

    // Company Contact Selector
    let companyContactSearchTimeout = null;
    const companyContactSearch = document.getElementById('company_contact_search');
    const companyContactResults = document.getElementById('company_contact_results');
    const companySelectedContact = document.getElementById('company_selected_contact');
    const companyContactId = document.getElementById('company_contact_id');

    if (companyContactSearch) {
      companyContactSearch.addEventListener('input', function () {
        clearTimeout(companyContactSearchTimeout);
        const query = this.value.trim();

        if (query.length < 1) {
          companyContactResults.classList.remove('active');
          companyContactResults.innerHTML = '';
          return;
        }

        companyContactSearchTimeout = setTimeout(() => {
          fetch(`/crm/search_contacts_only/?search_term=${encodeURIComponent(query)}`)
            .then(response => response.text())
            .then(html => {
              companyContactResults.innerHTML = html;
              companyContactResults.classList.add('active');

              // Add click handlers to results
              document.querySelectorAll('#company_contact_results .contact-result-item').forEach(item => {
                item.addEventListener('click', function () {
                  selectCompanyContact(
                    this.dataset.contactId,
                    this.dataset.contactName,
                    this.dataset.contactEmail,
                    this.dataset.contactCompany
                  );
                });
              });
            })
            .catch(error => {
              console.error('Error searching contacts:', error);
            });
        }, 200);
      });
    }

    function selectCompanyContact(id, name, email, company) {
      companyContactId.value = id;
      companyContactSearch.value = '';
      companyContactResults.classList.remove('active');
      companyContactResults.innerHTML = '';

      companySelectedContact.innerHTML = `
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: #111827; font-size: 15px;">${name}</div>
            <div style="font-size: 13px; color: #6b7280; margin-top: 2px;">${email}${company ? ' â€¢ ' + company : ''}</div>
          </div>
          <button type="button" style="
            padding: 6px 12px;
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
          " onclick="removeCompanyContact()" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='#fef2f2'">
            <i class="fas fa-times"></i>
            Remove
          </button>
        `;
      companySelectedContact.classList.add('active');
    }

    function removeCompanyContact() {
      companyContactId.value = '';
      companySelectedContact.classList.remove('active');
      companySelectedContact.innerHTML = '';
    }

    // Contact Sidebar Functions (Nested from Company)
    function openContactSidebarFromCompany() {
      document.getElementById('contactSidebarOverlay').classList.add('active');
      // Initialize dynamic email/phone fields
      initDynamicFields('nested_contact_emails_container', 'nested_contact_emails_data', 'email', []);
      initDynamicFields('nested_contact_phones_container', 'nested_contact_phones_data', 'phone', []);
      // Don't hide body overflow - keep company sidebar visible underneath
      setTimeout(() => {
        document.getElementById('id_contact_name').focus();
      }, 300);
    }

    function closeContactSidebar() {
      document.getElementById('contactSidebarOverlay').classList.remove('active');
      // Reset form
      document.getElementById('contactForm').reset();
    }

    function submitContactForm(event) {
      event.preventDefault();
      if (window.formChangeTracker) window.formChangeTracker.setSubmitting();
      const form = document.getElementById('contactForm');
      const formData = new FormData(form);

      fetch('{% url "crm:create_contact" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.contact) {
            // Close contact sidebar
            closeContactSidebar();

            // Auto-select the newly created contact in company form
            selectCompanyContact(
              data.contact.id,
              data.contact.name,
              data.contact.email || '',
              data.contact.company_name || ''
            );

            // Show success message
            alert('Contact created successfully!');
          } else {
            // Show errors
            alert('Error: ' + (data.errors || 'Failed to create contact'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while creating the contact.');
        });
    }

    // Company and Contact selection functions for task sidebar
    function selectCompany(name, pk) {
      // Check if we're in task sidebar or contact form
      const taskCompanySearch = document.getElementById('id_task_company_search');
      const contactCompanyName = document.getElementById('company_name');

      if (taskCompanySearch) {
        taskCompanySearch.value = name;
        document.getElementById('id_company').value = pk;
        document.getElementById('taskCompanyResults').innerHTML = '';
      } else if (contactCompanyName) {
        contactCompanyName.value = name;
        document.getElementById('company-suggestions').innerHTML = '';
      }
    }

    function selectContact(name, pk) {
      document.getElementById('id_task_contact_search').value = name;
      document.getElementById('id_contact').value = pk;
      document.getElementById('taskContactResults').innerHTML = '';
    }

    // Close on Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        // Close nested sidebar first if open
        if (document.getElementById('contactSidebarOverlay').classList.contains('active')) {
          closeContactSidebar();
        } else {
          closeTaskSidebar();
          closeCompanySidebar();
        }
      }
    });

    // ====================================
    // UNSAVED CHANGES HANDLER - INLINE
    // ====================================

    // Track form changes
    let formHasChanges = false;
    let currentFormId = null;
    let isSubmitting = false;

    // Initialize tracking when form is opened
    function initializeFormTracking(formId) {
      formHasChanges = false;
      currentFormId = formId;
      isSubmitting = false;

      const form = document.getElementById(formId);
      if (!form) return;

      // Track all input changes
      const inputs = form.querySelectorAll('input, textarea, select');
      inputs.forEach(input => {
        // Store initial value
        input.dataset.initialValue = input.value || '';

        // Listen for changes
        input.addEventListener('input', () => {
          formHasChanges = true;
        });

        input.addEventListener('change', () => {
          formHasChanges = true;
        });
      });

      // Track form submission
      form.addEventListener('submit', () => {
        isSubmitting = true;
      });
    }

    // Reset form tracking
    function resetFormTracking() {
      formHasChanges = false;
      currentFormId = null;
      isSubmitting = false;
    }

    // Show unsaved changes modal
    function showUnsavedChangesModal(onDiscard, onReturn) {
      // Create modal overlay
      const overlay = document.createElement('div');
      overlay.className = 'unsaved-changes-overlay';
      overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(4px);
          z-index: 10001;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.2s ease;
        `;

      // Create modal dialog
      const dialog = document.createElement('div');
      dialog.className = 'unsaved-changes-dialog';
      dialog.style.cssText = `
          background: white;
          border-radius: 16px;
          max-width: 480px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: slideUp 0.3s ease;
          overflow: hidden;
        `;

      dialog.innerHTML = `
          <div style="padding: 32px;">
            <div style="text-align: center; margin-bottom: 24px;">
              <div style="width: 64px; height: 64px; margin: 0 auto 16px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 28px; color: #f59e0b;"></i>
              </div>
              <h3 style="margin: 0 0 12px; font-size: 20px; font-weight: 700; color: #111827;">
                You have unsaved data!
              </h3>
              <p style="margin: 0; font-size: 15px; color: #6b7280; line-height: 1.6;">
                The form you just closed had unsaved changes. Are you sure you want to close the form and discard the changes?
              </p>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: center;">
              <button 
                type="button"
                class="btn-return-to-form"
                style="
                  flex: 1;
                  padding: 12px 24px;
                  background: #3b82f6;
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 15px;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='#2563eb'"
                onmouseout="this.style.background='#3b82f6'">
                Return to the form
              </button>
              
              <button 
                type="button"
                class="btn-discard-changes"
                style="
                  flex: 1;
                  padding: 12px 24px;
                  background: #f3f4f6;
                  color: #374151;
                  border: none;
                  border-radius: 8px;
                  font-size: 15px;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='#e5e7eb'"
                onmouseout="this.style.background='#f3f4f6'">
                Discard changes
              </button>
            </div>
          </div>
        `;

      overlay.appendChild(dialog);
      document.body.appendChild(overlay);

      // Add event listeners
      const btnReturn = dialog.querySelector('.btn-return-to-form');
      const btnDiscard = dialog.querySelector('.btn-discard-changes');

      btnReturn.addEventListener('click', () => {
        overlay.remove();
        if (onReturn) onReturn();
      });

      btnDiscard.addEventListener('click', () => {
        overlay.remove();
        resetFormTracking();
        if (onDiscard) onDiscard();
      });

      // Close on Escape key
      const escapeHandler = (e) => {
        if (e.key === 'Escape') {
          overlay.remove();
          if (onReturn) onReturn();
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);

      // Add animation styles if not present
      if (!document.getElementById('unsaved-changes-animations')) {
        const style = document.createElement('style');
        style.id = 'unsaved-changes-animations';
        style.textContent = `
            @keyframes fadeIn {
              from { opacity: 0; }
              to { opacity: 1; }
            }
            @keyframes slideUp {
              from { 
                opacity: 0;
                transform: translateY(20px) scale(0.95);
              }
              to { 
                opacity: 1;
                transform: translateY(0) scale(1);
              }
            }
          `;
        document.head.appendChild(style);
      }
    }

    // Export to window object
    window.formChangeTracker = {
      hasChanges: () => formHasChanges,
      isSubmitting: () => isSubmitting,
      setSubmitting: () => { isSubmitting = true; },
      reset: resetFormTracking
    };

    // ====================================
    // END UNSAVED CHANGES HANDLER
    // ====================================

    // Product Variant System
    let variantOptionCount = 0;
    const variantOptions = {};

    // Initialize variant checkbox listener when DOM is ready
    function initVariantSystem() {
      const hasVariantsCheckbox = document.getElementById('id_has_variants');
      if (hasVariantsCheckbox) {
        hasVariantsCheckbox.addEventListener('change', function () {
          const variantSection = document.getElementById('variant_section');
          if (this.checked) {
            variantSection.style.display = 'block';
            if (variantOptionCount === 0) {
              addVariantOption();
            }
          } else {
            variantSection.style.display = 'none';
          }
        });
      }
    }

    function addVariantOption() {
      variantOptionCount++;
      const optionId = variantOptionCount;
      variantOptions[optionId] = { name: '', values: [] };

      const container = document.getElementById('variant_options_container');
      const optionCard = document.createElement('div');
      optionCard.className = 'variant-option-card';
      optionCard.id = `variant_option_${optionId}`;
      optionCard.style.cssText = 'background: #f9fafb; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #e5e7eb;';

      optionCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label style="margin: 0; font-weight: 500;">Option Name</label>
            <button type="button" onclick="removeVariantOption(${optionId})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <input type="text" 
                 class="form-input" 
                 placeholder="e.g. Color, Size" 
                 onchange="updateVariantOptionName(${optionId}, this.value)"
                 style="margin-bottom: 10px;">
          <label style="margin-bottom: 5px; display: block; font-weight: 500;">Option Values</label>
          <div id="option_values_${optionId}"></div>
          <button type="button" 
                  class="btn btn-secondary" 
                  onclick="addVariantValue(${optionId})" 
                  style="margin-top: 8px; font-size: 12px; padding: 5px 10px;">
            + Add Value
          </button>
        `;

      container.appendChild(optionCard);
      addVariantValue(optionId);
      addVariantValue(optionId);
    }

    function removeVariantOption(optionId) {
      delete variantOptions[optionId];
      document.getElementById(`variant_option_${optionId}`).remove();
    }

    function addVariantValue(optionId) {
      const valueId = variantOptions[optionId].values.length;
      const container = document.getElementById(`option_values_${optionId}`);

      const valueWrapper = document.createElement('div');
      valueWrapper.id = `option_value_${optionId}_${valueId}`;
      valueWrapper.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';

      valueWrapper.innerHTML = `
          <input type="text" 
                 class="form-input" 
                 placeholder="Value ${valueId + 1}" 
                 onchange="updateVariantValue(${optionId}, ${valueId}, this.value)"
                 style="flex: 1;">
          <button type="button" 
                  onclick="removeVariantValue(${optionId}, ${valueId})" 
                  style="background: #fef2f2; border: 1px solid #fca5a5; color: #dc2626; border-radius: 6px; padding: 0 10px; cursor: pointer;">
            <i class="fas fa-minus"></i>
          </button>
        `;

      container.appendChild(valueWrapper);
      variantOptions[optionId].values.push('');
    }

    function removeVariantValue(optionId, valueId) {
      document.getElementById(`option_value_${optionId}_${valueId}`).remove();
    }

    function updateVariantOptionName(optionId, name) {
      variantOptions[optionId].name = name;
    }

    function updateVariantValue(optionId, valueId, value) {
      variantOptions[optionId].values[valueId] = value;
    }

    function generateVariantTable() {
      const validOptions = [];
      for (const optionId in variantOptions) {
        const option = variantOptions[optionId];
        if (option.name && option.values.filter(v => v).length > 0) {
          validOptions.push({
            name: option.name,
            values: option.values.filter(v => v)
          });
        }
      }

      if (validOptions.length === 0) {
        alert('Please add at least one option with values');
        return;
      }

      const combinations = generateCombinations(validOptions);
      const container = document.getElementById('variant_table_container');

      let tableHTML = `
          <div style="overflow-x: auto; max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead style="position: sticky; top: 0; background: #f3f4f6; z-index: 10;">
                <tr>`;

      validOptions.forEach(opt => {
        tableHTML += `<th style="padding: 6px 8px; text-align: left; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">${opt.name}</th>`;
      });

      tableHTML += `
                  <th style="padding: 6px 8px; text-align: left; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">Photo</th>
                  <th style="padding: 6px 8px; text-align: center; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">Primary</th>
                  <th style="padding: 6px 8px; text-align: left; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">Price</th>
                  <th style="padding: 6px 8px; text-align: left; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">Qty</th>
                  <th style="padding: 6px 8px; text-align: left; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">SKU</th>
                  <th style="padding: 6px 8px; text-align: left; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">Barcode</th>
                  <th style="padding: 6px 8px; text-align: center; border: 1px solid #e5e7eb; white-space: nowrap; font-weight: 600;">Featured</th>
                </tr>
              </thead>
              <tbody>`;

      combinations.forEach((combo, index) => {
        tableHTML += '<tr style="background: ' + (index % 2 === 0 ? '#ffffff' : '#f9fafb') + ';">';
        combo.forEach(value => {
          tableHTML += `<td style="padding: 4px 6px; border: 1px solid #e5e7eb; white-space: nowrap; font-size: 11px;">${value}</td>`;
        });
        tableHTML += `
            <td style="padding: 4px 6px; border: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                <span id="primary_badge_${index}" style="display: ${index === 0 ? 'inline-block' : 'none'}; background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; border-radius: 8px; font-size: 9px; padding: 2px 5px; font-weight: 600;">PRIMARY</span>
                <input type="file" name="variant_photo_${index}" accept="image/*" style="font-size: 10px; padding: 2px; width: 85px;">
              </div>
            </td>
            <td style="padding: 4px 6px; border: 1px solid #e5e7eb; text-align: center;">
              <input type="radio" name="primary_variant_image" value="${index}" ${index === 0 ? 'checked' : ''} onchange="updatePrimaryBadges()" style="cursor: pointer;" title="Set as primary image">
            </td>
            <td style="padding: 4px 6px; border: 1px solid #e5e7eb;">
              <input type="number" name="variant_price_${index}" step="0.01" placeholder="0.00" style="width: 60px; padding: 4px; font-size: 11px; border: 1px solid #d1d5db; border-radius: 4px;">
            </td>
            <td style="padding: 4px 6px; border: 1px solid #e5e7eb;">
              <input type="number" name="variant_quantity_${index}" step="0.01" placeholder="0" style="width: 50px; padding: 4px; font-size: 11px; border: 1px solid #d1d5db; border-radius: 4px;">
            </td>
            <td style="padding: 4px 6px; border: 1px solid #e5e7eb;">
              <input type="text" name="variant_sku_${index}" placeholder="SKU" style="width: 80px; padding: 4px; font-size: 11px; border: 1px solid #d1d5db; border-radius: 4px;">
            </td>
            <td style="padding: 4px 6px; border: 1px solid #e5e7eb;">
              <input type="text" name="variant_barcode_${index}" placeholder="Barcode" style="width: 80px; padding: 4px; font-size: 11px; border: 1px solid #d1d5db; border-radius: 4px;">
            </td>
            <td style="padding: 4px 6px; border: 1px solid #e5e7eb; text-align: center;">
              <input type="checkbox" name="variant_featured_${index}" checked style="cursor: pointer;">
            </td>
          </tr>`;
      });

      tableHTML += '</tbody></table></div>';
      container.innerHTML = tableHTML;
    }

    function updatePrimaryBadges() {
      // Hide all primary badges
      document.querySelectorAll('[id^="primary_badge_"]').forEach(badge => {
        badge.style.display = 'none';
      });

      // Show badge for selected primary
      const selectedRadio = document.querySelector('input[name="primary_variant_image"]:checked');
      if (selectedRadio) {
        const badge = document.getElementById(`primary_badge_${selectedRadio.value}`);
        if (badge) {
          badge.style.display = 'inline-block';
        }
      }
    }

    function generateCombinations(options, current = [], index = 0) {
      if (index === options.length) {
        return [current];
      }

      const results = [];
      const option = options[index];

      option.values.forEach(value => {
        results.push(...generateCombinations(options, [...current, value], index + 1));
      });

      return results;
    }
  </script>

  <!-- Task Edit Sidebar Modal -->
  {% include 'todo/components/task_edit_modal.html' %}

  <!-- Raw Material Sidebar Modal -->
  <div id="rawMaterialSidebarOverlay" class="sidebar-overlay" onclick="closeRawMaterialSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeRawMaterialSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-cube"></i>
          <h2>Add Raw Material</h2>
        </div>
      </div>
      <div class="sidebar-content">
        <form id="rawMaterialForm" method="post" onsubmit="submitRawMaterialForm(event); return false;"
          enctype="multipart/form-data">
          {% csrf_token %}

          <div class="form-group">
            <label for="id_rm_name">Name <span style="color: #ef4444;">*</span></label>
            <input type="text" name="name" id="id_rm_name" class="form-input" required autofocus>
          </div>

          <div class="form-group">
            <label for="id_rm_sku">SKU (Optional)</label>
            <input type="text" name="sku" id="id_rm_sku" class="form-input" placeholder="Leave empty to auto-generate">
            <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">Will be auto-generated if
              left empty.</small>
          </div>

          <div class="form-group">
            <label for="id_rm_supplier_sku">Supplier SKU</label>
            <input type="text" name="supplier_sku" id="id_rm_supplier_sku" class="form-input">
          </div>

          <div class="form-group">
            <label for="id_rm_type">Type</label>
            <select name="raw_type" id="id_rm_type" class="form-input">
              <option value="direct" selected>Direct (Production)</option>
              <option value="indirect">Indirect (Overhead)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="id_rm_unit">Unit of Measurement</label>
            <select name="unit_of_measurement" id="id_rm_unit" class="form-input">
              <option value="units" selected>Unit</option>
              <option value="mt">Meter</option>
              <option value="kg">Kilogram</option>
              <option value="l">Liter</option>
              <option value="bx">Box</option>
            </select>
          </div>

          <div class="form-group">
            <label for="id_rm_quantity">Initial Quantity</label>
            <input type="number" name="quantity" id="id_rm_quantity" class="form-input" step="0.01" value="0">
          </div>

          <div class="sidebar-footer">
            <button type="submit" id="rmSubmitBtn" class="btn btn-primary">
              <span class="btn-text">Create Raw Material</span>
              <span class="btn-spinner" style="display: none;">
                <svg class="spinner-icon" viewBox="0 0 50 50">
                  <circle class="spinner-path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
                </svg>
                Creating...
              </span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeRawMaterialSidebar()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Raw Material Receipt Sidebar Modal -->
  <div id="rawMaterialReceiptSidebarOverlay" class="sidebar-overlay" onclick="closeRawMaterialReceiptSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeRawMaterialReceiptSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fa-solid fa-file-lines"></i>
          <h2>Add Receipt</h2>
        </div>
      </div>
      <div class="sidebar-content" id="rawMaterialReceiptSidebarContent">
        <!-- HTMX target -->
      </div>
    </div>
  </div>
  </div>
  </div>

  <!-- Raw Material Item Sidebar Modal -->
  <div id="rawMaterialItemSidebarOverlay" class="sidebar-overlay" onclick="closeRawMaterialItemSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeRawMaterialItemSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-plus-square"></i>
          <h2>Add Item to Receipt</h2>
        </div>
      </div>
      <div class="sidebar-content" id="rawMaterialItemSidebarContent">
        <!-- HTMX target -->
      </div>
    </div>
  </div>
  </div>
  </div>

  <!-- Order Sidebar Modal -->
  <div id="orderSidebarOverlay" class="sidebar-overlay" onclick="closeOrderSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeOrderSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-shopping-cart"></i>
          <h2>Create Order</h2>
        </div>
      </div>
      <div class="sidebar-content" id="orderSidebarContent">
        <!-- HTMX loading target -->
      </div>
    </div>
  </div>

  <!-- Book Sidebar Modal -->
  <div id="bookSidebarOverlay" class="sidebar-overlay" onclick="closeBookSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeBookSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-book"></i>
          <h2>Create Book</h2>
        </div>
      </div>
      <div class="sidebar-content" id="bookSidebarContent">
        <!-- HTMX loading target -->
      </div>
    </div>
  </div>

  <!-- Add Capital Sidebar Modal -->
  <div id="addCapitalSidebarOverlay" class="sidebar-overlay" onclick="closeAddCapitalSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeAddCapitalSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-coins text-success"></i>
          <h2>Add Equity Capital</h2>
        </div>
      </div>
      <div class="sidebar-content" id="addCapitalSidebarContent">
        <!-- HTMX loading target -->
      </div>
    </div>
  </div>

  <div id="addRevenueSidebarOverlay" class="sidebar-overlay" onclick="closeAddRevenueSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeAddRevenueSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-arrow-up text-success"></i>
          <h2>Add Equity Revenue</h2>
        </div>
      </div>
      <div class="sidebar-content" id="addRevenueSidebarContent">
        <!-- HTMX loading target -->
      </div>
    </div>
  </div>

  <div id="addExpenseSidebarOverlay" class="sidebar-overlay" onclick="closeAddExpenseSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeAddExpenseSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-arrow-down text-danger"></i>
          <h2>Add Equity Expense</h2>
        </div>
      </div>
      <div class="sidebar-content" id="addExpenseSidebarContent">
        <!-- HTMX loading target -->
      </div>
    </div>
  </div>

  <div id="addDividendSidebarOverlay" class="sidebar-overlay" onclick="closeAddDividendSidebar()">
    <div class="sidebar-modal" onclick="event.stopPropagation();">
      <div class="sidebar-header">
        <button class="sidebar-close" onclick="closeAddDividendSidebar()">
          <i class="fas fa-times"></i> Close
        </button>
        <div class="sidebar-title">
          <i class="fas fa-hand-holding-usd text-primary"></i>
          <h2>Pay Dividend</h2>
        </div>
      </div>
      <div class="sidebar-content" id="addDividendSidebarContent">
        <!-- HTMX loading target -->
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toastNotification" class="toast-notification-global">
    <div class="toast-content-global">
      <i class="fas fa-check-circle toast-icon-global"></i>
      <span class="toast-message-global"></span>
    </div>

    <!-- Notification System Styles -->
    <style>
      /* Notification Container style removed to fix spacing issues - handled in command_palette.css */

      /* Notification Bell Button */
      .notification-bell {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
        position: relative;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        color: #4b5563;
      }

      .notification-bell:hover {
        background: #f3f4f6;
        color: #1f2937;
      }

      .notification-bell i {
        font-size: 18px;
      }

      /* Notification Badge */
      .notification-badge {
        position: absolute;
        top: 2px;
        right: 4px;
        background: #ef4444;
        color: white;
        font-size: 10px;
        font-weight: 700;
        min-width: 18px;
        height: 18px;
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      .notification-badge.hidden {
        display: none;
      }

      /* Notification Dropdown */
      .notification-dropdown {
        position: absolute;
        top: 100%;
        right: -10px;
        width: 360px;
        max-height: 480px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: none;
        z-index: 1000;
        overflow: hidden;
        margin-top: 8px;
      }

      .notification-dropdown.active {
        display: block;
        animation: slideDown 0.2s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Notification Header */
      .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
      }

      .notification-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #111827;
      }

      .mark-all-read-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        color: #6b7280;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
      }

      .mark-all-read-btn:hover {
        background: #e5e7eb;
        color: #111827;
      }

      /* Notification List */
      .notification-list {
        max-height: 400px;
        overflow-y: auto;
      }

      /* Notification Item */
      .notification-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 14px 20px;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: background 0.2s ease;
        text-decoration: none;
        color: inherit;
      }

      .notification-item:hover {
        background: #f9fafb;
      }

      .notification-item.unread {
        background: #f0f9ff;
      }

      .notification-item.unread:hover {
        background: #e0f2fe;
      }

      .notification-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
      }

      .notification-icon.order {
        background: #dbeafe;
        color: #2563eb;
      }

      .notification-icon.task {
        background: #fef3c7;
        color: #d97706;
      }

      .notification-icon.task-updated {
        background: #e0e7ff;
        color: #4f46e5;
      }

      .notification-icon.task-comment {
        background: #dcfce7;
        color: #16a34a;
      }

      .notification-content {
        flex: 1;
        min-width: 0;
      }

      .notification-title {
        font-size: 14px;
        font-weight: 500;
        color: #111827;
        margin: 0 0 4px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .notification-message {
        font-size: 13px;
        color: #6b7280;
        margin: 0 0 4px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .notification-time {
        font-size: 11px;
        color: #9ca3af;
      }

      /* Empty State */
      .notification-empty {
        text-align: center;
        padding: 40px 20px;
        color: #9ca3af;
      }

      .notification-empty i {
        font-size: 40px;
        margin-bottom: 12px;
      }

      .notification-empty p {
        margin: 0;
        font-size: 14px;
      }

      /* Loading State */
      .notification-loading {
        text-align: center;
        padding: 20px;
        color: #6b7280;
      }
    </style>

    <!-- Notification System JavaScript -->
    <script>
      // Notification
      let notificationDropdownOpen = false;
      let notificationPollInterval = null;

      // Toggle notification dropdown
      function toggleNotifications() {
        const dropdown = document.getElementById('notificationDropdown');
        notificationDropdownOpen = !notificationDropdownOpen;

        if (notificationDropdownOpen) {
          dropdown.classList.add('active');
          fetchNotifications();
        } else {
          dropdown.classList.remove('active');
        }
      }

      // Close notifications when clicking outside
      document.addEventListener('click', function (e) {
        const container = document.querySelector('.notification-container');
        if (container && !container.contains(e.target)) {
          const dropdown = document.getElementById('notificationDropdown');
          if (dropdown) {
            dropdown.classList.remove('active');
            notificationDropdownOpen = false;
          }
        }
      });

      // Fetch notifications from server
      async function fetchNotifications() {
        try {
          const response = await fetch('/notifications/');
          const data = await response.json();

          console.log('Notifications API response:', data);

          if (data.success) {
            updateNotificationBadge(data.unread_count);
            renderNotifications(data.notifications);
          }
        } catch (error) {
          console.error('Failed to fetch notifications:', error);
        }
      }

      // Update notification badge count
      function updateNotificationBadge(count) {
        const badge = document.getElementById('notificationBadge');
        if (badge) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.classList.toggle('hidden', count === 0);
        }
      }

      // Render notifications in dropdown
      function renderNotifications(notifications) {
        const list = document.getElementById('notificationList');
        if (!list) return;

        if (notifications.length === 0) {
          list.innerHTML = `
          <div class="notification-empty">
            <i class="fas fa-bell-slash"></i>
            <p>No notifications</p>
          </div>
        `;
          return;
        }

        list.innerHTML = notifications.map(notif => {
          const iconClass = getNotificationIconClass(notif.type);
          const readClass = notif.is_read ? '' : 'unread';

          return `
          <a href="${notif.link}" class="notification-item ${readClass}" 
             onclick="markNotificationRead(${notif.id}, event)">
            <div class="notification-icon ${iconClass}">
              <i class="fas ${notif.icon}"></i>
            </div>
            <div class="notification-content">
              <p class="notification-title">${escapeHtml(notif.title)}</p>
              <p class="notification-message">${escapeHtml(notif.message)}</p>
              <span class="notification-time">${notif.time_ago}</span>
            </div>
          </a>
        `;
        }).join('');
      }

      // Get icon class based on notification type
      function getNotificationIconClass(type) {
        switch (type) {
          case 'new_order': return 'order';
          case 'task_assigned': return 'task';
          case 'task_updated': return 'task-updated';
          case 'task_comment': return 'task-comment';
          default: return '';
        }
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Mark single notification as read
      async function markNotificationRead(notificationId, event) {
        try {
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.cookie.match(/csrftoken=([^;]+)/)?.[1];

          await fetch(`/notifications/${notificationId}/read/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json'
            }
          });

          // Update badge after navigation happens
          setTimeout(() => fetchNotifications(), 100);
        } catch (error) {
          console.error('Failed to mark notification as read:', error);
        }
      }

      // Mark all notifications as read
      async function markAllNotificationsRead() {
        try {
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.cookie.match(/csrftoken=([^;]+)/)?.[1];

          const response = await fetch('/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/json'
            }
          });

          const data = await response.json();
          if (data.success) {
            updateNotificationBadge(0);
            fetchNotifications(); // Refresh list
          }
        } catch (error) {
          console.error('Failed to mark all as read:', error);
        }
      }

      // Start polling for notifications
      function startNotificationPolling() {
        // Initial fetch
        fetchNotifications();

        // Poll every 30 seconds
        notificationPollInterval = setInterval(fetchNotifications, 30000);
      }

      // Initialize notifications on page load
      document.addEventListener('DOMContentLoaded', function () {
        startNotificationPolling();

        // Initialize push notifications if supported
        if ('Notification' in window && 'serviceWorker' in navigator) {
          initPushNotifications();
        }
      });

      // ============ Browser Push Notifications ============
      async function initPushNotifications() {
        // Check if already granted
        if (Notification.permission === 'granted') {
          // Already have permission
          return;
        }

        // Ask for permission after user interaction (not on page load)
        // This is better UX - we'll ask when they first click the bell
      }

      // Request push notification permission
      async function requestPushPermission() {
        if (!('Notification' in window)) {
          console.log('Browser does not support notifications');
          return false;
        }

        if (Notification.permission === 'granted') {
          return true;
        }

        if (Notification.permission === 'denied') {
          console.log('Notification permission was denied');
          return false;
        }

        const permission = await Notification.requestPermission();
        return permission === 'granted';
      }

      // Show browser push notification
      function showPushNotification(title, body, link) {
        if (Notification.permission === 'granted') {
          const notification = new Notification(title, {
            body: body,
            icon: '/static/erp/images/favicon.ico',
            tag: 'nejum-notification'
          });

          notification.onclick = function () {
            window.focus();
            if (link) {
              window.location.href = link;
            }
            notification.close();
            // Auto close after 5 seconds
            setTimeout(() => notification.close(), 5000);
          }
        }
      }

      // Order Sidebar Functions
      function openOrderSidebar() {
        const overlay = document.getElementById('orderSidebarOverlay');
        const content = document.getElementById('orderSidebarContent');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Always reload to get a fresh form
        content.innerHTML = '<div style="text-align:center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading form...</div>';

        // Use HTMX to load content
        htmx.ajax('GET', '{% url "operating:create_order" %}', { target: '#orderSidebarContent', swap: 'innerHTML' });
      }

      function closeOrderSidebar() {
        document.getElementById('orderSidebarOverlay').classList.remove('active');
        document.body.style.overflow = '';
      }

      // Book Sidebar Functions
      function openBookSidebar() {
        const overlay = document.getElementById('bookSidebarOverlay');
        const content = document.getElementById('bookSidebarContent');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';

        content.innerHTML = '<div style="text-align:center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading form...</div>';

        htmx.ajax('GET', '{% url "accounting:create_book" %}', { target: '#bookSidebarContent', swap: 'innerHTML' });
      }

      function closeBookSidebar() {
        document.getElementById('bookSidebarOverlay').classList.remove('active');
        document.body.style.overflow = '';
      }

      function submitBookForm(event) {
        event.preventDefault();
        const form = document.getElementById('bookForm');
        const submitBtn = document.getElementById('bookSubmitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.btn-spinner');

        // Loading state
        if (btnText) btnText.style.display = 'none';
        if (btnSpinner) btnSpinner.style.display = 'inline-flex';
        submitBtn.disabled = true;

        const formData = new FormData(form);

        fetch('{% url "accounting:create_book" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const toast = document.getElementById('toastNotification');
              const toastMessage = toast.querySelector('.toast-message-global');
              toastMessage.textContent = 'Book created successfully!';
              toast.classList.add('show');
              setTimeout(() => toast.classList.remove('show'), 3000);

              closeBookSidebar();
              if (data.redirect_url) {
                window.location.href = data.redirect_url;
              }
            } else {
              alert('Error: ' + (data.errors ? JSON.stringify(data.errors) : 'Failed to create book'));
              if (btnText) btnText.style.display = 'inline';
              if (btnSpinner) btnSpinner.style.display = 'none';
              submitBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
            if (btnText) btnText.style.display = 'inline';
            if (btnSpinner) btnSpinner.style.display = 'none';
            submitBtn.disabled = false;
          });
      }

      // Add Capital Sidebar Functions
      let currentCapitalUrl = '';

      function openAddCapitalSidebar(url) {
        currentCapitalUrl = url;
        const overlay = document.getElementById('addCapitalSidebarOverlay');
        const content = document.getElementById('addCapitalSidebarContent');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';

        content.innerHTML = '<div style="text-align:center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading form...</div>';

        htmx.ajax('GET', url, { target: '#addCapitalSidebarContent', swap: 'innerHTML' });
      }

      function closeAddCapitalSidebar() {
        document.getElementById('addCapitalSidebarOverlay').classList.remove('active');
        document.body.style.overflow = '';
      }

      function submitAddCapitalForm(event) {
        event.preventDefault();
        const form = document.getElementById('addCapitalForm');
        const submitBtn = document.getElementById('btnSaveCapital');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.spinner-border');

        // Loading state
        if (btnText) btnText.style.display = 'none';
        if (btnSpinner) btnSpinner.classList.remove('d-none');
        submitBtn.disabled = true;

        const formData = new FormData(form);

        // currentCapitalUrl should have been set when opening
        fetch(currentCapitalUrl, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const toast = document.getElementById('toastNotification');
              const toastMessage = toast.querySelector('.toast-message-global');
              toastMessage.textContent = data.message || 'Capital added successfully!';
              toast.classList.add('show');
              setTimeout(() => toast.classList.remove('show'), 3000);

              closeAddCapitalSidebar();
              if (data.redirect_url) {
                // Refresh the page or go to redirect url to show updated data
                window.location.reload();
              }
            } else {
              // Simple error alert for now, could be better
              alert('Error: ' + (data.errors ? JSON.stringify(data.errors) : 'Failed to add capital'));
              if (btnText) btnText.style.display = 'inline';
              if (btnSpinner) btnSpinner.classList.add('d-none');
              submitBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
            if (btnText) btnText.style.display = 'inline';
            if (btnSpinner) btnSpinner.classList.add('d-none');
            submitBtn.disabled = false;
          });
      }

      // Raw Material Sidebar Functions
      function openRawMaterialSidebar() {
        document.getElementById('rawMaterialSidebarOverlay').classList.add('active');
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
          if (typeof initializeFormTracking === 'function') {
            initializeFormTracking('rawMaterialForm');
          }
          document.getElementById('id_rm_name').focus();
        }, 300);
      }

      function closeRawMaterialSidebar() {
        const overlay = document.getElementById('rawMaterialSidebarOverlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('rawMaterialForm').reset();
        if (typeof resetFormTracking === 'function') resetFormTracking();
      }

      function submitRawMaterialForm(event) {
        event.preventDefault();
        if (window.formChangeTracker) window.formChangeTracker.setSubmitting();

        const form = document.getElementById('rawMaterialForm');
        const submitBtn = document.getElementById('rmSubmitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.btn-spinner');

        // Loading state
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline-flex';
        submitBtn.disabled = true;

        const formData = new FormData(form);

        fetch('{% url "operating:create_raw_material_good_json" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const toast = document.getElementById('toastNotification');
              const toastMessage = toast.querySelector('.toast-message-global');
              toastMessage.textContent = data.message || 'Raw Material created successfully!';
              toast.classList.add('show');
              setTimeout(() => toast.classList.remove('show'), 3000);

              closeRawMaterialSidebar();
            } else {
              alert('Error: ' + (data.errors || 'Failed to create raw material'));
              btnText.style.display = 'inline';
              btnSpinner.style.display = 'none';
              submitBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
            submitBtn.disabled = false;
          });
      }

      // Raw Material Receipt Sidebar Functions
      function openRawMaterialReceiptSidebar() {
        const overlay = document.getElementById('rawMaterialReceiptSidebarOverlay');
        const content = document.getElementById('rawMaterialReceiptSidebarContent');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Show loading state
        content.innerHTML = '<div style="text-align:center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading form...</div>';

        // HTMX load
        htmx.ajax('GET', '{% url "operating:create_raw_material_receipt_partial" %}', { target: '#rawMaterialReceiptSidebarContent', swap: 'innerHTML' });
      }

      function closeRawMaterialReceiptSidebar() {
        const overlay = document.getElementById('rawMaterialReceiptSidebarOverlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      function submitRawMaterialReceiptForm(event) {
        event.preventDefault();
        if (window.formChangeTracker) window.formChangeTracker.setSubmitting();

        const form = document.getElementById('rawMaterialReceiptForm');
        const submitBtn = document.getElementById('rmReceiptSubmitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.btn-spinner');

        // Loading state
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline-flex';
        submitBtn.disabled = true;

        const formData = new FormData(form);

        fetch('{% url "operating:create_raw_material_good_receipt_json" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const toast = document.getElementById('toastNotification');
              const toastMessage = toast.querySelector('.toast-message-global');
              toastMessage.textContent = data.message || 'Receipt created successfully!';
              toast.classList.add('show');
              setTimeout(() => toast.classList.remove('show'), 3000);

              closeRawMaterialReceiptSidebar();
            } else {
              alert('Error: ' + (data.errors || 'Failed to create receipt'));
              btnText.style.display = 'inline';
              btnSpinner.style.display = 'none';
              submitBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
            submitBtn.disabled = false;
          });
      }

      // Raw Material Item Sidebar Functions
      function openRawMaterialItemSidebar(receiptId = null) {
        const overlay = document.getElementById('rawMaterialItemSidebarOverlay');
        const content = document.getElementById('rawMaterialItemSidebarContent');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Show loading state
        content.innerHTML = '<div style="text-align:center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading form...</div>';

        // HTMX load with optional receipt param
        let url = '{% url "operating:create_raw_material_item_partial" %}';
        if (receiptId) {
          url += '?receipt=' + receiptId;
        }

        htmx.ajax('GET', url, { target: '#rawMaterialItemSidebarContent', swap: 'innerHTML' });
      }

      function closeRawMaterialItemSidebar() {
        const overlay = document.getElementById('rawMaterialItemSidebarOverlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      function submitRawMaterialItemForm(event) {
        event.preventDefault();
        if (window.formChangeTracker) window.formChangeTracker.setSubmitting();

        const form = document.getElementById('rawMaterialItemForm');
        const submitBtn = document.getElementById('rmItemSubmitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.btn-spinner');

        // Loading state
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline-flex';
        submitBtn.disabled = true;

        const formData = new FormData(form);

        fetch('{% url "operating:create_raw_material_good_item_json" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const toast = document.getElementById('toastNotification');
              const toastMessage = toast.querySelector('.toast-message-global');
              toastMessage.textContent = data.message || 'Item added successfully!';
              toast.classList.add('show');
              setTimeout(() => toast.classList.remove('show'), 3000);

              closeRawMaterialItemSidebar();
            } else {
              alert('Error: ' + (data.errors || 'Failed to add item'));
              btnText.style.display = 'inline';
              btnSpinner.style.display = 'none';
              submitBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
            submitBtn.disabled = false;
          });
      }

      // Add Capital JS (assumed to be earlier, adding Revenue JS here)
      let currentRevenueUrl = '';

      function openAddRevenueSidebar(url) {
        currentRevenueUrl = url;
        const overlay = document.getElementById('addRevenueSidebarOverlay');
        const content = document.getElementById('addRevenueSidebarContent');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';

        content.innerHTML = '<div style="text-align:center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading form...</div>';

        htmx.ajax('GET', url, { target: '#addRevenueSidebarContent', swap: 'innerHTML' });
      }

      function closeAddRevenueSidebar() {
        document.getElementById('addRevenueSidebarOverlay').classList.remove('active');
        document.body.style.overflow = '';
      }

      function submitAddRevenueForm(event) {
        event.preventDefault();
        const form = document.getElementById('addRevenueForm');
        const submitBtn = document.getElementById('btnSaveRevenue');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.spinner-border');

        // Loading state
        if (btnText) btnText.style.display = 'none';
        if (btnSpinner) btnSpinner.style.display = 'inline-flex';
        submitBtn.disabled = true;

        const formData = new FormData(form);

        fetch(currentRevenueUrl, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const toast = document.getElementById('toastNotification');
              const toastMessage = toast.querySelector('.toast-message-global');
              toastMessage.textContent = data.message || 'Revenue added successfully!';
              toast.classList.add('show');
              setTimeout(() => toast.classList.remove('show'), 3000);

              closeAddRevenueSidebar();
              if (data.redirect_url) {
                // If the redirect URL is the current page, just reload
                if (window.location.href.includes(data.redirect_url) || data.redirect_url === window.location.pathname) {
                  window.location.reload();
                } else {
                  window.location.href = data.redirect_url;
                }
              }
            } else {
              alert('Error: ' + JSON.stringify(data.errors));
              if (btnText) btnText.style.display = 'inline';
              if (btnSpinner) btnSpinner.style.display = 'none';
              submitBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
            if (btnText) btnText.style.display = 'inline';
            if (btnSpinner) btnSpinner.style.display = 'none';
            submitBtn.disabled = false;
          });
      }

      // Add Expense Sidebar Functions
      let currentExpenseUrl = '';

      function openAddExpenseSidebar(url) {
        currentExpenseUrl = url;
        const overlay = document.getElementById('addExpenseSidebarOverlay');
        const content = document.getElementById('addExpenseSidebarContent');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        content.innerHTML = '<div style="text-align:center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading form...</div>';
        htmx.ajax('GET', url, { target: '#addExpenseSidebarContent', swap: 'innerHTML' });
      }

      function closeAddExpenseSidebar() {
        document.getElementById('addExpenseSidebarOverlay').classList.remove('active');
        document.body.style.overflow = '';
      }

      function submitAddExpenseForm(event) {
        event.preventDefault();
        const form = document.getElementById('addExpenseForm');
        const submitBtn = document.getElementById('btnSaveExpense');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.spinner-border');

        if (btnText) btnText.style.display = 'none';
        if (btnSpinner) btnSpinner.style.display = 'inline-flex';
        submitBtn.disabled = true;

        const formData = new FormData(form);
        fetch(currentExpenseUrl, {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const toast = document.getElementById('toastNotification');
              toast.querySelector('.toast-message-global').textContent = data.message || 'Expense added successfully!';
              toast.classList.add('show');
              setTimeout(() => toast.classList.remove('show'), 3000);
              closeAddExpenseSidebar();
              if (data.redirect_url) window.location.reload();
            } else {
              alert('Error: ' + JSON.stringify(data.errors));
              if (btnText) btnText.style.display = 'inline';
              if (btnSpinner) btnSpinner.style.display = 'none';
              submitBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
            if (btnText) btnText.style.display = 'inline';
            if (btnSpinner) btnSpinner.style.display = 'none';
            submitBtn.disabled = false;
          });
      }

      // Pay Dividend Sidebar Functions
      let currentDividendUrl = '';

      function openAddDividendSidebar(url) {
        currentDividendUrl = url;
        const overlay = document.getElementById('addDividendSidebarOverlay');
        const content = document.getElementById('addDividendSidebarContent');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        content.innerHTML = '<div style="text-align:center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading form...</div>';
        htmx.ajax('GET', url, { target: '#addDividendSidebarContent', swap: 'innerHTML' });
      }

      function closeAddDividendSidebar() {
        document.getElementById('addDividendSidebarOverlay').classList.remove('active');
        document.body.style.overflow = '';
      }

      function submitAddDividendForm(event) {
        event.preventDefault();
        const form = document.getElementById('addDividendForm');
        const submitBtn = document.getElementById('btnSaveDividend');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.spinner-border');

        if (btnText) btnText.style.display = 'none';
        if (btnSpinner) btnSpinner.style.display = 'inline-flex';
        submitBtn.disabled = true;

        const formData = new FormData(form);
        fetch(currentDividendUrl, {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const toast = document.getElementById('toastNotification');
              toast.querySelector('.toast-message-global').textContent = data.message || 'Dividend paid successfully!';
              toast.classList.add('show');
              setTimeout(() => toast.classList.remove('show'), 3000);
              closeAddDividendSidebar();
              if (data.redirect_url) window.location.reload();
            } else {
              alert('Error: ' + JSON.stringify(data.errors));
              if (btnText) btnText.style.display = 'inline';
              if (btnSpinner) btnSpinner.style.display = 'none';
              submitBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred.');
            if (btnText) btnText.style.display = 'inline';
            if (btnSpinner) btnSpinner.style.display = 'none';
            submitBtn.disabled = false;
          });
      }
    </script>
    <script src="{% static 'operating/js/create_edit_order.js' %}"></script>
</body>

</html>