{% load static %}
{% load todo_tags %}
{% block css %}
  <link rel="stylesheet" href="{% static 'erp/css/components/dashboard.css' %}" />
{% endblock %}
{% block js %}
  <script src="{% static 'erp/js/dashboard.js' %}"></script>
{% endblock %}
<div class="dashboardComponent">
  <!-- Quick Stats Bar -->
  <div class="stats-bar">
    <div class="stat-item">
      <span class="stat-number">{{ number_of_leads_added }}</span>
      <span class="stat-label">New Leads Today</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <span class="stat-number">{{ pending_tasks_count }}</span>
      <span class="stat-label">Pending Tasks</span>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <span class="stat-number" id="thisWeekTasks">-</span>
      <span class="stat-label">This Week</span>
    </div>
  </div>

  <!-- Main Grid: Calendar + Tasks -->
  <div class="dashboard-grid">
    <!-- Calendar Section -->
    <div class="calendar-section">
      <div class="section-header">
        <div class="header-left">
          <h3><i class="fa fa-calendar"></i> Calendar</h3>
        </div>
        <div class="calendar-controls">
          <button class="btn-icon" onclick="previousMonth()">
            <i class="fa fa-chevron-left"></i>
          </button>
          <span class="current-month" id="currentMonth"></span>
          <button class="btn-icon" onclick="nextMonth()">
            <i class="fa fa-chevron-right"></i>
          </button>
        </div>
      </div>
      
      <div class="calendar-container">
        <div class="calendar-weekdays">
          <div class="weekday">Sun</div>
          <div class="weekday">Mon</div>
          <div class="weekday">Tue</div>
          <div class="weekday">Wed</div>
          <div class="weekday">Thu</div>
          <div class="weekday">Fri</div>
          <div class="weekday">Sat</div>
        </div>
        <div class="calendar-days" id="calendarDays">
          <!-- Generated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="tasks-section">
      <div class="section-header">
        <h3><i class="fa fa-check-square"></i> <span id="selectedDateText">Today's Tasks</span></h3>
        <a href="{% url 'task_report' %}" class="btn-link" target="_blank">
          View All <i class="fa fa-arrow-right"></i>
        </a>
      </div>
      
      <div class="tasks-container" id="tasksContainer">
        {% tasks_component csrf_token=csrf_token page_type='dashboard' contact=None company=None sort_type='dictsortreversed' path=path member=member%}
      </div>
    </div>
  </div>
</div>

<script>
let currentDate = new Date();
let selectedDate = new Date();
const tasksData = {{ tasks_calendar_data|safe }};

function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  // Update month display
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
  
  // Get first day of month and total days
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  const calendarDays = document.getElementById('calendarDays');
  calendarDays.innerHTML = '';
  
  // Add empty cells for days before month starts
  for (let i = 0; i < firstDay; i++) {
    const emptyDay = document.createElement('div');
    emptyDay.className = 'calendar-day empty';
    calendarDays.appendChild(emptyDay);
  }
  
  // Add days of month
  const today = new Date();
  for (let day = 1; day <= daysInMonth; day++) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    const dateObj = new Date(year, month, day);
    const dateStr = dateObj.toISOString().split('T')[0];
    
    // Check if today
    if (dateObj.toDateString() === today.toDateString()) {
      dayElement.classList.add('today');
    }
    
    // Check if selected
    if (dateObj.toDateString() === selectedDate.toDateString()) {
      dayElement.classList.add('selected');
    }
    
    // Check if has tasks
    if (tasksData[dateStr]) {
      dayElement.classList.add('has-tasks');
      const badge = document.createElement('span');
      badge.className = 'task-badge';
      badge.textContent = tasksData[dateStr];
      dayElement.appendChild(badge);
      
      const dayNumber = document.createElement('span');
      dayNumber.textContent = day;
      dayElement.insertBefore(dayNumber, badge);
    } else {
      dayElement.textContent = day;
    }
    
    dayElement.onclick = () => selectDate(dateObj);
    
    calendarDays.appendChild(dayElement);
  }
}

function selectDate(date) {
  selectedDate = date;
  renderCalendar();
  
  // Update tasks header
  const today = new Date();
  const selectedDateText = document.getElementById('selectedDateText');
  
  if (date.toDateString() === today.toDateString()) {
    selectedDateText.textContent = "Today's Tasks";
  } else {
    const options = { month: 'short', day: 'numeric', year: 'numeric' };
    selectedDateText.textContent = `Tasks for ${date.toLocaleDateString('en-US', options)}`;
  }
  
  // Fetch tasks for selected date
  loadTasksForDate(date);
}

function loadTasksForDate(date) {
  const dateStr = date.toISOString().split('T')[0];
  const tasksContainer = document.getElementById('tasksContainer');
  
  // Show loading state
  tasksContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);"><i class="fa fa-spinner fa-spin"></i> Loading tasks...</div>';
  
  fetch(`/dashboard/?date=${dateStr}`, {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.text())
  .then(html => {
    tasksContainer.innerHTML = html;
  })
  .catch(error => {
    console.error('Error loading tasks:', error);
    tasksContainer.innerHTML = '<div class="tasks_component"><ul><li style="color: red;">Error loading tasks.</li></ul></div>';
  });
}

function previousMonth() {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar();
}

function nextMonth() {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar();
}

// Initialize calendar on page load
document.addEventListener('DOMContentLoaded', function() {
  renderCalendar();
});
</script>
