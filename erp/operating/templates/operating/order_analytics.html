{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard{% endblock %}

{% block css %}
<style>
    .analytics-container {
        display: flex;
        gap: 1.5rem;
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        background: #fafafa;
        min-height: 100vh;
    }

    .analytics-main {
        flex: 1;
    }

    .analytics-sidebar {
        width: 300px;
        flex-shrink: 0;
    }

    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .header-left h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a1a1a;
        margin: 0 0 0.5rem 0;
    }

    .header-left p {
        color: #666;
        font-size: 0.875rem;
        margin: 0;
    }

    .header-right {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .last-update {
        background: white;
        padding: 0.75rem 1.25rem;
        border-radius: 25px;
        font-size: 0.875rem;
        color: #666;
        border: 1px solid #e5e5e5;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .summary-card {
        background: white;
        padding: 1.25rem;
        border-radius: 16px;
        border: 1px solid #f0f0f0;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .card-icon {
        width: 40px;
        height: 40px;
        background: #f5f5f5;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: #666;
    }

    .card-icon.custom {
        background: #fef3c7;
        color: #d97706;
    }

    .card-icon.fabric {
        background: #dbeafe;
        color: #2563eb;
    }

    .card-label {
        font-size: 0.8125rem;
        color: #666;
        margin-bottom: 0.25rem;
    }

    .card-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a1a1a;
    }

    .chart-section {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #f0f0f0;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .chart-title h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0 0 0.25rem 0;
    }

    .chart-title p {
        font-size: 0.875rem;
        color: #666;
        margin: 0;
    }

    .chart-controls {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .period-tabs {
        display: flex;
        gap: 0.25rem;
        background: #f5f5f5;
        padding: 0.25rem;
        border-radius: 25px;
    }

    .period-tabs a,
    .period-tabs button {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
        color: #666;
        background: transparent;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
    }

    .period-tabs a:hover,
    .period-tabs button:hover {
        color: #1a1a1a;
    }

    .period-tabs a.active,
    .period-tabs button.active {
        background: white;
        color: #1a1a1a;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .weekly-btn {
        background: #d4a800;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8125rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .weekly-btn:hover {
        background: #b89500;
    }

    .weekly-btn.active {
        background: #16a34a;
    }

    .chart-container {
        height: 300px;
        position: relative;
    }

    .bottom-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .list-card {
        background: white;
        border-radius: 16px;
        border: 1px solid #f0f0f0;
        overflow: hidden;
    }

    .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f5f5f5;
        background: #fafafa;
    }

    .list-header h3 {
        font-size: 0.9375rem;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .list-header h3 .badge {
        font-size: 0.6875rem;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-weight: 500;
    }

    .badge-custom {
        background: #fef3c7;
        color: #d97706;
    }

    .badge-fabric {
        background: #dbeafe;
        color: #2563eb;
    }

    .list-item {
        display: flex;
        align-items: center;
        padding: 0.875rem 1.25rem;
        gap: 0.875rem;
        border-bottom: 1px solid #f5f5f5;
    }

    .list-item:last-child {
        border-bottom: none;
    }

    .item-avatar {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        font-size: 0.75rem;
        flex-shrink: 0;
    }

    .item-avatar.product {
        background: #f5f5f5;
        color: #666;
        font-size: 1rem;
    }

    .item-avatar.custom {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .item-avatar.fabric {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .item-info {
        flex: 1;
        min-width: 0;
    }

    .item-name {
        font-weight: 600;
        color: #1a1a1a;
        font-size: 0.875rem;
        margin-bottom: 0.125rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .item-meta {
        font-size: 0.75rem;
        color: #999;
    }

    .item-value {
        text-align: right;
    }

    .item-amount {
        font-weight: 600;
        color: #1a1a1a;
        font-size: 0.875rem;
    }

    .filter-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid #f0f0f0;
        position: sticky;
        top: 2rem;
    }

    .filter-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .filter-header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0;
    }

    .filter-section {
        margin-bottom: 1.25rem;
    }

    .filter-label {
        font-size: 0.8125rem;
        color: #666;
        margin-bottom: 0.5rem;
        display: block;
        font-weight: 500;
    }

    .filter-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e5e5;
        border-radius: 10px;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
    }

    .product-type-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .product-type-btn {
        flex: 1;
        padding: 0.75rem 0.5rem;
        border: 1px solid #e5e5e5;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        background: white;
        text-align: center;
        transition: all 0.2s;
        text-decoration: none;
        color: #666;
    }

    .product-type-btn:hover {
        border-color: #d4a800;
    }

    .product-type-btn.active {
        background: #fef3c7;
        border-color: #d4a800;
        color: #1a1a1a;
    }

    .apply-btn {
        width: 100%;
        padding: 0.875rem;
        background: #d4a800;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .apply-btn:hover {
        background: #b89500;
    }

    .empty-message {
        text-align: center;
        padding: 1.5rem;
        color: #999;
        font-size: 0.875rem;
    }

    @media (max-width: 1024px) {
        .analytics-container {
            flex-direction: column;
        }

        .analytics-sidebar {
            width: 100%;
        }

        .summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }

        .bottom-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-main">
        <!-- Header -->
        <div class="analytics-header">
            <div class="header-left">
                <h1>Overview</h1>
                <p>Review your order data and performance metrics</p>
            </div>
            <div class="header-right">
                <div class="last-update">Last Update: {% now "d M, H:i" %}</div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-wallet"></i></div>
                </div>
                <div class="card-label">Total Revenue</div>
                <div class="card-value">₺{{ summary.total_revenue|floatformat:0|default:"0" }}</div>
            </div>
            <div class="summary-card">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-shopping-bag"></i></div>
                </div>
                <div class="card-label">Total Orders</div>
                <div class="card-value">{{ summary.total_orders|default:"0" }}</div>
            </div>
            <div class="summary-card">
                <div class="card-header">
                    <div class="card-icon custom"><i class="fas fa-cut"></i></div>
                </div>
                <div class="card-label">Custom Curtain</div>
                <div class="card-value">{{ summary.custom_curtain_count|default:"0" }}</div>
            </div>
            <div class="summary-card">
                <div class="card-header">
                    <div class="card-icon fabric"><i class="fas fa-scroll"></i></div>
                </div>
                <div class="card-label">Fabric</div>
                <div class="card-value">{{ summary.fabric_count|default:"0" }}</div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section">
            <div class="chart-header">
                <div class="chart-title">
                    <h3>Sales Trends</h3>
                    <p>Revenue distribution over time</p>
                </div>
                <div class="chart-controls">
                    <div class="period-tabs">
                        <button type="button" onclick="switchPeriod('weekly')"
                            class="period-tab {% if period == 'weekly' %}active{% endif %}"
                            data-period="weekly">Weekly</button>
                        <button type="button" onclick="switchPeriod('monthly')"
                            class="period-tab {% if period == 'monthly' or not period %}active{% endif %}"
                            data-period="monthly">Monthly</button>
                        <button type="button" onclick="switchPeriod('yearly')"
                            class="period-tab {% if period == 'yearly' %}active{% endif %}"
                            data-period="yearly">Yearly</button>
                    </div>
                    <button class="weekly-btn" id="toggleWeeklyBtn" onclick="toggleWeeklyView()">
                        <i class="fas fa-calendar-week"></i> Last 7 Days
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <!-- Bottom Lists -->
        <div class="bottom-grid">
            <!-- Top Custom Curtains -->
            <div class="list-card">
                <div class="list-header">
                    <h3><i class="fas fa-cut"></i> Top Selling Curtains <span class="badge badge-custom">Curtain</span>
                    </h3>
                </div>
                {% for product in top_custom %}
                <div class="list-item">
                    <div class="item-avatar custom"><i class="fas fa-cut"></i></div>
                    <div class="item-info">
                        <div class="item-name">{{ product.product__title|truncatewords:4|default:"Unknown" }}</div>
                        <div class="item-meta">{{ product.product__sku }}</div>
                    </div>
                    <div class="item-value">
                        <div class="item-amount">{{ product.total_quantity }} Sales</div>
                    </div>
                </div>
                {% empty %}
                <div class="empty-message">No curtain sales yet</div>
                {% endfor %}
            </div>

            <!-- Top Fabric -->
            <div class="list-card">
                <div class="list-header">
                    <h3><i class="fas fa-scroll"></i> Top Selling Fabrics <span class="badge badge-fabric">Fabric</span>
                    </h3>
                </div>
                {% for product in top_fabric %}
                <div class="list-item">
                    <div class="item-avatar fabric"><i class="fas fa-scroll"></i></div>
                    <div class="item-info">
                        <div class="item-name">{{ product.product__title|truncatewords:4|default:"Unknown" }}</div>
                        <div class="item-meta">{{ product.product__sku }}</div>
                    </div>
                    <div class="item-value">
                        <div class="item-amount">{{ product.total_quantity|floatformat:0 }} Meters</div>
                    </div>
                </div>
                {% empty %}
                <div class="empty-message">No fabric sales yet</div>
                {% endfor %}
            </div>

            <!-- Top Customers -->
            <div class="list-card" style="grid-column: span 2;">
                <div class="list-header">
                    <h3><i class="fas fa-users"></i> Top Customers</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr);">
                    {% for customer in top_customers|slice:":6" %}
                    <div class="list-item">
                        <div class="item-avatar">{{ customer.web_client__name|slice:":2"|upper|default:"??" }}</div>
                        <div class="item-info">
                            <div class="item-name">{{ customer.web_client__name|default:"Guest" }}</div>
                            <div class="item-meta">{{ customer.order_count }} Orders</div>
                        </div>
                        <div class="item-value">
                            <div class="item-amount">₺{{ customer.total_spent|floatformat:0 }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-message" style="grid-column: span 2;">No customer data yet</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="analytics-sidebar">
        <div class="filter-card">
            <div class="filter-header">
                <i class="fas fa-sliders-h"></i>
                <h3>Filter</h3>
            </div>

            <form method="get" action="">
                <input type="hidden" name="period" value="{{ period|default:'monthly' }}">

                <div class="filter-section">
                    <label class="filter-label">Product Type</label>
                    <div class="product-type-buttons">
                        <a href="?period={{ period }}&days={{ days }}&product_type=all"
                            class="product-type-btn {% if product_type == 'all' or not product_type %}active{% endif %}">
                            <i class="fas fa-layer-group"></i><br>All
                        </a>
                        <a href="?period={{ period }}&days={{ days }}&product_type=custom"
                            class="product-type-btn {% if product_type == 'custom' %}active{% endif %}">
                            <i class="fas fa-cut"></i><br>Custom Curtain
                        </a>
                        <a href="?period={{ period }}&days={{ days }}&product_type=fabric"
                            class="product-type-btn {% if product_type == 'fabric' %}active{% endif %}">
                            <i class="fas fa-scroll"></i><br>Fabric
                        </a>
                    </div>
                </div>

                <div class="filter-section">
                    <label class="filter-label">Date Range</label>
                    <select name="days" class="filter-select" onchange="this.form.submit()">
                        <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 days</option>
                        <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
                        <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 days</option>
                        <option value="180" {% if days == 180 %}selected{% endif %}>Last 6 months</option>
                        <option value="365" {% if days == 365 or not days %}selected{% endif %}>Last 1 year</option>
                        <option value="730" {% if days == 730 %}selected{% endif %}>Last 2 years</option>
                    </select>
                </div>

                <input type="hidden" name="product_type" value="{{ product_type|default:'all' }}">
            </form>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    // Chart data from Django
    var mainLabels = [];
    var mainRevenues = [];
    var weeklyLabels = [];
    var weeklyRevenues = [];
    var isWeeklyView = false;
    var salesChart = null;

    {% if chart_labels %}
    mainLabels = {{ chart_labels | safe }};
    {% endif %}

    {% if chart_revenues %}
    mainRevenues = {{ chart_revenues | safe }};
    {% endif %}

    {% if weekly_labels %}
    weeklyLabels = {{ weekly_labels | safe }};
    {% endif %}

    {% if weekly_revenues %}
    weeklyRevenues = {{ weekly_revenues | safe }};
    {% endif %}

    // If no data, show placeholder
    if (mainLabels.length === 0) {
        mainLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        mainRevenues = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
    }

    function toggleWeeklyView() {
        isWeeklyView = !isWeeklyView;
        var btn = document.getElementById('toggleWeeklyBtn');

        if (isWeeklyView) {
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-chart-line"></i> Main Chart';
            updateChart(weeklyLabels.length > 0 ? weeklyLabels : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                weeklyRevenues.length > 0 ? weeklyRevenues : [0, 0, 0, 0, 0, 0, 0]);
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<i class="fas fa-calendar-week"></i> Last 7 Days';
            updateChart(mainLabels, mainRevenues);
        }
    }

    function updateChart(labels, data) {
        if (salesChart) {
            salesChart.data.labels = labels;
            salesChart.data.datasets[0].data = data;
            salesChart.update('active');
        }
    }

    // Smooth period switching without page reload
    function switchPeriod(period) {
        // Update active tab
        document.querySelectorAll('.period-tab').forEach(function (tab) {
            tab.classList.remove('active');
            if (tab.dataset.period === period) {
                tab.classList.add('active');
            }
        });

        // Get current URL params
        var params = new URLSearchParams(window.location.search);
        params.set('period', period);
        params.set('format', 'json');

        // Add loading state
        var chartContainer = document.querySelector('.chart-container');
        chartContainer.style.opacity = '0.5';

        // Fetch data from server
        fetch('?' + params.toString(), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(function (response) { return response.json(); })
            .then(function (data) {
                // Update chart with smooth animation
                if (data.chart_labels && data.chart_revenues) {
                    updateChart(data.chart_labels, data.chart_revenues);
                }
                chartContainer.style.opacity = '1';

                // Update URL without reload
                params.delete('format');
                history.pushState({}, '', '?' + params.toString());
            })
            .catch(function (error) {
                console.error('Error:', error);
                chartContainer.style.opacity = '1';
            });
    }

    // Wait for DOM
    document.addEventListener('DOMContentLoaded', function () {
        var canvas = document.getElementById('salesChart');
        if (!canvas) return;

        var ctx = canvas.getContext('2d');

        // Create gradient
        var gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(212, 168, 0, 0.4)');
        gradient.addColorStop(1, 'rgba(212, 168, 0, 0.05)');

        // Create chart
        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: mainLabels,
                datasets: [{
                    label: 'Revenue (₺)',
                    data: mainRevenues,
                    borderColor: '#d4a800',
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointBackgroundColor: '#d4a800',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: function (context) {
                                return '₺' + context.parsed.y.toLocaleString('tr-TR');
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#888888'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#f0f0f0'
                        },
                        ticks: {
                            color: '#888888',
                            callback: function (value) {
                                return '₺' + value.toLocaleString('tr-TR');
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}