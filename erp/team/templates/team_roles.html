{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Members - {{ team.name }} | Nejum ERP{% endblock %}

{% block css %}
<style>
  :root {
    --mm-bg: #f8fafc;
    --mm-primary: #3b82f6;
    --mm-text-main: #1e293b;
    --mm-text-muted: #64748b;
    --mm-border: #e2e8f0;
    --mm-card-bg: #ffffff;
  }

  body {
    background: var(--mm-bg);
  }

  .mm-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* Breadcrumb */
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--mm-primary);
    margin-bottom: 1.5rem;
  }

  .breadcrumb a {
    color: var(--mm-primary);
    text-decoration: none;
  }

  .breadcrumb span {
    color: var(--mm-text-muted);
  }

  /* Header */
  .mm-header {
    margin-bottom: 2rem;
  }

  .mm-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--mm-text-main);
    margin: 0 0 0.5rem;
  }

  .mm-header p {
    color: var(--mm-text-muted);
    margin: 0;
  }

  /* Search & Actions Bar */
  .actions-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .search-box {
    position: relative;
    flex: 1;
    max-width: 360px;
  }

  .search-box input {
    width: 100%;
    padding: 10px 12px 10px 40px;
    border: 1px solid var(--mm-border);
    border-radius: 8px;
    font-size: 0.875rem;
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--mm-primary);
  }

  .search-box i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--mm-text-muted);
  }

  .action-buttons {
    display: flex;
    gap: 0.75rem;
  }

  .btn-filter {
    padding: 10px 16px;
    border: 1px solid var(--mm-border);
    background: white;
    border-radius: 8px;
    font-size: 0.875rem;
    color: var(--mm-text-main);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-add {
    padding: 10px 20px;
    border: none;
    background: var(--mm-primary);
    color: white;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-add:hover {
    background: #2563eb;
  }

  /* Members Table */
  .members-card {
    background: var(--mm-card-bg);
    border-radius: 12px;
    border: 1px solid var(--mm-border);
    overflow: hidden;
  }

  .members-table {
    width: 100%;
    border-collapse: collapse;
  }

  .members-table th {
    text-align: left;
    padding: 1rem 1.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--mm-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--mm-border);
    background: #fafafa;
  }

  .members-table td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--mm-border);
    vertical-align: middle;
  }

  .members-table tr:last-child td {
    border-bottom: none;
  }

  .members-table tr:hover {
    background: #f8fafc;
  }

  /* Member Cell */
  .member-cell {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .member-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 0.875rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .member-info {
    min-width: 0;
  }

  .member-name {
    font-weight: 600;
    color: var(--mm-text-main);
    font-size: 0.9rem;
    margin-bottom: 0.1rem;
  }

  .member-email {
    font-size: 0.8rem;
    color: var(--mm-primary);
  }

  /* Role Select */
  .role-select {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    background: none;
  }

  .role-admin {
    background: #dbeafe;
    color: #1d4ed8;
  }

  .role-manager {
    background: #e0e7ff;
    color: #4f46e5;
  }

  .role-member {
    background: #f1f5f9;
    color: #475569;
  }

  .role-viewer {
    background: #f1f5f9;
    color: #64748b;
  }

  .date-cell {
    color: var(--mm-text-muted);
    font-size: 0.875rem;
  }

  /* Actions */
  .action-menu {
    position: relative;
  }

  .action-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    color: var(--mm-text-muted);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .action-btn:hover {
    background: #f1f5f9;
  }

  /* Pagination */
  .table-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: #fafafa;
    border-top: 1px solid var(--mm-border);
    font-size: 0.875rem;
    color: var(--mm-text-muted);
  }

  .pagination {
    display: flex;
    gap: 0.5rem;
  }

  .page-btn {
    padding: 6px 12px;
    border: 1px solid var(--mm-border);
    background: white;
    border-radius: 6px;
    font-size: 0.8rem;
    color: var(--mm-text-main);
    cursor: pointer;
  }

  .page-btn:hover {
    background: #f8fafc;
  }

  .page-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .mm-container {
      padding: 1rem;
    }

    .actions-bar {
      flex-direction: column;
      align-items: stretch;
    }

    .search-box {
      max-width: 100%;
    }

    .members-table thead {
      display: none;
    }

    .members-table td {
      display: block;
      padding: 0.75rem 1rem;
      border-bottom: none;
    }

    .members-table tr {
      display: block;
      border-bottom: 1px solid var(--mm-border);
      padding: 0.5rem 0;
    }
  }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="mm-container">
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <a href="{% url 'team:team_list' %}">Teams</a>
    <span>/</span>
    <a href="{% url 'team:team_list' %}">{{ team.name }}</a>
    <span>/</span>
    <span>Members</span>
  </div>

  <!-- Header -->
  <div class="mm-header">
    <h1>Manage Members</h1>
    <p>Manage who has access to this team, assign roles, and edit their permissions.</p>
  </div>

  <!-- Actions Bar -->
  <div class="actions-bar">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="memberSearch" placeholder="Search by name or email">
    </div>
    <div class="action-buttons">
      <button class="btn-filter">
        <i class="fas fa-filter"></i> Filter
      </button>
      {% if is_creator %}
      <button class="btn-add" onclick="openInviteModal()">
        <i class="fas fa-plus"></i> Add Member
      </button>
      {% endif %}
    </div>
  </div>

  <!-- Members Table -->
  <div class="members-card">
    <table class="members-table">
      <thead>
        <tr>
          <th>Member</th>
          <th>Role</th>
          <th>Date Added</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="membersTable">
        {% for member in members %}
        <tr data-member-id="{{ member.id }}"
          data-search="{{ member.user.get_full_name|lower }} {{ member.user.email|lower }}">
          <td>
            <div class="member-cell">
              <div class="member-avatar"
                style="background: {% cycle '#dbeafe' '#d1fae5' '#ede9fe' '#ffedd5' %}; color: {% cycle '#2563eb' '#059669' '#7c3aed' '#ea580c' %};">
                {{ member.user.first_name|first|upper }}{{ member.user.last_name|first|upper }}
              </div>
              <div class="member-info">
                <div class="member-name">{{ member.user.get_full_name|default:member.user.username }}</div>
                <div class="member-email">{{ member.user.email }}</div>
              </div>
            </div>
          </td>
          <td>
            {% if is_creator %}
            <select class="role-select role-{{ member.role }}" onchange="updateRole({{ member.id }}, this.value)">
              {% for value, label in role_choices %}
              <option value="{{ value }}" {% if member.role == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            {% else %}
            <span class="role-badge role-{{ member.role }}">{{ member.get_role_display }}</span>
            {% endif %}
          </td>
          <td class="date-cell">{{ member.joined_at|date:"M d, Y" }}</td>
          <td>
            <div class="action-menu">
              <button class="action-btn"><i class="fas fa-ellipsis-h"></i></button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" style="text-align: center; padding: 3rem; color: var(--mm-text-muted);">
            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>No team members yet. Click "Add Member" to invite someone.</p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="table-footer">
      <span>Showing {{ members|length }} of {{ members|length }} members</span>
      <div class="pagination">
        <button class="page-btn disabled">Previous</button>
        <button class="page-btn disabled">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Invite Member Modal -->
<div id="inviteModal" class="modal-overlay"
  style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; padding: 1rem;">
  <div class="modal-content"
    style="background: white; border-radius: 12px; width: 100%; max-width: 440px; padding: 1.5rem; box-sizing: border-box; max-height: 90vh; overflow-y: auto;">
    <h2 style="margin: 0 0 1.5rem; font-size: 1.25rem; font-weight: 700;">Add Member to Team</h2>
    <form id="inviteForm">
      <input type="hidden" name="team_id" value="{{ team.id }}">
      <div style="margin-bottom: 1rem; position: relative;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem;">Search User</label>
        <input type="text" id="userSearchInput" class="form-control" placeholder="Search by name or email..."
          style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box;">
        <div id="userSearchResults"
          style="display: none; position: absolute; left: 0; right: 0; top: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 8px; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; margin-top: 4px;">
        </div>
        <input type="hidden" id="selectedUserId" name="user_id" required>
      </div>
      <div id="selectedUserDisplay"
        style="display: none; padding: 0.75rem; background: #f1f5f9; border-radius: 8px; margin-bottom: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <div id="selectedUserAvatar"
            style="width: 36px; height: 36px; border-radius: 50%; background: #dbeafe; color: #2563eb; display: flex; align-items: center; justify-content: center; font-weight: 600;">
          </div>
          <div>
            <div id="selectedUserName" style="font-weight: 600;"></div>
            <div id="selectedUserEmail" style="font-size: 0.8rem; color: #64748b;"></div>
          </div>
          <button type="button" onclick="clearSelectedUser()"
            style="margin-left: auto; background: none; border: none; color: #64748b; cursor: pointer;"><i
              class="fas fa-times"></i></button>
        </div>
      </div>
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem;">Role</label>
        <select name="role" class="form-control"
          style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px;">
          <option value="member">Member</option>
          <option value="manager">Manager</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
        <button type="button" onclick="closeInviteModal()"
          style="padding: 0.65rem 1.25rem; background: #f1f5f9; border: none; border-radius: 8px; color: #64748b; font-weight: 600; cursor: pointer;">Cancel</button>
        <button type="submit"
          style="padding: 0.65rem 1.25rem; background: #3b82f6; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">Add
          Member</button>
      </div>
    </form>
  </div>
</div>

<script>
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  let searchTimeout;

  // Search
  document.getElementById('memberSearch').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    document.querySelectorAll('#membersTable tr').forEach(row => {
      if (row.dataset.search) {
        row.style.display = row.dataset.search.includes(query) ? '' : 'none';
      }
    });
  });

  // Update role
  function updateRole(memberId, newRole) {
    const select = event.target;
    select.className = 'role-select role-' + newRole;

    fetch('/team/member/' + memberId + '/role/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: 'role=' + newRole
    })
      .then(r => r.json())
      .then(data => {
        if (!data.success) {
          alert(data.error || 'Failed to update role');
        }
      });
  }

  // Invite Modal
  function openInviteModal() {
    document.getElementById('inviteModal').style.display = 'flex';
  }

  function closeInviteModal() {
    document.getElementById('inviteModal').style.display = 'none';
    clearSelectedUser();
    document.getElementById('userSearchInput').value = '';
    document.getElementById('userSearchResults').style.display = 'none';
  }

  // User Search
  document.getElementById('userSearchInput').addEventListener('input', function () {
    clearTimeout(searchTimeout);
    const query = this.value.trim();

    if (query.length < 2) {
      document.getElementById('userSearchResults').style.display = 'none';
      return;
    }

    searchTimeout = setTimeout(() => {
      fetch('/team/search-users/?q=' + encodeURIComponent(query), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
        .then(r => r.json())
        .then(data => {
          const resultsDiv = document.getElementById('userSearchResults');
          if (data.users && data.users.length > 0) {
            resultsDiv.innerHTML = data.users.map(user => `
            <div onclick="selectUser(${user.id}, '${user.name}', '${user.email}')" style="padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid #f1f5f9;">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: #dbeafe; color: #2563eb; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600;">${user.initials}</div>
              <div>
                <div style="font-weight: 500;">${user.name}</div>
                <div style="font-size: 0.75rem; color: #64748b;">${user.email}</div>
              </div>
            </div>
          `).join('');
            resultsDiv.style.display = 'block';
          } else {
            resultsDiv.innerHTML = '<div style="padding: 1rem; color: #64748b; text-align: center;">No users found</div>';
            resultsDiv.style.display = 'block';
          }
        });
    }, 300);
  });

  function selectUser(id, name, email) {
    document.getElementById('selectedUserId').value = id;
    document.getElementById('selectedUserName').textContent = name;
    document.getElementById('selectedUserEmail').textContent = email;
    document.getElementById('selectedUserAvatar').textContent = name.split(' ').map(n => n[0]).join('').toUpperCase();
    document.getElementById('selectedUserDisplay').style.display = 'block';
    document.getElementById('userSearchInput').style.display = 'none';
    document.getElementById('userSearchResults').style.display = 'none';
  }

  function clearSelectedUser() {
    document.getElementById('selectedUserId').value = '';
    document.getElementById('selectedUserDisplay').style.display = 'none';
    document.getElementById('userSearchInput').style.display = 'block';
    document.getElementById('userSearchInput').value = '';
  }

  // Submit invite form
  document.getElementById('inviteForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const userId = document.getElementById('selectedUserId').value;
    const role = this.querySelector('[name=role]').value;

    if (!userId) {
      alert('Please select a user to add');
      return;
    }

    fetch('/team/add-member/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: `team_id={{ team.id }}&user_id=${userId}&role=${role}`
    })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert(data.error || 'Failed to add member');
        }
      });
  });

  // Close modal on outside click
  document.getElementById('inviteModal').addEventListener('click', function (e) {
    if (e.target === this) closeInviteModal();
  });
</script>
{% endblock %}