{% load static %}

<!-- Sidebar Overlay -->
<div id="taskDetailOverlay" class="task-detail-overlay" onclick="closeTaskDetailSidebar()"></div>

<!-- Task Detail Sidebar -->
<div id="taskDetailSidebar" class="task-detail-sidebar">
    <div class="sidebar-header">
        <h5 class="mb-0">Task Details</h5>
        <button type="button" class="btn-close" onclick="closeTaskDetailSidebar()"></button>
    </div>

    <div class="sidebar-content" id="taskDetailContent">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<style>
.task-detail-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1040;
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.task-detail-overlay.active {
    display: block;
    opacity: 1;
}

.task-detail-sidebar {
    position: fixed;
    top: 0;
    right: -600px;
    width: 600px;
    height: 100%;
    background: white;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    z-index: 1050;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
}

.task-detail-sidebar.active {
    right: 0;
}

.sidebar-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f9fafb;
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
}

.task-detail-header {
    margin-bottom: 2rem;
}

.task-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 1rem;
}

.task-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
}

.meta-item i {
    color: #9ca3af;
}

.task-section {
    margin-bottom: 2rem;
}

.section-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.task-description {
    color: #4b5563;
    line-height: 1.6;
    white-space: pre-wrap;
}

.task-related {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.related-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #2563eb;
    text-decoration: none;
    font-size: 0.875rem;
}

.related-link:hover {
    color: #1d4ed8;
    text-decoration: underline;
}

.comment-section {
    border-top: 1px solid #e5e7eb;
    padding-top: 1.5rem;
    margin-top: 1.5rem;
}

.comment-form {
    margin-bottom: 1.5rem;
}

.comment-form textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    resize: vertical;
    min-height: 80px;
    font-size: 0.875rem;
}

.comment-form textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.comment-submit-btn {
    margin-top: 0.75rem;
    padding: 0.5rem 1.5rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.comment-submit-btn:hover {
    background: #2563eb;
}

.comment-submit-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

.comments-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.task-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
}

.task-action-btn {
    flex: 1;
    padding: 0.625rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    background: white;
    color: #374151;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.task-action-btn:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

.task-action-btn.btn-complete {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.task-action-btn.btn-complete:hover {
    background: #059669;
    border-color: #059669;
}

.task-action-btn.btn-delete {
    background: #ef4444;
    color: white;
    border-color: #ef4444;
}

.task-action-btn.btn-delete:hover {
    background: #dc2626;
    border-color: #dc2626;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-badge.completed {
    background: #d1fae5;
    color: #065f46;
}

.status-badge.pending {
    background: #fef3c7;
    color: #92400e;
}

@media (max-width: 768px) {
    .task-detail-sidebar {
        width: 100%;
        right: -100%;
    }
}
</style>

<script>
function openTaskDetailSidebar(taskId) {
    const sidebar = document.getElementById('taskDetailSidebar');
    const overlay = document.getElementById('taskDetailOverlay');
    const content = document.getElementById('taskDetailContent');
    
    // Show sidebar and overlay
    sidebar.classList.add('active');
    overlay.classList.add('active');
    
    // Show loading state
    content.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    // Fetch task details
    fetch(`/todo/tasks/${taskId}/detail_ajax/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderTaskDetail(data.task);
            } else {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        Error loading task details
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    Failed to load task details
                </div>
            `;
        });
}

function closeTaskDetailSidebar() {
    const sidebar = document.getElementById('taskDetailSidebar');
    const overlay = document.getElementById('taskDetailOverlay');
    
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
}

function renderTaskDetail(task) {
    const content = document.getElementById('taskDetailContent');
    
    const priorityColors = {
        'low': '#d1fae5',
        'medium': '#fed7aa',
        'high': '#fecaca',
        'urgent': '#fca5a5'
    };
    
    const priorityIcons = {
        'low': 'fa-arrow-down',
        'medium': 'fa-minus',
        'high': 'fa-arrow-up',
        'urgent': 'fa-exclamation-triangle'
    };
    
    const dueDateClass = task.is_overdue ? 'text-danger' : (task.is_today ? 'text-warning' : 'text-muted');
    
    let relatedHtml = '';
    if (task.contact_name) {
        relatedHtml += `
            <a href="/contacts/${task.contact_id}/" class="related-link" target="_blank">
                <i class="fas fa-user"></i>
                ${task.contact_name}
            </a>
        `;
    }
    if (task.company_name) {
        relatedHtml += `
            <a href="/companies/${task.company_id}/" class="related-link" target="_blank">
                <i class="fas fa-building"></i>
                ${task.company_name}
            </a>
        `;
    }
    
    let commentsHtml = '';
    if (task.comments && task.comments.length > 0) {
        commentsHtml = task.comments.map(comment => `
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-author">${comment.author_name}</span>
                    <span class="comment-date">${comment.created_at}</span>
                </div>
                <div class="comment-content">${comment.content}</div>
            </div>
        `).join('');
    } else {
        commentsHtml = '<p class="text-muted text-center py-3">No comments yet</p>';
    }
    
    const actionsHtml = task.can_edit ? `
        <div class="task-actions">
            ${!task.completed ? `
                <button class="task-action-btn btn-complete" onclick="completeTaskFromSidebar(${task.id})">
                    <i class="fas fa-check"></i>
                    Complete
                </button>
            ` : ''}
            <button class="task-action-btn" onclick="editTaskFromSidebar(${task.id})">
                <i class="fas fa-edit"></i>
                Edit
            </button>
            <button class="task-action-btn btn-delete" onclick="deleteTaskFromSidebar(${task.id})">
                <i class="fas fa-trash"></i>
                Delete
            </button>
        </div>
    ` : '';
    
    content.innerHTML = `
        <div class="task-detail-header">
            <h3 class="task-title">${task.name}</h3>
            
            <div class="task-meta">
                <div class="meta-item">
                    <span class="priority-badge" style="background: ${priorityColors[task.priority]}; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">
                        <i class="fas ${priorityIcons[task.priority]}"></i>
                        ${task.priority_display}
                    </span>
                </div>
                
                <div class="meta-item">
                    <span class="status-badge ${task.completed ? 'completed' : 'pending'}">
                        <i class="fas ${task.completed ? 'fa-check-circle' : 'fa-clock'}"></i>
                        ${task.completed ? 'Completed' : 'Pending'}
                    </span>
                </div>
                
                <div class="meta-item ${dueDateClass}">
                    <i class="fas fa-calendar"></i>
                    <span>${task.due_date}</span>
                </div>
            </div>
        </div>
        
        <div class="task-section">
            <div class="section-title">Description</div>
            <div class="task-description">${task.description || '<em class="text-muted">No description provided</em>'}</div>
        </div>
        
        <div class="task-section">
            <div class="section-title">Details</div>
            <div class="task-meta">
                <div class="meta-item">
                    <i class="fas fa-user"></i>
                    <span><strong>Assigned to:</strong> ${task.member_name}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-user-plus"></i>
                    <span><strong>Created by:</strong> ${task.created_by_name}</span>
                </div>
            </div>
        </div>
        
        ${relatedHtml ? `
            <div class="task-section">
                <div class="section-title">Related</div>
                <div class="task-related">
                    ${relatedHtml}
                </div>
            </div>
        ` : ''}
        
        ${actionsHtml}
        
        <div class="comment-section">
            <div class="section-title">
                <i class="fas fa-comments"></i>
                Comments (${task.comments.length})
            </div>
            
            <div class="comment-form">
                <textarea id="commentContent" placeholder="Add a comment..."></textarea>
                <button class="comment-submit-btn" onclick="submitComment(${task.id})">
                    <i class="fas fa-paper-plane"></i>
                    Post Comment
                </button>
            </div>
            
            <div class="comments-list" id="commentsList">
                ${commentsHtml}
            </div>
        </div>
    `;
}

function submitComment(taskId) {
    const textarea = document.getElementById('commentContent');
    const content = textarea.value.trim();
    
    if (!content) {
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
    
    fetch(`/todo/tasks/${taskId}/add_comment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCsrfToken()
        },
        body: `content=${encodeURIComponent(content)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            textarea.value = '';
            // Reload task details to show new comment
            openTaskDetailSidebar(taskId);
        } else {
            alert('Failed to add comment');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add comment');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Post Comment';
    });
}

function completeTaskFromSidebar(taskId) {
    if (!confirm('Mark this task as complete?')) {
        return;
    }
    
    fetch(`/todo/tasks/${taskId}/complete_task`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            openTaskDetailSidebar(taskId); // Reload
            // Refresh the main task list
            if (typeof loadTasksForTab === 'function') {
                const activeTab = document.querySelector('.nav-link.active');
                if (activeTab) {
                    loadTasksForTab(activeTab.dataset.tab);
                }
            }
        } else {
            alert('Failed to complete task');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to complete task');
    });
}

function editTaskFromSidebar(taskId) {
    window.location.href = `/todo/tasks/${taskId}/update_task`;
}

function deleteTaskFromSidebar(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }
    
    fetch(`/todo/tasks/${taskId}/delete_task`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeTaskDetailSidebar();
            // Refresh the main task list
            if (typeof loadTasksForTab === 'function') {
                const activeTab = document.querySelector('.nav-link.active');
                if (activeTab) {
                    loadTasksForTab(activeTab.dataset.tab);
                }
            }
        } else {
            alert('Failed to delete task');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete task');
    });
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

// Close sidebar on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeTaskDetailSidebar();
    }
});
</script>

<style>
.comment-item {
    padding: 1rem;
    background: #f9fafb;
    border-radius: 0.5rem;
    border-left: 3px solid #3b82f6;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.comment-author {
    font-weight: 600;
    color: #111827;
    font-size: 0.875rem;
}

.comment-date {
    font-size: 0.75rem;
    color: #9ca3af;
}

.comment-content {
    color: #4b5563;
    font-size: 0.875rem;
    line-height: 1.5;
    white-space: pre-wrap;
}
</style>
