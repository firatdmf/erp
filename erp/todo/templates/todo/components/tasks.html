{% load todo_filters %}
{% load static %}
{% block css %}
{% comment %} CSS moved to base.html to prevent FOUC {% endcomment %}
{% endblock %}
<div class="tasks_component">
  {% comment %} {{ page_type }} {% endcomment %}
  {% comment %} <p>user is: {{member}}</p> {% endcomment %}
  <ul>
    <!-- Meetings Section -->
    {% for meeting in meetings %}
    <li class="taskComponent meeting-card"
      style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; border-left: 5px solid {% if meeting.scheduled_at|timeuntil|slice:':1' == '-' or meeting.scheduled_at|timesince != '0 minutes' and meeting.scheduled_at < now %}#f59e0b{% else %}#3b82f6{% endif %}; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 1rem; padding: 1.25rem; transition: transform 0.2s, box-shadow 0.2s;">

      <!-- Header -->
      <div class="task-card-header"
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
        <div>
          <h3 class="taskName"
            style="color: #1e293b; font-size: 1.1rem; font-weight: 600; margin: 0 0 0.25rem 0; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-video"
              style="color: {% if meeting.scheduled_at|timeuntil|slice:':1' == '-' or meeting.scheduled_at|timesince != '0 minutes' and meeting.scheduled_at < now %}#f59e0b{% else %}#3b82f6{% endif %};"></i>
            {{ meeting.title }}
          </h3>
          <div class="task-date-badges"
            style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.85rem; color: #64748b;">
            <span><i class="far fa-clock"></i> {{ meeting.scheduled_at|date:"H:i" }} ({{ meeting.duration_minutes }}m)</span>

            <!-- Overdue/Live Logic -->
            {% now "Y-m-d H:i" as current_time %}
            {% if meeting.scheduled_at|date:"Y-m-d H:i" < current_time %} <span
              style="color: #d97706; background: #fffbeb; padding: 2px 8px; border-radius: 12px; font-weight: 500; font-size: 0.75rem; border: 1px solid #fcd34d;">
              <i class="fas fa-exclamation-circle"></i> Started {{ meeting.scheduled_at|timesince }} ago
              </span>
              {% else %}
              <span
                style="color: #3b82f6; background: #eff6ff; padding: 2px 8px; border-radius: 12px; font-weight: 500; font-size: 0.75rem;">
                Starts in {{ meeting.scheduled_at|timeuntil }}
              </span>
              {% endif %}
          </div>
        </div>

        <!-- Action Button (Top Right aligned for visibility) -->
        {% if meeting.meeting_link %}
        <a href="{{ meeting.meeting_link }}" target="_blank"
          style="background: #2563eb; color: white; border: none; text-decoration: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); transition: background 0.2s;">
          <i class="fas fa-video"></i> Join Meeting
        </a>
        {% endif %}
      </div>

      <!-- Description -->
      {% if meeting.description %}
      <div class="task-description" style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem; line-height: 1.5;">
        {{ meeting.description|truncatewords:20 }}
      </div>
      {% endif %}

      <!-- Footer -->
      <div class="task-footer-row"
        style="display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #f1f5f9; padding-top: 0.75rem; margin-top: auto;">
        <div class="task-assignee" style="display: flex; align-items: center; gap: 0.5rem;">
          <div class="avatar-circle"
            style="background: #e2e8f0; color: #64748b; width: 28px; height: 28px; font-size: 0.8rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">
            {{ meeting.organizer.first_name|first }}{{ meeting.organizer.last_name|first }}
          </div>
          <span class="assignee-name" style="font-size: 0.85rem; color: #475569; font-weight: 500;">
            Organizer: {{ meeting.organizer.get_full_name }}
          </span>
        </div>
      </div>
    </li>
    {% endfor %}

    {% for task in tasks|task_sort:sort_type %}
    {% if 'report' in page_type and task.member == member %}
    {% if not task.completed %}
    <li class="taskComponent" data-task-id="{{ task.id }}">
      <p class="taskName">
        {{ task.name }}
        {% if not 'detail' in page_type %}
        {% if task.contact %}
        -
        <b><a href="{% url 'crm:contact_detail' task.contact.id %}">{{ task.contact }}</a></b>
        {% elif task.company %}
        -
        <b><a href="{% url 'crm:company_detail' task.company.id %}">{{ task.company }}</a></b>
        {% endif %}
        {% endif %}
      </p>
      {% if task.description %}
      <p class="taskDescription">{{ task.description|linebreaksbr }}</p>
      {% endif %}
      <p class="taskDueDate">
        Due: {{ task.due_date }}
        {% if task.due_date|days_since == False %}
        <span></span>
        {% elif task.due_date|days_since == 'today' %}
        <span class="daysDueToday">{{ task.due_date|days_since }}</span>
        {% elif task.due_date|days_since != 'today' %}
        <span class="daysDueBox"><span class="daysDuePast">{{ task.due_date|days_since }}</span></span>
        {% endif %}
      </p>
      {% comment %} {% if not 'detail' in page_type %}
      {{task.completed}}
      {% endif %} {% endcomment %}
      <div class="task_buttons">
        <button type="button" class="completeTaskButton" onclick="completeTask('{{ task.id }}', this)">Complete
          Task</button>
        <button type="button" onclick="openTaskEditSidebar('{{ task.id }}')">Update Task</button>
        <button type="button" class="deleteTaskButton" onclick="confirmDeleteTask('{{ task.id }}', this)">Delete
          Task</button>
        <br />
      </div>
      {% if task.member %}
      <div class="task_assigned_member">
        <p>
          {{task.member}}
        </p>
      </div>
      {% endif %}
    </li>
    {% endif %}
    {% else %}
    {% comment %} {% if not task.completed and task.due_date|is_past_due %} {% endcomment %}
    {% comment %} is_past_due so we won't see tasks due in future days than today in the dashboard {% endcomment %}
    {% comment %} For dashboard calendar view, show all tasks for selected date regardless of due date {% endcomment %}
    {% if 'dashboard_calendar' in page_type or not task.completed and task.due_date|is_past_due %}
    {% if 'dashboard_calendar' in page_type or not task.member or task.member == member %}
    {% with can_edit=task|can_edit:member %}
    <li class="taskComponent" data-task-id="{{ task.id }}" {% if can_edit %}onclick="openTaskEditSidebar('{{ task.id }}')" {% else %}style="cursor: default;" {% endif %}>
      <!-- Compact Card Header -->
      <div class="task-card-header">
        <h3 class="taskName">{{ task.name }}</h3>
        <div class="task-date-badges">
          <span class="taskDueDate">
            <i class="fa fa-calendar-alt"></i> {{ task.due_date|date:"M. d, Y" }}
          </span>
          {% if task.due_date|days_since == 'today' %}
          <span class="badge badge-today">TODAY</span>
          {% elif task.due_date|days_since != False and task.due_date|days_since != 'today' %}
          <span class="badge badge-overdue">{{ task.due_date|days_since|upper }}</span>
          {% endif %}
        </div>
      </div>

      <!-- Related Link (Company/Contact) -->
      {% if task.contact or task.company %}
      <div class="task-related-row">
        {% if task.contact %}
        <a href="{% url 'crm:contact_detail' task.contact.id %}" class="related-link" onclick="event.stopPropagation()">
          <i class="fa fa-link"></i> {{ task.contact.name }}
        </a>
        {% elif task.company %}
        <a href="{% url 'crm:company_detail' task.company.id %}" class="related-link" onclick="event.stopPropagation()">
          <i class="fa fa-link"></i> {{ task.company }}
        </a>
        {% endif %}
      </div>
      {% endif %}

      <!-- Task Description -->
      {% if task.description %}
      <div class="task-description">
        {{ task.description|truncatewords:15 }}
      </div>
      {% endif %}

      <!-- Footer: Assignee & Actions -->
      <div class="task-footer-row">
        <div class="task-assignee">
          <div class="avatar-circle">
            <i class="fa fa-user"></i>
          </div>
          <span class="assignee-name">
            {% if task.member %}
            {{ task.member.user.get_full_name|default:task.member.user.username }}
            {% else %}
            Unassigned
            {% endif %}
          </span>
        </div>

        <div class="task-actions">
          <button type="button" class="btn-complete"
            onclick="event.stopPropagation(); completeTask('{{ task.id }}', this)">
            <i class="fa fa-check"></i> Complete
          </button>
          <button type="button" class="btn-edit"
            onclick="event.stopPropagation(); window.location.href='{% url 'todo:task_detail' task.id %}'">
            <i class="fa fa-eye"></i> View
          </button>
          {% if can_edit %}
          <button type="button" class="btn-delete"
            onclick="event.stopPropagation(); confirmDeleteTask('{{ task.id }}', this)">
            <i class="fa fa-trash"></i>
          </button>
          {% else %}
          <button type="button" class="btn-delete" disabled
            style="opacity: 0.4; cursor: not-allowed; pointer-events: none;">
            <i class="fa fa-lock"></i>
          </button>
          {% endif %}
        </div>
      </div>
    </li>
    {% endwith %}
    {% endif %}
    {% else %}
    {% comment %} <a href="{% url 'todo:update_task' task.pk %}">
      <p class="error" style="color:red;">{{ task.name }}</p>
    </a> {% endcomment %}
    {% endif %}
    {% endif %}
    {% empty %}
    {% if not team_tasks %}
    <li>No tasks available.</li>
    {% endif %}
    {% endfor %}

    <!-- Team Tasks Section -->
    {% for task in team_tasks %}
    {% with can_manage=task|can_manage_team_task:request.user %}
    <li class="taskComponent team-task-card" data-task-id="team-{{ task.id }}" {% if can_manage %}onclick="openTeamTaskEditSidebar('{{ task.id }}')" {% else %}style="cursor: default;" {% endif %}>
      <!-- Compact Card Header -->
      <div class="task-card-header">
        <h3 class="taskName">
          <span style="color: #7c3aed; font-size: 0.75rem; margin-right: 0.5rem;"><i class="fas fa-users"></i></span>
          {{ task.title }}
        </h3>
        <div class="task-date-badges">
          <span class="taskDueDate">
            <i class="fa fa-calendar-alt"></i> {{ task.due_date|date:"M. d, Y" }}
          </span>
          <span class="badge" style="background: #ede9fe; color: #7c3aed;">{{ task.team.name }}</span>
        </div>
      </div>

      <!-- Task Description -->
      {% if task.description %}
      <div class="task-description">
        {{ task.description|truncatewords:15 }}
      </div>
      {% endif %}

      <!-- Footer: Priority & Status -->
      <div class="task-footer-row">
        <div class="task-assignee">
          <span class="badge" style="background: 
            {% if task.priority == 'high' %}#fecaca; color: #dc2626;
            {% elif task.priority == 'medium' %}#fed7aa; color: #ea580c;
            {% else %}#d1fae5; color: #059669;{% endif %}">
            {{ task.get_priority_display }}
          </span>
          <span class="badge" style="background: #dbeafe; color: #2563eb; margin-left: 0.5rem;">
            {{ task.get_status_display }}
          </span>
        </div>

        <div class="task-actions">
          <button type="button" class="btn-edit"
            onclick="event.stopPropagation(); window.location.href='{% url 'team:task_detail' task.id %}'">
            <i class="fa fa-eye"></i> View
          </button>
          {% if can_manage %}
          <button type="button" class="btn-delete"
            onclick="event.stopPropagation(); confirmDeleteTeamTask('{{ task.id }}', this)">
            <i class="fa fa-trash"></i>
          </button>
          {% else %}
          <button type="button" class="btn-delete" disabled
            style="opacity: 0.4; cursor: not-allowed; pointer-events: none;">
            <i class="fa fa-lock"></i>
          </button>
          {% endif %}
        </div>
      </div>
    </li>
    {% endwith %}
    {% endfor %}
  </ul>
</div>

<script>
  function confirmDeleteTask(taskId, button) {
    const taskComponent = button.closest('.taskComponent');

    // Create modern confirmation modal
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease;';

    const dialog = document.createElement('div');
    dialog.className = 'modal-dialog';
    dialog.style.cssText = 'background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); max-width: 400px; width: 90%; animation: slideUp 0.3s ease;';

    dialog.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
      <div style="width: 48px; height: 48px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
        <i class="fa fa-trash" style="color: #ef4444; font-size: 20px;"></i>
      </div>
      <h3 style="margin: 0; color: #1f2937; font-size: 1.25rem; font-weight: 600;">Delete Task</h3>
    </div>
    <p style="margin: 0 0 1.5rem; color: #6b7280; line-height: 1.5;">Are you sure you want to delete this task? This action cannot be undone.</p>
    <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
      <button onclick="this.closest('.modal-overlay').remove()" 
              style="padding: 0.625rem 1.25rem; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;" 
              onmouseover="this.style.background='#f9fafb'" 
              onmouseout="this.style.background='white'">Cancel</button>
      <button onclick="deleteTaskHTMX('${taskId}', this)" 
              style="padding: 0.625rem 1.25rem; border: none; background: #ef4444; color: white; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;" 
              onmouseover="this.style.background='#dc2626'" 
              onmouseout="this.style.background='#ef4444'">Delete</button>
    </div>
  `;

    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    // Close on outside click
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.remove();
    });
  }

  function deleteTaskHTMX(taskId, button) {
    const overlay = button.closest('.modal-overlay');
    const taskComponent = document.querySelector(`[data-task-id="${taskId}"]`)?.closest('.taskComponent');

    if (!taskComponent) {
      console.error('Task component not found');
      overlay.remove();
      return;
    }

    // Change button to loading state
    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Deleting...';
    button.disabled = true;

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Send delete request with HTMX headers
    fetch(`/todo/tasks/${taskId}/delete_task`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest',
        'HX-Request': 'true'
      }
    })
      .then(response => {
        if (response.ok) {
          // Remove modal
          overlay.remove();

          // Smooth fade out animation
          taskComponent.style.transition = 'all 0.3s ease';
          taskComponent.style.opacity = '0';
          taskComponent.style.transform = 'translateX(-20px)';

          setTimeout(() => {
            taskComponent.remove();

            // Check if there are no more tasks
            const tasksList = document.querySelector('.tasks_component ul');
            if (tasksList && tasksList.children.length === 0) {
              tasksList.innerHTML = '<li style="text-align: center; padding: 2rem; color: var(--text-secondary);">No tasks available.</li>';
            }

            // Update calendar badge count if on dashboard
            updateCalendarBadge();
          }, 300);

          // Show success toast
          showToast('Task deleted successfully', 'success');
        } else {
          overlay.remove();
          showToast('Failed to delete task. Please try again.', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        overlay.remove();
        showToast('An error occurred. Please try again.', 'error');
      });
  }

  // Toast notification system
  function showToast(message, type = 'success') {
    // Remove existing toasts
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = 'toast-notification';

    const colors = {
      success: { bg: '#10b981', icon: 'fa-check-circle' },
      error: { bg: '#ef4444', icon: 'fa-exclamation-circle' },
      info: { bg: '#3b82f6', icon: 'fa-info-circle' }
    };

    const color = colors[type] || colors.success;

    toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    z-index: 10000;
    animation: slideInRight 0.3s ease;
    max-width: 400px;
  `;

    toast.innerHTML = `
    <div style="width: 40px; height: 40px; background: ${color.bg}; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
      <i class="fa ${color.icon}" style="color: white; font-size: 18px;"></i>
    </div>
    <span style="color: #1f2937; font-weight: 500;">${message}</span>
    <button onclick="this.parentElement.remove()" 
            style="margin-left: auto; background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 20px; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;"
            onmouseover="this.style.color='#6b7280'" 
            onmouseout="this.style.color='#9ca3af'">
      <i class="fa fa-times"></i>
    </button>
  `;

    document.body.appendChild(toast);

    // Auto remove after 4 seconds
    setTimeout(() => {
      toast.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // Complete task with animation
  function completeTask(taskId, button) {
    const taskComponent = button.closest('.taskComponent');

    if (!taskComponent) {
      console.error('Task component not found');
      return;
    }

    // Change button to loading state
    const originalButtonContent = button.innerHTML;
    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
    button.disabled = true;

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Send complete request
    fetch(`/todo/tasks/${taskId}/complete_task`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
      .then(response => {
        if (response.ok) {
          // Add completion animation
          taskComponent.style.transition = 'all 0.5s ease';
          taskComponent.style.opacity = '0.5';
          taskComponent.style.transform = 'scale(0.95)';

          // Add checkmark overlay
          const checkmark = document.createElement('div');
          checkmark.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        background: #10b981;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: checkmarkPop 0.3s ease;
        z-index: 100;
      `;
          checkmark.innerHTML = '<i class="fa fa-check" style="color: white; font-size: 30px;"></i>';

          taskComponent.style.position = 'relative';
          taskComponent.appendChild(checkmark);

          // Remove task after animation
          setTimeout(() => {
            taskComponent.style.transform = 'translateX(-100%)';

            setTimeout(() => {
              taskComponent.remove();

              // Check if there are no more tasks
              const tasksList = document.querySelector('.tasks_component ul');
              if (tasksList && tasksList.children.length === 0) {
                tasksList.innerHTML = '<li style="text-align: center; padding: 2rem; color: var(--text-secondary);">No tasks available.</li>';
              }

              // Update calendar badge and pending count
              updateCalendarBadge();
            }, 500);
          }, 800);

          // Show success toast
          showToast('Task completed successfully! ðŸŽ‰', 'success');
        } else {
          // Revert button state
          button.innerHTML = originalButtonContent;
          button.disabled = false;
          showToast('Failed to complete task. Please try again.', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        button.innerHTML = originalButtonContent;
        button.disabled = false;
        showToast('An error occurred. Please try again.', 'error');
      });
  }

  // Update calendar badge count after task deletion
  function updateCalendarBadge() {
    // Only on dashboard with calendar
    if (!document.getElementById('calendarDays')) return;

    // Get the selected date from global scope (dashboard.html)
    const targetDate = window.selectedDate || new Date();
    const year = targetDate.getFullYear();
    const month = String(targetDate.getMonth() + 1).padStart(2, '0');
    const day = String(targetDate.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`;

    // Update global tasksData if it exists
    if (window.tasksData && window.tasksData[dateStr]) {
      const currentCount = window.tasksData[dateStr];
      const newCount = currentCount - 1;

      if (newCount > 0) {
        window.tasksData[dateStr] = newCount;
      } else {
        delete window.tasksData[dateStr];
      }
    }

    // Find the calendar day element and update badge
    const calendarDays = document.querySelectorAll('.calendar-day');
    calendarDays.forEach(dayEl => {
      // Check if this is the selected day
      if (dayEl.classList.contains('selected')) {
        const badge = dayEl.querySelector('.task-badge');
        if (badge) {
          const currentCount = parseInt(badge.textContent) || 0;
          const newCount = currentCount - 1;

          if (newCount > 0) {
            badge.textContent = newCount;
          } else {
            // Remove badge and has-tasks class
            dayEl.classList.remove('has-tasks');
            badge.remove();

            // Update day element to show just the number
            const dayNumber = dayEl.textContent.trim();
            dayEl.innerHTML = dayNumber;
          }
        }
      }
    });

    // Update pending tasks counter
    updatePendingTasksCount();
  }

  // Update pending tasks counter in stats bar
  function updatePendingTasksCount() {
    // Get all task components currently in the DOM (excluding completed ones)
    const allTasksInView = document.querySelectorAll('.tasks-container .taskComponent');
    const currentViewCount = allTasksInView.length;

    // Find the stat-number elements
    const statNumbers = document.querySelectorAll('.stat-number');

    // The second stat-number is "Pending Tasks" (index 1)
    if (statNumbers.length >= 2) {
      const currentPendingCount = parseInt(statNumbers[1].textContent) || 0;
      const newPendingCount = Math.max(0, currentPendingCount - 1);
      statNumbers[1].textContent = newPendingCount;
    }
  }

  // Add CSS animations
  if (!document.getElementById('toast-animations')) {
    const style = document.createElement('style');
    style.id = 'toast-animations';
    style.textContent = `
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes slideInRight {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
    @keyframes checkmarkPop {
      0% { transform: translate(-50%, -50%) scale(0); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
  `;
    document.head.appendChild(style);
  }

  // Listen for HTMX events for toast notifications
  document.body.addEventListener('showToast', function (evt) {
    const detail = evt.detail;
    if (detail && detail.message) {
      showToast(detail.message, detail.type || 'success');
    }
  });

  // Team Task Deletion Logic
  function confirmDeleteTeamTask(taskId, button) {
    // Create modern confirmation modal
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease;';

    const dialog = document.createElement('div');
    dialog.className = 'modal-dialog';
    dialog.style.cssText = 'background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); max-width: 400px; width: 90%; animation: slideUp 0.3s ease;';

    dialog.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
      <div style="width: 48px; height: 48px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
        <i class="fa fa-trash" style="color: #ef4444; font-size: 20px;"></i>
      </div>
      <h3 style="margin: 0; color: #1f2937; font-size: 1.25rem; font-weight: 600;">Delete Team Task</h3>
    </div>
    <p style="margin: 0 0 1.5rem; color: #6b7280; line-height: 1.5;">Are you sure you want to delete this team task? This action cannot be undone.</p>
    <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
      <button onclick="this.closest('.modal-overlay').remove()" 
              style="padding: 0.625rem 1.25rem; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;" 
              onmouseover="this.style.background='#f9fafb'" 
              onmouseout="this.style.background='white'">Cancel</button>
      <button onclick="deleteTeamTaskHTMX('${taskId}', this)" 
              style="padding: 0.625rem 1.25rem; border: none; background: #ef4444; color: white; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;" 
              onmouseover="this.style.background='#dc2626'" 
              onmouseout="this.style.background='#ef4444'">Delete</button>
    </div>
  `;

    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.remove();
    });
  }

  function deleteTeamTaskHTMX(taskId, button) {
    const overlay = button.closest('.modal-overlay');
    // Note: Data attribute for team tasks is team-{{id}} 
    // Usually the ID passed here is just the numeric ID, so we look for data-task-id="team-ID"
    const taskComponent = document.querySelector(`[data-task-id="team-${taskId}"]`)?.closest('.taskComponent');

    if (!taskComponent) {
      console.error('Task component not found for team task ' + taskId);
      overlay.remove();
      return;
    }

    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Deleting...';
    button.disabled = true;

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Use TEAM delete URL
    fetch(`/team/task/${taskId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          overlay.remove();
          taskComponent.style.transition = 'all 0.3s ease';
          taskComponent.style.opacity = '0';
          taskComponent.style.transform = 'translateX(-20px)';

          setTimeout(() => {
            taskComponent.remove();
            // Check empty state if needed...
            const teamTasksList = document.querySelector('.tasks_component ul');
            // If we want to show 'No tasks' we'd check children count. 
            // Logic mirrors personal tasks but assumes mixed list.
          }, 300);

          showToast('Team task deleted successfully', 'success');
        } else {
          overlay.remove();
          showToast(data.error || 'Failed to delete task', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        overlay.remove();
        showToast('An error occurred.', 'error');
      });
  }

  // Team Task Edit Sidebar Logic

  // Global function for toggling user search in edit forms (needed because AJAX-loaded scripts don't execute)
  function toggleEditUserSearch() {
    const c = document.getElementById('editUserSearchContainer');
    if (c) {
      c.style.display = c.style.display === 'none' ? 'block' : 'none';
      if (c.style.display === 'block') {
        const input = c.querySelector('input');
        if (input) input.focus();
      }
    }
  }

  let editSearchTimeout;
  function searchUsersForEdit(query) {
    clearTimeout(editSearchTimeout);
    if (!query) {
      const results = document.getElementById('editUserSearchResults');
      if (results) results.style.display = 'none';
      return;
    }

    editSearchTimeout = setTimeout(() => {
      fetch(`/team/search-users/?q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
          const res = document.getElementById('editUserSearchResults');
          if (!res) return;
          res.innerHTML = '';

          // Filter out already-added users to prevent duplicates
          const input = document.getElementById('edit_assigned_users');
          const currentIds = input && input.value ? input.value.split(',').filter(x => x).map(x => x.trim()) : [];
          const filteredUsers = (data.users || []).filter(u => !currentIds.includes(String(u.id)));

          if (filteredUsers.length > 0) {
            filteredUsers.forEach(u => {
              // API returns: id, name, email, initials
              const initials = u.initials || '?';
              const fullName = u.name || 'Unknown User';

              const div = document.createElement('div');
              div.className = 'search-result-item';
              div.style.cssText = 'padding:0.5rem; cursor:pointer; display:flex; align-items:center; gap:0.5rem;';
              div.innerHTML = `<div style="width:28px;height:28px;background:#e0e7ff;color:#4f46e5;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:600;">${initials}</div><span>${fullName}</span>`;
              div.onclick = () => selectUserForEdit(u);
              res.appendChild(div);
            });
            res.style.display = 'block';
          } else if (data.users && data.users.length > 0) {
            res.innerHTML = '<div style="padding:0.75rem; color:#94a3b8; font-size:0.85rem;">All matching users already added</div>';
            res.style.display = 'block';
          } else {
            res.innerHTML = '<div style="padding:0.75rem; color:#94a3b8; font-size:0.85rem;">No users found</div>';
            res.style.display = 'block';
          }
        });
    }, 300);
  }

  function selectUserForEdit(user) {
    const container = document.getElementById('editSelectedUsersList');
    const input = document.getElementById('edit_assigned_users');
    const results = document.getElementById('editUserSearchResults');
    const searchContainer = document.getElementById('editUserSearchContainer');

    if (!container || !input) return;

    // Check if already added
    const currentIds = input.value ? input.value.split(',').filter(x => x) : [];
    if (currentIds.includes(String(user.id))) {
      if (results) results.style.display = 'none';
      if (searchContainer) searchContainer.style.display = 'none';
      return;
    }

    // Add chip - API returns: id, name, email, initials
    const fullName = user.name || 'Unknown User';

    const chip = document.createElement('div');
    chip.className = 'user-chip';
    chip.dataset.userId = user.id;
    chip.style.cssText = 'background:#e2e8f0; padding:0.2rem 0.6rem; border-radius:1rem; font-size:0.85rem; display:flex; align-items:center; gap:0.4rem;';
    chip.innerHTML = `<span>${fullName}</span><button type="button" style="background:none;border:none;cursor:pointer;color:#94a3b8;" onclick="removeEditUser(${user.id})"><i class="fas fa-times"></i></button>`;
    container.appendChild(chip);

    // Update hidden input
    currentIds.push(String(user.id));
    input.value = currentIds.join(',');

    // Hide search
    if (results) results.style.display = 'none';
    if (searchContainer) {
      searchContainer.style.display = 'none';
      const searchInput = searchContainer.querySelector('input');
      if (searchInput) searchInput.value = '';
    }
  }

  function removeEditUser(userId) {
    const container = document.getElementById('editSelectedUsersList');
    const input = document.getElementById('edit_assigned_users');

    if (!container || !input) return;

    // Template uses data-id, not data-user-id
    const chip = container.querySelector(`[data-id="${userId}"], [data-user-id="${userId}"]`);
    if (chip) chip.remove();

    const currentIds = input.value ? input.value.split(',').filter(x => x && x !== String(userId)) : [];
    input.value = currentIds.join(',');
  }

  function openTeamTaskEditSidebar(taskId) {
    const sidebar = document.getElementById('taskEditSidebar');
    const content = document.getElementById('taskEditContent');

    // Show sidebar
    sidebar.classList.add('active');

    // Update header title
    const title = sidebar.querySelector('.sidebar-title h2');
    if (title) title.textContent = 'Edit Team Task';

    // Show loading
    content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);"><i class="fa fa-spinner fa-spin fa-2x"></i><p style="margin-top: 1rem;">Loading team task...</p></div>';

    // Load form
    fetch(`/team/task/${taskId}/edit-form/`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(r => {
        if (!r.ok) throw new Error('Network error');
        return r.text();
      })
      .then(html => {
        content.innerHTML = html;
      })
      .catch(err => {
        console.error(err);
        content.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 2rem;">Failed to load task.</div>';
      });
  }

  function handleTeamTaskEditFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    // ... similar logic to personal task edit ...
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Saving...';

    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': '{{ csrf_token }}' // Ensure we have token available or get from cookie
      }
    })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          closeTaskEditSidebar();
          showToast('Team task updated successfully');
          // Ideally update DOM or reload
          setTimeout(() => window.location.reload(), 500); // Reload for simplicity to reflect changes
        } else {
          alert('Failed: ' + (data.error || 'Unknown error'));
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      })
      .catch(err => {
        console.error(err);
        alert('Error saving task');
        btn.disabled = false;
        btn.innerHTML = originalText;
      });
  }
</script>