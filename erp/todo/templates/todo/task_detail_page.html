{% extends "base.html" %}
{% load static %}

{% block css %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

  :root {
    --bg-body: #F9FAFB;
    /* Lighter background */
    --bg-card: #FFFFFF;
    --border-color: #E5E7EB;
    --text-primary: #111827;
    --text-secondary: #6B7280;
    --brand-color: #4F46E5;
    /* Indigo */
    --brand-hover: #4338CA;
    --danger-color: #EF4444;
    --radius-md: 12px;
    --radius-sm: 8px;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  /* Global Box Sizing */
  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  body {
    background-color: var(--bg-body);
    font-family: 'Inter', sans-serif;
    color: var(--text-primary);
  }

  /* Layout */
  .layout-container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 0 3rem;
    display: flex;
    gap: 4rem;
    align-items: flex-start;
  }

  /* Main Column */
  .main-column {
    flex: 1;
    min-width: 0;
  }

  /* Sidebar Column */
  .sidebar-column {
    width: 320px;
    flex-shrink: 0;
    margin-right: 0;
  }

  /* Typography */
  h1.page-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    line-height: 1.2;
    letter-spacing: -0.02em;
  }

  .breadcrumbs {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
  }

  .breadcrumbs a {
    color: var(--text-secondary);
    text-decoration: none;
  }

  .breadcrumbs .badge {
    background: #EEF2FF;
    color: var(--brand-color);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .meta-info {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    color: var(--text-secondary);
    font-size: 0.925rem;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Description */
  .section-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: #9CA3AF;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .description-box {
    color: #374151;
    line-height: 1.6;
    margin-bottom: 3rem;
    font-size: 1rem;
  }

  /* Activity Section */
  .activity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .activity-heading {
    font-size: 1.25rem;
    font-weight: 600;
  }

  /* Pill Switcher */
  .pill-switcher {
    display: flex;
    background: #F3F4F6;
    padding: 4px;
    border-radius: 8px;
    gap: 4px;
  }

  .pill-btn {
    border: none;
    background: transparent;
    padding: 6px 16px;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .pill-btn.active {
    background: white;
    color: var(--text-primary);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    font-weight: 600;
  }

  /* Editor */
  .editor-wrapper {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #E0E7FF;
    color: var(--brand-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
  }

  .editor-card {
    flex: 1;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s;
  }

  .editor-card:focus-within {
    border-color: #cbd5e1;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
  }

  .editor-textarea {
    width: 100%;
    border: none;
    padding: 1rem 1rem 0.5rem 1rem;
    min-height: 80px;
    resize: none;
    font-family: inherit;
    font-size: 0.95rem;
    outline: none;
    border-radius: 12px 12px 0 0;
  }

  .editor-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
    border-top: 1px solid #F3F4F6;
    background: #FAFAFA;
    border-radius: 0 0 12px 12px;
  }

  .editor-tools {
    display: flex;
    gap: 1rem;
    color: #9CA3AF;
    font-size: 1.1rem;
  }

  .editor-tools i {
    cursor: pointer;
    transition: color 0.2s;
  }

  .editor-tools i:hover {
    color: var(--text-secondary);
  }

  .btn-primary {
    background: var(--brand-color);
    color: white;
    border: none;
    padding: 6px 16px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-primary:hover {
    background: var(--brand-hover);
  }

  /* Lists */
  .comment-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .comment-row {
    display: flex;
    gap: 1rem;
  }

  .comment-content {
    background: #F3F4F6;
    padding: 1rem;
    border-radius: 0 12px 12px 12px;
    font-size: 0.95rem;
    color: #374151;
    line-height: 1.5;
  }

  .comment-header {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .user-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
  }

  .time-text {
    font-size: 0.75rem;
    color: var(--text-secondary);
  }

  /* Sidebar Widgets */
  .sidebar-widget {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-sm);
  }

  .form-group {
    margin-bottom: 1.25rem;
  }

  .form-group:last-child {
    margin-bottom: 0;
  }

  .form-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 700;
    color: #9CA3AF;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  /* Interactive Dropdown (Status) */
  .select-box {
    width: 100%;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.6rem 0.75rem;
    font-size: 0.9rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .select-box:hover {
    border-color: #cbd5e1;
  }

  /* Static Box (Priority/Date) */
  .static-box {
    width: 100%;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.6rem 0.75rem;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    color: var(--text-primary);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
  }

  /* Facepile */
  .facepile-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .facepile-group {
    display: flex;
    align-items: center;
  }

  .facepile-img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid white;
    margin-left: -8px;
    background: #E5E7EB;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    color: #6B7280;
    font-weight: 600;
  }

  .facepile-img:first-child {
    margin-left: 0;
  }

  /* Reporter */
  .reporter-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
    margin-top: 1rem;
  }

  /* Hide tabs logic */
  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Modal Overlay - HIDDEN BY DEFAULT */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.2);
    display: none;
    /* Crucial */
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal-overlay.active {
    display: flex;
  }

  .dropdown-menu {
    background: white;
    padding: 0.5rem;
    border-radius: 8px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    min-width: 200px;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .dropdown-item {
    padding: 0.5rem 1rem;
    text-align: left;
    background: none;
    border: none;
    font-size: 0.875rem;
    color: #374151;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.1s;
  }

  .dropdown-item:hover {
    background: #F3F4F6;
  }
</style>
{% endblock %}

{% block content %}
<div class="layout-container">

  <!-- Main Content -->
  <div class="main-column">

    <!-- Top Nav -->
    <div class="breadcrumbs">
      <a href="/">Dashboard</a> <span>/</span>
      <a href="{% url 'todo:tasks_list' %}">Tasks</a> <span>/</span>
      <span class="badge">TASK-{{ task.id }}</span>
    </div>

    <!-- Title -->
    <h1 class="page-title">{{ task.title|default:task.name }}</h1>

    <!-- Meta -->
    <div class="meta-info">
      <div class="meta-item">
        <i class="far fa-clock"></i> Due {{ task.due_date|date:"F j, Y" }}
      </div>
      <div class="meta-item">
        <i class="far fa-user"></i> {{ task.member.user.get_full_name }}
      </div>
      <!-- Helper Actions -->
      {% if task.created_by == request.user.member %}
      <div class="meta-item" style="margin-left: auto;">
        <a href="#" onclick="openTaskEditSidebar('{{ task.id }}')" style="color:inherit; text-decoration:none;"><i
            class="fa fa-pen"></i></a>
        <a href="#" onclick="if(confirm('Delete?')) document.getElementById('delTask').submit()"
          style="color:var(--danger-color); margin-left:1rem;"><i class="fa fa-trash"></i></a>
        <form id="delTask" method="POST" action="{% url 'todo:delete_task' task.id %}" style="display:none;">{%
          csrf_token %}</form>
      </div>
      {% endif %}
    </div>

    <!-- Description -->
    <div style="margin-bottom: 3rem;">
      <div class="section-title">Description</div>
      <div class="description-box">
        {% if task.description %}
        {{ task.description|linebreaksbr }}
        {% else %}
        <span style="color:#9CA3AF; font-style:italic;">No description provided.</span>
        {% endif %}
      </div>
    </div>

    <!-- Attachments (Relocated) -->
    {% if task.attachments.all %}
    <div style="margin-bottom: 3rem;">
      <div class="section-title">Attachments</div>
      <div style="display:flex; flex-wrap:wrap; gap:1rem;">
        {% for att in task.attachments.all %}
        <div
          style="background:white; border:1px solid #E5E7EB; border-radius:8px; padding:0.75rem; width:100%; max-width:300px; display:flex; align-items:center; gap:0.75rem;">
          <div
            style="width:40px; height:40px; background:#F3F4F6; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#EF4444; font-size:1.2rem;">
            <i class="far fa-file-pdf"></i>
          </div>
          <div style="flex:1; overflow:hidden;">
            <div
              style="font-size:0.9rem; font-weight:500; color:#374151; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
              title="{{ att.file_name }}">
              {{ att.file_name }}
            </div>
            <div style="font-size:0.75rem; color:#9CA3AF;">Attachment</div>
          </div>
          <a href="{{ att.get_download_url }}" target="_blank"
            style="width:32px; height:32px; border-radius:50%; border:1px solid #E5E7EB; display:flex; align-items:center; justify-content:center; color:#6B7280; text-decoration:none; transition:bg 0.2s;"
            onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='white'">
            <i class="fas fa-download" style="font-size:0.8rem;"></i>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Activity Section -->
    <div>
      <div class="activity-header">
        <div class="activity-heading">Activity</div>
        <!-- Pill Toggle -->
        <div class="pill-switcher">
          <button class="pill-btn active" onclick="switchTab('comments')">Comments</button>
          <button class="pill-btn" onclick="switchTab('history')">History</button>
        </div>
      </div>

      <!-- Tab: Comments -->
      <div id="view-comments" class="tab-content active">
        <!-- Input -->
        <div class="editor-wrapper">
          <div class="avatar-circle">
            {{ request.user.first_name.0 }}{{ request.user.last_name.0 }}
          </div>
          <form class="editor-card" action="{% url 'todo:add_task_comment' task.id %}" method="POST"
            onsubmit="handleCommentSubmit(event)">
            {% csrf_token %}
            <textarea name="content" class="editor-textarea" placeholder="Write a comment..." required></textarea>
            <div class="editor-footer">
              <div class="editor-tools">
                <i class="fa fa-paperclip" style="cursor: pointer;" title="Attach file (Coming soon)"></i>
                <i class="far fa-smile" style="cursor: pointer;"></i>
                <i class="fa fa-at" style="cursor: pointer;"></i>
              </div>
              <button type="submit" class="btn-primary">Send</button>
            </div>
          </form>
        </div>

        <!-- Stream -->
        <div class="comment-list">
          {% for comment in comments %}
          <div class="comment-row">
            <div class="avatar-circle" style="width:32px; height:32px; font-size:0.8rem;">
              {{ comment.author.user.first_name.0 }}{{ comment.author.user.last_name.0 }}
            </div>
            <div>
              <div class="comment-header">
                <span class="user-name">{{ comment.author.user.get_full_name }}</span>
                <span class="time-text">{{ comment.created_at|timesince }} ago</span>
              </div>
              <div class="comment-content">
                {{ comment.content }}
              </div>
              <div style="margin-top:0.25rem; font-size:0.75rem; color:var(--text-secondary); font-weight:500;">
                <span style="cursor:pointer; margin-right:0.5rem;" class="hover-underline">Reply</span>
                <span style="cursor:pointer;" class="hover-underline">Like</span>
              </div>
            </div>
          </div>
          {% empty %}
          <div style="text-align:center; padding:2rem; color:#9CA3AF;">No comments yet.</div>
          {% endfor %}
        </div>
      </div>

      <!-- Tab: History -->
      <div id="view-history" class="tab-content">
        <div class="comment-list">
          {% for activity in activities %}
          <div class="comment-row">
            <div class="avatar-circle"
              style="width:32px; height:32px; font-size:0.8rem; background:#F3F4F6; color:#6B7280;">
              <i class="fa fa-history"></i>
            </div>
            <div>
              <div class="comment-header">
                <span class="user-name">{{ activity.user.user.get_full_name|default:"System" }}</span>
                <span class="time-text">{{ activity.created_at|timesince }} ago</span>
              </div>
              <div style="font-size:0.9rem; color:#374151;">
                {{ activity.get_activity_type_display }}
                {% if activity.old_value or activity.new_value %}
                <div
                  style="margin-top:0.25rem; font-family:monospace; font-size:0.8rem; background:#F9FAFB; padding:0.25rem 0.5rem; border-radius:4px;">
                  <span style="color:#EF4444; text-decoration:line-through;">{{ activity.old_value|default:"-" }}</span>
                  <i class="fa fa-arrow-right" style="margin:0 0.25rem; color:#9CA3AF;"></i>
                  <span style="color:#10B981;">{{ activity.new_value|default:"-" }}</span>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% empty %}
          <div style="text-align:center; padding:2rem; color:#9CA3AF;">No history recorded.</div>
          {% endfor %}
        </div>
      </div>

    </div>
  </div>

  <!-- Sidebar Column -->
  <div class="sidebar-column">

    <div class="sidebar-widget">
      <!-- Status (Clickable) -->
      <div class="form-group">
        <label class="form-label">Status</label>
        <div class="select-box" onclick="toggleModal('statusModal')">
          <div style="display:flex; align-items:center;">
            {% if task.status == 'done' %}
            <span class="status-dot" style="background:#10B981;"></span> Done
            {% elif task.status == 'review' %}
            <span class="status-dot" style="background:#F59E0B;"></span> Review
            {% elif task.status == 'in_progress' %}
            <span class="status-dot" style="background:#3B82F6;"></span> In Progress
            {% else %}
            <span class="status-dot" style="background:#9CA3AF;"></span> To Do
            {% endif %}
          </div>
          <i class="fa fa-chevron-down" style="font-size:0.75rem; color:#9CA3AF;"></i>
        </div>
      </div>

      <!-- Priority (Static / Non-clickable visually) -->
      <div class="form-group">
        <label class="form-label">Priority</label>
        <div class="static-box">
          <i class="fa fa-flag" style="color:#EF4444; margin-right:0.5rem;"></i>
          {{ task.get_priority_display }}
        </div>
      </div>

      <!-- Assignees -->
      <div class="form-group">
        <label class="form-label">Assignees</label>
        <div class="facepile-row">
          <div class="facepile-group" style="flex-wrap: wrap;">
            {% if task.assignees.exists %}
            {% for u in task.assignees.all|slice:":4" %}
            <div class="facepile-img" title="{{ u.user.get_full_name }}"
              style="background:#E0E7FF; color:var(--brand-color); border-color:white;">
              {{ u.user.first_name.0 }}{{ u.user.last_name.0 }}
            </div>
            {% endfor %}
            {% if task.assignees.count > 4 %}
            <div class="facepile-img" title="{{ task.assignees.count|add:'-4' }} more"
              style="background:#F3F4F6; color:#6B7280; font-size:0.7rem;">
              +{{ task.assignees.count|add:"-4" }}
            </div>
            {% endif %}
            {% else %}
            <div class="facepile-img" title="{{ task.member.user.get_full_name }}"
              style="background:#E0E7FF; color:var(--brand-color); border-color:white;">
              {{ task.member.user.first_name.0 }}{{ task.member.user.last_name.0 }}
            </div>
            {% endif %}

            {% if task.created_by == request.user.member %}
            <div class="facepile-img" onclick="toggleModal('assignModal')"
              style="cursor:pointer; border:1px dashed #9CA3AF; background:white; margin-left: -5px;">
              <i class="fa fa-plus"></i>
            </div>
            {% endif %}
          </div>
        </div>
      </div>



      <!-- Due Date -->
      <div class="form-group">
        <label class="form-label">Due Date</label>
        <div class="static-box">
          <i class="far fa-calendar" style="color:#6B7280; margin-right:0.5rem;"></i>
          {{ task.due_date|date:"F j, Y" }}
        </div>
      </div>

      <!-- Reporter Divider -->
      <div class="reporter-row">
        <div class="avatar-circle" style="background:#1F2937; color:white; width:36px; height:36px; font-size:0.85rem;">
          {{ task.created_by.user.first_name.0 }}{{ task.created_by.user.last_name.0 }}
        </div>
        <div>
          <div style="font-size:0.9rem; font-weight:600;">{{ task.created_by.user.get_full_name }}</div>
          <div style="font-size:0.75rem; color:var(--text-secondary);">Reporter</div>
        </div>
      </div>

    </div>

  </div>

</div>

<!-- Modals -->
<div id="statusModal" class="modal-overlay" onclick="if(event.target===this) toggleModal('statusModal')">
  <div class="dropdown-menu">
    <button class="dropdown-item" onclick="updateStatus('todo')">To Do</button>
    <button class="dropdown-item" onclick="updateStatus('in_progress')">In Progress</button>
    <button class="dropdown-item" onclick="updateStatus('review')">Review</button>
    <button class="dropdown-item" onclick="updateStatus('done')">Done</button>
  </div>
</div>

<div id="assignModal" class="modal-overlay" onclick="if(event.target===this) toggleModal('assignModal')">
  <div class="dropdown-menu" style="width:250px;">
    {% for member in all_members %}
    <button class="dropdown-item" onclick="assignUser({{ member.id }})">
      {{ member.user.get_full_name }}
    </button>
    {% endfor %}
  </div>
</div>

<script>
  function switchTab(tab) {
    // Buttons
    document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
    // Panes
    document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));

    // Activate
    const btn = Array.from(document.querySelectorAll('.pill-btn')).find(b => b.textContent.toLowerCase().includes(tab));
    if (btn) btn.classList.add('active');

    document.getElementById('view-' + tab).classList.add('active');
  }

  function toggleModal(id) {
    document.getElementById(id).classList.toggle('active');
  }

  function updateStatus(status) {
    fetch('/todo/tasks/{{ task.id }}/complete_task', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest' },
      body: `status=${status}`
    }).then(() => location.reload());
    toggleModal('statusModal');
  }

  function assignUser(mid) {
    fetch('/todo/tasks/{{ task.id }}/update_ajax/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token }}' },
      body: `member_id=${mid}`
    }).then(() => location.reload());
    toggleModal('assignModal');
  }

  // --- Comment & Toast Logic (Unified) ---
  function showToast(message) {
    const toast = document.getElementById('toast-notification');
    const msg = document.getElementById('toast-message');
    msg.textContent = message;
    toast.style.display = 'flex';
    toast.style.animation = 'slideUp 0.3s ease-out';

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(10px)';
      toast.style.transition = 'all 0.3s';
      setTimeout(() => {
        toast.style.display = 'none';
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
      }, 300);
    }, 3000);
  }

  function handleCommentSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    const textarea = form.querySelector('textarea');

    // Loading State
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest', // Important for detecting AJAX
        'X-CSRFToken': '{{ csrf_token }}'
      }
    }).then(response => {
      if (response.ok) {
        return response.text(); // Assuming backend returns HTML fragment or we handle it manually
        // Note: If backend returns pure JSON, we might need to parse it. 
        // But 'add_task_comment' likely redirects or returns HTML fragment in "Team" style.
        // Let's check 'add_task_comment' view if this fails.
      }
      return response.text().then(text => { throw new Error(text) });
    }).then(htmlOrJson => {
      // Check if response is JSON (if backend was not updated to return HTML fragment)
      try {
        const data = JSON.parse(htmlOrJson);
        if (data.html) {
          htmlOrJson = data.html;
        } else if (data.success) {
          // Fallback if no HTML provided but success
          location.reload();
          return;
        }
      } catch (e) {
        // Not JSON, assume HTML fragment
      }

      // Success
      showToast('Comment sent');
      textarea.value = '';

      // Append new comment
      const list = document.querySelector('.comment-list');
      const emptyState = list.querySelector('div[style*="text-align:center"]');
      if (emptyState) emptyState.remove();

      // Insert after list start (prepend)
      const temp = document.createElement('div');
      temp.innerHTML = htmlOrJson;

      // If the response is a full page (redirect), we shouldn't insert it. 
      // Ideally the view returns a partial. 
      // For now, if we get a partial, insert it. If it looks like a full page (has <html>), reload.
      if (htmlOrJson.includes('<html') || htmlOrJson.includes('<!DOCTYPE')) {
        location.reload();
      } else {
        list.insertBefore(temp.firstElementChild, list.firstChild);
      }

      btn.disabled = false;
      btn.innerHTML = originalText;
    }).catch(error => {
      console.error('Error:', error);
      btn.disabled = false;
      btn.innerHTML = originalText;
      alert('Failed to send comment');
    });
  }
</script>

<div id="toast-notification"
  style="position:fixed; bottom:24px; right:24px; background:#10B981; color:white; padding:12px 24px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); display:none; align-items:center; gap:12px; z-index:9999; font-weight:500; font-size:0.95rem;">
  <i class="fas fa-check-circle"></i>
  <span id="toast-message">Action successful</span>
</div>

{% include 'todo/components/task_edit_modal.html' %}
{% endblock %}