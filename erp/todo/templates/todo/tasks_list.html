{% extends "base.html" %}
{% load static %}
{% load erp_tags %}
{% block css %}
<style>
  .tasks-page-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .page-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 0.5rem 0;
  }

  .page-header p {
    color: #64748b;
    font-size: 0.95rem;
    margin: 0;
  }

  /* Chrome-style Tabs */
  .tabs-container {
    display: flex;
    gap: 4px;
    border-bottom: 2px solid #e5e7eb;
    margin-bottom: 2rem;
    position: relative;
  }

  .tab {
    padding: 12px 24px;
    background: #f8f9fa;
    border: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    color: #64748b;
    transition: all 0.2s ease;
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .tab:hover {
    background: #f1f3f5;
    color: #475569;
  }

  .tab.active {
    background: white;
    color: #3b82f6;
    border-bottom: 2px solid #3b82f6;
    margin-bottom: -2px;
  }

  .tab .count-badge {
    background: #e5e7eb;
    color: #64748b;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .tab.active .count-badge {
    background: #dbeafe;
    color: #3b82f6;
  }

  /* Tab Content */
  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Tasks Grid */
  .tasks-grid {
    display: grid;
    gap: 0.75rem;
  }

  .task-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .task-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transform: translateY(-1px);
  }

  .task-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .task-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
    line-height: 1.3;
  }

  .task-actions {
    display: flex;
    gap: 0.375rem;
  }

  .btn-icon-task {
    width: 28px;
    height: 28px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
    color: #64748b;
    font-size: 0.75rem;
  }

  .btn-icon-task:hover {
    background: #f8f9fa;
    border-color: #cbd5e1;
    color: #1e293b;
  }

  .task-description {
    color: #64748b;
    font-size: 0.85rem;
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
  }

  .task-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #f1f5f9;
  }

  .task-meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    color: #64748b;
    font-size: 0.75rem;
  }

  .task-meta-item i {
    color: #94a3b8;
  }

  .task-due-date {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 2px 8px;
    background: #f1f5f9;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #475569;
  }

  .task-due-date.overdue {
    background: #fee2e2;
    color: #dc2626;
  }

  .task-due-date.today {
    background: #fef3c7;
    color: #d97706;
  }

  .task-assignee {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 2px 8px;
    background: #dbeafe;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #1e40af;
  }

  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: #94a3b8;
  }

  .empty-state i {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    color: #cbd5e1;
  }

  .empty-state h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #64748b;
    margin: 0 0 0.25rem 0;
  }

  .empty-state p {
    font-size: 0.85rem;
    margin: 0;
  }

  .task-related {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 2px 8px;
    background: #f0fdf4;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #15803d;
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .task-related:hover {
    background: #dcfce7;
  }
</style>
{% endblock %}

{% block content %}
<div class="tasks-page-container">
  <div class="page-header">
    <h1><i class="fa fa-check-square"></i> Tasks</h1>
    <p>Manage and track all your tasks in one place</p>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <button class="tab active" onclick="switchTab('myTasks')">
      <i class="fa fa-user"></i>
      My Tasks
      <span class="count-badge">{{ my_tasks.count }}</span>
    </button>
    <button class="tab" onclick="switchTab('assignedTasks')">
      <i class="fa fa-users"></i>
      Assigned Tasks
      <span class="count-badge">{{ assigned_tasks.count }}</span>
    </button>
  </div>

  <!-- My Tasks Tab Content -->
  <div id="myTasksContent" class="tab-content active">
    {% if my_tasks %}
    <div class="tasks-grid">
      {% for task in my_tasks %}
      <div class="task-card" id="task-{{ task.id }}"
        onclick="window.location.href='{% url 'todo:task_detail' task.id %}'">
        <div class="task-card-header">
          <h3 class="task-title">{{ task.name }}</h3>
          <div class="task-actions">
            <button type="button" class="btn-icon-task" title="Complete"
              onclick="event.stopPropagation(); completeTaskFromList({{ task.id }})">
              <i class="fa fa-check"></i>
            </button>
            <button type="button" class="btn-icon-task" title="Edit"
              onclick="event.stopPropagation(); editTaskFromList({{ task.id }}, '{{ task.name|escapejs }}', '{{ task.description|escapejs }}', '{{ task.due_date|date:"
              Y-m-d" }}')">
              <i class="fa fa-edit"></i>
            </button>
            <button type="button" class="btn-icon-task" title="Delete"
              onclick="event.stopPropagation(); deleteTaskFromList({{ task.id }})">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        </div>

        {% if task.description %}
        <p class="task-description">{{ task.description }}</p>
        {% endif %}

        <div class="task-meta">
          <span
            class="task-due-date {% if task.due_date < today %}overdue{% elif task.due_date == today %}today{% endif %}">
            <i class="fa fa-calendar"></i>
            {{ task.due_date|date:"M d, Y" }}
          </span>

          {% if task.contact %}
          <a href="{% url 'crm:contact_detail' task.contact.id %}" class="task-related"
            onclick="event.stopPropagation()">
            <i class="fa fa-user"></i>
            {{ task.contact.name }}
          </a>
          {% elif task.company %}
          <a href="{% url 'crm:company_detail' task.company.id %}" class="task-related"
            onclick="event.stopPropagation()">
            <i class="fa fa-building"></i>
            {{ task.company.name }}
          </a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <i class="fa fa-check-circle"></i>
      <h3>No tasks yet</h3>
      <p>You don't have any tasks assigned to you.</p>
    </div>
    {% endif %}
  </div>

  <!-- Assigned Tasks Tab Content -->
  <div id="assignedTasksContent" class="tab-content">
    {% if assigned_tasks %}
    <div class="tasks-grid">
      {% for task in assigned_tasks %}
      <div class="task-card" id="task-{{ task.id }}"
        onclick="window.location.href='{% url 'todo:task_detail' task.id %}'">
        <div class="task-card-header">
          <h3 class="task-title">{{ task.name }}</h3>
          <div class="task-actions">
            <button type="button" class="btn-icon-task" title="View"
              onclick="event.stopPropagation(); window.open('{% if task.contact %}{% url 'crm:contact_detail' task.contact.id %}{% elif task.company %}{% url 'crm:company_detail' task.company.id %}{% endif %}', '_blank')">
              <i class="fa fa-eye"></i>
            </button>
          </div>
        </div>

        {% if task.description %}
        <p class="task-description">{{ task.description }}</p>
        {% endif %}

        <div class="task-meta">
          <span
            class="task-due-date {% if task.due_date < today %}overdue{% elif task.due_date == today %}today{% endif %}">
            <i class="fa fa-calendar"></i>
            {{ task.due_date|date:"M d, Y" }}
          </span>

          {% if task.member %}
          <span class="task-assignee">
            <i class="fa fa-user"></i>
            {{ task.member.user.first_name }} {{ task.member.user.last_name }}
          </span>
          {% endif %}

          {% if task.contact %}
          <a href="{% url 'crm:contact_detail' task.contact.id %}" class="task-related"
            onclick="event.stopPropagation()">
            <i class="fa fa-user"></i>
            {{ task.contact.name }}
          </a>
          {% elif task.company %}
          <a href="{% url 'crm:company_detail' task.company.id %}" class="task-related"
            onclick="event.stopPropagation()">
            <i class="fa fa-building"></i>
            {{ task.company.name }}
          </a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
      <i class="fa fa-user-plus"></i>
      <h3>No assigned tasks</h3>
      <p>You haven't assigned any tasks to others yet.</p>
    </div>
    {% endif %}
  </div>
</div>

<script>
  function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('active');
    });

    // Show selected tab content
    if (tabName === 'myTasks') {
      document.getElementById('myTasksContent').classList.add('active');
      document.querySelectorAll('.tab')[0].classList.add('active');
    } else if (tabName === 'assignedTasks') {
      document.getElementById('assignedTasksContent').classList.add('active');
      document.querySelectorAll('.tab')[1].classList.add('active');
    }
  }

  function completeTaskFromList(taskId) {
    if (!confirm('Mark this task as complete?')) return;

    fetch(`/todo/tasks/${taskId}/complete_task`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
      .then(response => {
        if (response.ok) {
          const taskCard = document.getElementById(`task-${taskId}`);
          taskCard.style.transition = 'all 0.3s ease';
          taskCard.style.opacity = '0';
          taskCard.style.transform = 'scale(0.95)';
          setTimeout(() => taskCard.remove(), 300);
        } else {
          alert('Failed to complete task');
        }
      });
  }

  function deleteTaskFromList(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) return;

    fetch(`/todo/tasks/${taskId}/delete_task`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
      .then(response => {
        if (response.ok) {
          const taskCard = document.getElementById(`task-${taskId}`);
          taskCard.style.transition = 'all 0.3s ease';
          taskCard.style.opacity = '0';
          taskCard.style.transform = 'scale(0.95)';
          setTimeout(() => taskCard.remove(), 300);
        } else {
          alert('Failed to delete task');
        }
      });
  }

  function editTaskFromList(taskId, name, description, dueDate) {
    // Simple implementation - you can enhance this with a modal
    const newName = prompt('Task Name:', name);
    if (!newName) return;

    const newDesc = prompt('Description:', description);
    const newDate = prompt('Due Date (YYYY-MM-DD):', dueDate);

    if (!newDate) return;

    fetch(`/todo/tasks/${taskId}/update_ajax/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: `name=${encodeURIComponent(newName)}&description=${encodeURIComponent(newDesc)}&due_date=${newDate}`
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Failed to update task: ' + (data.error || 'Unknown error'));
        }
      });
  }
</script>
{% endblock %}